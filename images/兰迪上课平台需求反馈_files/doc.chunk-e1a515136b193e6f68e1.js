webpackJsonp([6],{1062:function(e,t,n){(function(e){function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function o(e){return e&&e.__esModule?e:{default:e}}function a(e){x.default.inc(),window.cow.authorized=e.authorized;var t=void 0;window.cow.currentFile=t=e,window.cow.currentDocGuid=t.guid,L.dispatch(T.default.receivedDocData(e)),C.default.doc.show("doc"),window.cow.docApp||(window.cow.docApp=d.default.render(l.default.createElement(N,{store:L},l.default.createElement(k.DocContainer,null)),O.docViewWrap[0])),document.title=t.name,b.default.notify("file:updateTitle",t.name),b.default.notify("page:docChanged")}function r(e,t){var n=[p.default.getDocByGuid(e,t),I.default.reset(e)];window.cow.authorized||n.pop(),Promise.all(n).then(function(e){a(e[0])}).catch(function(){p.default.getDocByGuid(e,t).then(function(e){a(e)}).failed(function(e){setTimeout(function(){location.href="/desktop",window.cow.loading=!1,x.default.done(),v.default.alert({title:e?e.message:"加载出错"})},0)})})}Object.defineProperty(t,"__esModule",{value:!0}),t.initDoc=r;var s=n(0),l=o(s),c=n(13),d=o(c),u=n(268),m=i(u),h=n(886),p=o(h),f=n(1524),g=n(5),v=o(g),y=n(9),b=o(y),w=n(702),C=o(w),E=n(579),x=o(E),k=n(1526),_=n(1534),T=o(_),S=n(433),I=o(S);n(48);var N=m.Provider,L=(0,f.Store)(),O={headerWrap:e("#header-wrap"),docTitleInput:e("#doc-title-input"),docViewWrap:e("#pad-view")}}).call(t,n(2))},1104:function(e,t,n){function i(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),l=n(0),c=i(l),d=n(1120),u=i(d),m=n(9),h=i(m),p=function(e){function t(){o(this,t);var e=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.state={activeIndex:-1,urlList:[]},e.onGalleryClosed=e.onGalleryClosed.bind(e),e.onIndexChanged=e.onIndexChanged.bind(e),e.exitImgPreview=e.exitImgPreview.bind(e),e}return r(t,e),s(t,null,[{key:"propTypes",get:function(){return{type:l.PropTypes.string}}}]),s(t,[{key:"componentDidMount",value:function(){this.bindBCEvent()}},{key:"componentWillUnmount",value:function(){h.default.detach("doc:goback",this.exitImgPreview),h.default.detach("spreadsheet:exit",this.exitImgPreview)}},{key:"bindBCEvent",value:function(){var e=this;h.default.attach("img:preview",function(t,n){if(cow.pageType===e.props.type){e.setState({activeIndex:t,urlList:n,show:!0})}}),h.default.attach("doc:goback",this.exitImgPreview),h.default.attach("spreadsheet:exit",this.exitImgPreview)}},{key:"exitImgPreview",value:function(){var e=[];this.setState({activeIndex:-1,urlList:e,show:!1})}},{key:"onGalleryClosed",value:function(){"doc"===cow.pageType?h.default.notify("body:removeOverflowHidden"):"spreadsheet"===cow.pageType&&window.tableInst.listen(),this.setState({show:!1,activeIndex:-1,urlList:[]})}},{key:"onIndexChanged",value:function(e){this.setState({activeIndex:e})}},{key:"render",value:function(){var e=this.state,t=e.activeIndex,n=e.urlList,i=e.show;return 0===n.length?null:c.default.createElement(u.default,{activeIndex:t,onClosed:this.onGalleryClosed,onIndexChanged:this.onIndexChanged,show:i,urlList:n})}}]),t}(l.Component);t.default=p,e.exports=t.default},1120:function(e,t,n){(function(i){function o(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var l=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),c=n(0),d=o(c),u=n(1121),m=o(u),h=n(1122),p=o(h),f=n(1123),g=o(f),v=n(20),y=o(v),b=n(1124),w=o(b),C=n(30),E=function(e){function t(e){a(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={imageOriginWidth:0,imageOriginHeight:0,imageCurrentWidth:0,imageCurrentHeight:0,imageScale:0,imageStyle:{},disableAction:!0},n.scaleSteps=[.1,.25,.33,.5,.65,.8,1,1.25,1.5,2,2.5,3,3.5,4],n.exitPreview=n.exitPreview.bind(n),n.onKeyup=n.onKeyup.bind(n),n.zoomIn=n.zoomIn.bind(n),n.zoomOut=n.zoomOut.bind(n),n.onImageLoaded=n.onImageLoaded.bind(n),n.onImageStartLoad=n.onImageStartLoad.bind(n),n.onViewerResize=n.onViewerResize.bind(n),n.pan=n.pan.bind(n),n.displayFixedExtent=n.displayFixedExtent.bind(n),n.displayOriginScale=n.displayOriginScale.bind(n),n}return s(t,e),l(t,null,[{key:"propTypes",get:function(){return{activeIndex:c.PropTypes.number,urlList:c.PropTypes.array,show:c.PropTypes.bool,onClosed:c.PropTypes.func.isRequired,onIndexChanged:c.PropTypes.func.isRequired}}}]),l(t,[{key:"componentDidMount",value:function(){document.addEventListener("keyup",this.onKeyup)}},{key:"componentWillUnmount",value:function(){document.removeEventListener("keyup",this.onKeyup)}},{key:"exitPreview",value:function(){this.props.onClosed()}},{key:"changeIndex",value:function(e){this.props.onIndexChanged(e)}},{key:"stopEvent",value:function(e){return e.stopPropagation(),e.preventDefault(),!1}},{key:"onImageStartLoad",value:function(){this.setState({disableAction:!0})}},{key:"onImageLoaded",value:function(e,t,n){var i=this,o=e.height,a=e.width,r=t.height,s=t.width,l=n.height-50,c=n.width;this.setState({imageCurrentWidth:s,imageCurrentHeight:r,imageOriginWidth:a,imageOriginHeight:o,viewerHeight:l,viewerWidth:c,disableAction:!1},function(){i.calcImageSize()})}},{key:"calcImageSize",value:function(){var e=this.state,t=e.imageOriginHeight,n=e.imageOriginWidth,i=e.viewerWidth,o=e.viewerHeight,a=this.state,r=a.imageCurrentWidth,s=a.imageCurrentHeight,l=n,c=t,d=c/t,u="0px",m=t/n;if(t>=o&&m<=1.8||n>=i){var h=.9*o/t,p=.9*i/n;d=h>p?p:h,l=n*d,c=t*d}c<=o&&(u=.5*(o-c)+"px");var f=.5*(i-l)+"px",g={position:"absolute",top:u,left:f,maxHeight:"none",maxWidth:"none",width:l,height:c,margin:0};r=l,s=c,this.fixedScale=d,this.fixedOffsetTop=u,this.fixedOffsetLeft=f,this.setState({imageCurrentWidth:r,imageCurrentHeight:s,imageOriginWidth:n,imageOriginHeight:t,imageStyle:g,imageScale:d})}},{key:"zoomIn",value:function(){this.resizeImage(this.getNextScale("zoomIn"))}},{key:"zoomOut",value:function(){this.resizeImage(this.getNextScale("zoomOut"))}},{key:"getNextScale",value:function(e){var t=this.state.imageScale,n=0,i=this.scaleSteps,o=i.length;for(n=0;n<o;n++){var a=i[n];if(t<=a){t="zoomIn"===e&&a-t<.1&&n<o-1?i[n+1]:"zoomOut"===e&&t-a<.1&&n>0?i[n-1]:a;break}}return t}},{key:"pan",value:function(e,t){var n=i.assign({},this.state.imageStyle),o=this.state,a=o.viewerHeight,r=o.viewerWidth;if(r=parseInt(r,10),a=parseInt(a,10),parseInt(n.width,10)>r){var s=this.getMinLeft();t=t>10?10:t,t=t<s?s:t}if(parseInt(n.height,10)>a){var l=this.getMinTop();e=e>10?10:e,e=e<l?l:e}n.top=e+"px",n.left=t+"px",this.setState({imageStyle:n})}},{key:"displayOriginScale",value:function(){this.resizeImage(1)}},{key:"displayFixedExtent",value:function(){var e=this;this.calcImageSize(),setTimeout(function(){e.resizeImage(e.fixedScale)},10)}},{key:"resizeImage",value:function(e){var t=this.state,n=t.imageOriginHeight,o=t.imageOriginWidth,a=t.imageCurrentWidth,r=t.imageCurrentHeight,s=t.imageStyle,l=t.viewerWidth,c=t.viewerHeight,d=s.top,u=s.left;d=parseInt(d,10),u=parseInt(u,10);var m=i.assign({},s),h=n*e,p=o*e;m.width=p,m.height=h;var f=.5*l,g=.5*c;d=h<c?.5*(c-h):g-(g-d)*h/r,u=p<l?.5*(l-p):f-(f-u)*p/a,m.top=d+"px",m.left=u+"px",this.setState({imageStyle:m,imageScale:e,imageCurrentHeight:h,imageCurrentWidth:p})}},{key:"onViewerResize",value:function(e){var t=this;this.setState({viewerWidth:e.width,viewerHeight:e.height},function(){t.calcImageSize()})}},{key:"getMinLeft",value:function(){var e=this.state.viewerWidth,t=this.state.imageStyle;return(e=parseInt(e,10))-parseInt(t.width,10)-10}},{key:"getMinTop",value:function(){var e=this.state.viewerHeight,t=this.state.imageStyle;return(e=parseInt(e,10))-parseInt(t.height,10)-10}},{key:"onKeyup",value:function(e){var t=this.props,n=t.activeIndex,i=t.urlList,o=t.show,a=this.state,r=a.viewerWidth,s=a.imageStyle;if(!o)return this.stopEvent(e);if(e.keyCode===C.keyCodes.DOWN&&n<i.length-1)this.changeIndex(n+1);else if(e.keyCode===C.keyCodes.UP&&n>0)this.changeIndex(n-1);else if(e.keyCode===C.keyCodes.ESC)this.exitPreview();else if(e.keyCode===C.keyCodes.LEFT||e.keyCode===C.keyCodes.RIGHT){var l="number"==typeof r&&r<parseInt(s.width,10),c=parseInt(s.left,10),d=parseInt(s.width,10),u=e.keyCode===C.keyCodes.LEFT?1:-1,m=c-.1*d*u;l&&this.pan(parseInt(s.top,10),m)}return this.stopEvent(e)}},{key:"render",value:function(){var e=this.props,t=e.activeIndex,n=e.show,i=e.urlList,o=e.onIndexChanged,a=this.state,r=a.imageStyle,s=a.imageScale,l=a.viewerHeight,c=a.viewerWidth,u=a.disableAction;if("boolean"==typeof n&&!n||!i&&0===i.length)return null;var h=t>-1&&t<i.length?i[t]:"",f=h.replace(/!thumbnail$/i,"!original"),v=(0,y.default)({modal:t>-1,"gallery-box":!0,"thumb-show":i.length>0}),b=this.scaleSteps,C=s!==b[b.length-1],E=s!==b[0],x=1!==s,k=this.fixedOffsetLeft!==r.left||this.fixedOffsetTop!==r.top||this.fixedScale!==s,_="number"==typeof l&&l<r.height,T="number"==typeof c&&c<r.width;return d.default.createElement("div",{className:v},d.default.createElement(g.default,{imageUrl:f,imageStyle:r||{},enableVerticalScroll:_,enableHorizontalScroll:T,pan:this.pan,onImageStartLoad:this.onImageStartLoad,onViewerResize:this.onViewerResize,onImageLoaded:this.onImageLoaded,exitPreview:this.exitPreview}),d.default.createElement(p.default,{activeIndex:t,urlList:i,onIndexChanged:o}),d.default.createElement(m.default,{zoomIn:this.zoomIn,zoomOut:this.zoomOut,disableAction:u,displayOriginScale:this.displayOriginScale,displayFixedExtent:this.displayFixedExtent,enableZoomIn:C,enableZoomOut:E,enableFixedExtent:k,enableOriginScale:x,activeIndex:t,totalCount:i.length,imageUrl:h}),d.default.createElement(w.default,{urlList:i}))}}]),t}(c.Component);t.default=E,e.exports=t.default}).call(t,n(1))},1121:function(e,t,n){function i(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),l=n(0),c=i(l),d=function(e){function t(e){o(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.handleZoomIn=n.handleZoomIn.bind(n),n.handleZoomOut=n.handleZoomOut.bind(n),n.handleDisplayOriginScale=n.handleDisplayOriginScale.bind(n),n.handleDisplayFixedExtent=n.handleDisplayFixedExtent.bind(n),n}return r(t,e),s(t,null,[{key:"propTypes",get:function(){return{activeIndex:l.PropTypes.number.isRequired,totalCount:l.PropTypes.number.isRequired,imageUrl:l.PropTypes.string.isRequired,zoomIn:l.PropTypes.func.isRequired,zoomOut:l.PropTypes.func.isRequired,displayOriginScale:l.PropTypes.func.isRequired,displayFixedExtent:l.PropTypes.func.isRequired,enableZoomIn:l.PropTypes.bool,enableZoomOut:l.PropTypes.bool,enableOriginScale:l.PropTypes.bool,enableFixedExtent:l.PropTypes.bool,disableAction:l.PropTypes.bool}}}]),s(t,[{key:"handleZoomIn",value:function(e){/ disable/.test(e.target.className)||this.props.zoomIn()}},{key:"handleZoomOut",value:function(e){/ disable/.test(e.target.className)||this.props.zoomOut()}},{key:"handleDisplayOriginScale",value:function(e){/ disable/.test(e.target.className)||this.props.displayOriginScale()}},{key:"handleDisplayFixedExtent",value:function(e){/ disable/.test(e.target.className)||this.props.displayFixedExtent()}},{key:"render",value:function(){var e=this.props,t=e.activeIndex,n=e.totalCount,i=e.imageUrl,o=e.disableAction,a=this.props,r=a.enableZoomIn,s=a.enableZoomOut,l=a.enableOriginScale,d=a.enableFixedExtent,u="gallery-action-item",m="gallery-toolbar-icons gallery-toolbar-",h=n>1?t+1+"/"+n:"";return c.default.createElement("div",{className:"gallery-details"},c.default.createElement("span",{className:"gallery-detail-text"},c.default.createElement("number",{className:"gallery-detail-number"},h)),c.default.createElement("div",{className:"gallery-action"},c.default.createElement("a",{className:u+(o||!r?" disable":""),href:"javascript:void(0)",onClick:this.handleZoomIn},c.default.createElement("i",{className:m+"zoom-in"}),c.default.createElement("span",{className:"tooltip s-tooltip top"},"放大")),c.default.createElement("a",{className:u+(o||!s?" disable":""),href:"javascript:void(0)",onClick:this.handleZoomOut},c.default.createElement("i",{className:m+"zoom-out"}),c.default.createElement("span",{className:"tooltip s-tooltip top"},"缩小")),c.default.createElement("a",{className:u+(o||!l?" disable":""),href:"javascript:void(0)",onClick:this.handleDisplayOriginScale},c.default.createElement("i",{className:m+"origin-scale"}),c.default.createElement("span",{className:"tooltip s-tooltip top"},"实际大小")),c.default.createElement("a",{className:u+(o||!d?" disable":""),href:"javascript:void(0)",onClick:this.handleDisplayFixedExtent},c.default.createElement("i",{className:m+"fixed-extent"}),c.default.createElement("span",{className:"tooltip s-tooltip top"},"适应页面")),c.default.createElement("a",{className:u,href:"/download/image?url="+i,target:"_blank",title:"下载图片"},c.default.createElement("i",{className:m+"link-download"}),c.default.createElement("span",{className:"tooltip s-tooltip top"},"下载原图"))))}}]),t}(l.Component);t.default=d,e.exports=t.default},1122:function(e,t,n){function i(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),l=n(0),c=i(l),d=n(20),u=i(d),m=function(e){function t(e){o(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.renderListItem=n.renderListItem.bind(n),n}return r(t,e),s(t,null,[{key:"propTypes",get:function(){return{urlList:l.PropTypes.array.isRequired,activeIndex:l.PropTypes.number.isRequired,onIndexChanged:l.PropTypes.func.isRequired}}}]),s(t,[{key:"componentDidMount",value:function(){this.adjustActivedThumbnailPosition()}},{key:"shouldComponentUpdate",value:function(e){var t=this.props;return e.urlList.length!==t.urlList.length||(e.activeIndex!==t.activeIndex||e.urlList.some(function(e,n){return t.urlList[n]!==e}))}},{key:"componentDidUpdate",value:function(){this.adjustActivedThumbnailPosition()}},{key:"adjustActivedThumbnailPosition",value:function(){var e=this.refs.galleryList,t=this.refs["thumbnail"+this.props.activeIndex];if(e&&t){var n=t.getBoundingClientRect(),i=e.getBoundingClientRect(),o=n.bottom-i.bottom,a=i.top-n.top;o>=0?e.scrollTop=e.scrollTop+o+.67*i.height:a>=0&&(e.scrollTop=e.scrollTop-a)}}},{key:"onListItemClick",value:function(e,t){var n=this.props,i=n.activeIndex,o=n.onIndexChanged;if(i===e)return void t.stopPropagation();o(e)}},{key:"renderListItem",value:function(e,t){var n=this.props.activeIndex,i={"gallery-list-item":!0,thumb:!0,active:n===t};return c.default.createElement("p",{className:(0,u.default)(i),onClick:this.onListItemClick.bind(this,t),ref:"thumbnail"+t,key:t},c.default.createElement("img",{className:"gallery-list-img",src:e}))}},{key:"render",value:function(){var e=this.props.urlList;return c.default.createElement("div",{className:"gallery-list",ref:"galleryList"},e.map(this.renderListItem))}}]),t}(l.Component);t.default=m,e.exports=t.default},1123:function(e,t,n){(function(i){function o(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var l=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),c=n(0),d=o(c),u=n(923),m=o(u),h=function(e){function t(e){a(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={isLoading:!0},n.downTimer=-1,n.isMoving=!1,n.isMouseDown=!1,n.onViewerClick=n.onViewerClick.bind(n),n.onLoad=n.onLoad.bind(n),n.onWindowResize=n.onWindowResize.bind(n),n.onMouseDown=n.onMouseDown.bind(n),n.onMouseMove=n.onMouseMove.bind(n),n.onMouseUp=n.onMouseUp.bind(n),n.onWheel=n.onWheel.bind(n),n.onMouseOut=n.onMouseOut.bind(n),n}return s(t,e),l(t,null,[{key:"propTypes",get:function(){return{imageUrl:c.PropTypes.string.isRequired,exitPreview:c.PropTypes.func,onImageLoaded:c.PropTypes.func,imageStyle:c.PropTypes.object,onViewerResize:c.PropTypes.func,pan:c.PropTypes.func,enableVerticalScroll:c.PropTypes.bool,enableHorizontalScroll:c.PropTypes.bool}}}]),l(t,[{key:"componentDidMount",value:function(){window.addEventListener("resize",this.onWindowResize)}},{key:"componentWillReceiveProps",value:function(e){e.imageUrl!==this.props.imageUrl&&this.setState({isLoading:!0})}},{key:"componentWillUnmount",value:function(){window.removeEventListener("resize",this.onWindowResize)}},{key:"onWindowResize",value:function(){var e={width:this.refs.viewerWrapper.offsetWidth,height:this.refs.viewerWrapper.offsetHeight-50};this.viewerSize=e,this.props.onViewerResize(e)}},{key:"onLoad",value:function(e){var t=this,n=e.target,i={width:n.naturalWidth,height:n.naturalHeight},o={width:n.width,height:n.height},a={width:this.refs.viewerWrapper.offsetWidth,height:this.refs.viewerWrapper.offsetHeight};this.viewerSize=a,this.setState({isLoading:!1},function(){t.props.onImageLoaded(i,o,a)})}},{key:"onViewerClick",value:function(){var e=this.props.exitPreview;this.isMoving?this.isMoving=!1:this.wasOuted?this.wasOuted=!1:"function"==typeof e&&e(),this.downTimer>-1&&(clearTimeout(this.downTimer),this.downTimer=-1)}},{key:"onMouseDown",value:function(e){var t=this;this.isMouseDown=!0,this.lastMousePosition={x:e.clientX,y:e.clientY},this.downTimer>-1&&clearTimeout(this.downTimer),this.downTimer=setTimeout(function(){t.isMoving=!0,console.log(t.isMoving)},200)}},{key:"onMouseMove",value:function(e){if(this.isMouseDown){this.downTimer>-1&&(this.isMoving=!0,clearTimeout(this.downTimer),this.downTimer=-1);var t=this.props,n=t.enableVerticalScroll,o=t.enableHorizontalScroll,a=i.assign({},this.props.imageStyle),r=a.top,s=a.left;s=parseInt(s,10),o&&(s+=e.clientX-this.lastMousePosition.x),r=parseInt(r,10),n&&(r+=e.clientY-this.lastMousePosition.y),this.lastMousePosition={x:e.clientX,y:e.clientY},this.props.pan(r,s)}}},{key:"onMouseOut",value:function(){this.isMoving&&(this.isMoving=!1,this.isMouseDown=!1,this.wasOuted=!0),this.downTimer>-1&&(clearTimeout(this.downTimer),this.downTimer=-1)}},{key:"onMouseUp",value:function(){this.isMouseDown=!1}},{key:"onWheel",value:function(e){var t=i.assign({},this.props.imageStyle),n=this.props,o=n.enableVerticalScroll,a=n.enableHorizontalScroll,r=t.top,s=t.left;r=parseInt(r,10),s=parseInt(s,10),a&&(s-=e.deltaX),o&&(r-=e.deltaY),(a||o)&&this.props.pan(r,s),e.preventDefault(),e.stopPropagation()}},{key:"render",value:function(){var e=this.props,t=e.imageUrl,n=e.imageStyle,o=i.assign({},n);return this.state.isLoading&&(o=i.assign(o,{opacity:"0",width:"0px",height:"0px"})),d.default.createElement("div",{className:"gallery-img-box sheet-gallery-img-box",ref:"viewerWrapper",onWheel:this.onWheel,onMouseMove:this.onMouseMove,onMouseOut:this.onMouseOut,onClick:this.onViewerClick},d.default.createElement(m.default,{show:this.state.isLoading}),d.default.createElement("img",{src:t,className:"gallery-img sheet-gallery-img",style:o||{},draggable:!1,onMouseDown:this.onMouseDown,onMouseUp:this.onMouseUp,onLoad:this.onLoad}),d.default.createElement("a",{className:"hidden-link",href:"javascript:void(0)"}))}}]),t}(c.Component);t.default=h,e.exports=t.default}).call(t,n(1))},1124:function(e,t,n){function i(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),l=n(0),c=i(l),d=function(e){function t(){return o(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),s(t,[{key:"renderImageObjecList",value:function(){return this.props.urlList.map(function(e,t){var n=e.replace(/!thumbnail$/i,"!original");return c.default.createElement("li",{key:t},c.default.createElement("img",{src:n}))})}},{key:"render",value:function(){var e={position:"fixed",overflow:"hidden",width:"0px",height:"0px",pointerEvents:"none",opacity:0,top:"-1000px",left:"-1000px"};return c.default.createElement("ul",{className:"image-gallery-pre-loader",style:e},this.renderImageObjecList())}}],[{key:"propTypes",get:function(){return{urlList:l.PropTypes.array}}}]),t}(l.Component);t.default=d,e.exports=t.default},1454:function(e,t){function n(e){return!(e&&e.replace("<br>",""))}function i(e){return e&&!!e.replace(/<\/?[^>]*>/gim,"").replace(/&nbsp;|\s/g,"").length}e.exports={isEmpty:n,hasContent:i}},1524:function(e,t,n){function i(e){return e&&e.__esModule?e:{default:e}}function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function a(e){return g(f,e)}Object.defineProperty(t,"__esModule",{value:!0}),t.Store=void 0;var r=n(151),s=o(r),l=n(437),c=i(l),d=n(1525),u=i(d),m=s.createStore,h=s.applyMiddleware,p=null,f=s.combineReducers({msg:u.default}),g=h(c.default)(m);t.Store=function(){return p||(p=a()),p}},1525:function(e,t,n){(function(n){function i(e,t){switch(e=e||o,t.type){case"RECEIVED_DOC_DATA":return r(e,t.docData)}return e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=i;var o={docData:{}},a=function(e,t){return n.assign({},e,t)},r=function(e,t){return a(e,{docData:t})};e.exports=t.default}).call(t,n(1))},1526:function(e,t,n){(function(t){function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function o(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function l(e){return e}function c(e){return{dispatch:e}}function d(e,n,i){return t.assign({},i,e,n)}var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),m=n(0),h=o(m),p=n(268),f=i(p),g=n(9),v=o(g),y=n(702),b=o(y),w=n(255),C=o(w),E=n(544),x=o(E),k=n(1527),_=o(k),T=n(5),S=o(T),I=n(1530),N=o(I),L=n(1104),O=o(L);(0,x.default)();var P=f.connect,D=function(e){function t(){return a(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,e),u(t,[{key:"componentDidMount",value:function(){var e=this;v.default.attach("file:updateTitle",function(t){e.refs.docTitle.value=t,e.refs.docTitle.setAttribute("data-value",t)}),this._initPad()}},{key:"shouldComponentUpdate",value:function(e){var t=e.msg.docData;return"doc"===window.cow.pageType&&t&&t.guid===window.cow.currentDocGuid}},{key:"componentDidUpdate",value:function(){this._initPad()}},{key:"_onTitleChange",value:function(){}},{key:"_initPad",value:function(){n.e(36).then(function(e){var t=n(841),i=n(1532),o=n(549);n(322),window.pad=t.pad,window.pad.initialized||t.init(),i.getInstance("#sidebar").reset(),o.getInstance(".sidebar-body").commentInit(),C.default.reset(),b.default.setDocInit(!0),v.default.notify("pad:render_content",b.default)}.bind(null,n)).catch(n.oe)}},{key:"render",value:function(){var e=window.cow.currentDocGuid,t=!S.default.isMobile(),n="";t&&(n="pad-view-pc");var i=void 0;return i=""===cow.welcomeFile?"欢迎使用石墨文档"===cow.currentFile.name:cow.currentFile.guid===cow.welcomeFile,h.default.createElement("div",{id:"pad-view-inner",className:"pad-view-inner "+n},h.default.createElement(O.default,{type:"doc"}),h.default.createElement("div",{id:"edit-heading",className:"edit-heading"},h.default.createElement("div",{className:"h-container edit-heading-container"},h.default.createElement("div",{id:"editbar",className:"toolbar visible editbar doc-editbar"},h.default.createElement("ul",{className:"menu_left editbar-list"},h.default.createElement("li",{id:"undo",className:"undo-redo editbar-list-item","data-type":"button","data-key":"undo"},h.default.createElement("a",{className:"toolbar-item grouped-left","data-content":"撤销 (Ctrl+Z)"},h.default.createElement("span",{className:"new-icon new-icon-go-ahead"}))),h.default.createElement("li",{className:"undo-redo editbar-list-item","data-type":"button","data-key":"redo"},h.default.createElement("a",{className:"toolbar-item grouped-left","data-content":"重做 (Ctrl+Y)"},h.default.createElement("span",{className:"new-icon new-icon-retreat"}))),h.default.createElement("li",{id:"paint-format",className:"editbar-list-item","data-type":"button","data-key":"paint-format"},h.default.createElement("a",{href:"javascript:void(0);",className:"toolbar-item grouped-left","data-content":"格式刷"},h.default.createElement("span",{className:"new-icon new-icon-paint-format"}))),h.default.createElement("li",{id:"clear-format",className:"editbar-list-item","data-type":"button","data-key":"clear-format"},h.default.createElement("a",{href:"javascript:;",className:"toolbar-item grouped-left","data-content":"清除格式"},h.default.createElement("span",{className:"new-icon new-icon-clear-format"}))),h.default.createElement("li",{className:"separator editbar-list-item"}),h.default.createElement("li",{id:"heading",className:"dropdown-item editbar-dropdown-item editbar-list-item"},h.default.createElement("a",{href:"javascript:;",className:"toolbar-item font-type-item","data-content":"标题 (Ctrl+Shift+K)"},h.default.createElement("span",{className:"toolbar-icon font-type-toolbar-icon"},h.default.createElement("span",{className:"type-txt"},"普通"),h.default.createElement("span",{className:"new-icon new-icon-down font-icon-down toolbar-icon-down"}))),h.default.createElement("div",{className:"toolbar-menu font-type-menu"},h.default.createElement("ul",{id:"heading-selection",className:"toolbar-menu-list heading-menu-list"},h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"font-type-item menu-item"},h.default.createElement("span",{"data-value":"-1"},"普通"))),h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"font-type-item menu-item"},h.default.createElement("span",{"data-value":"1"},"小标题"))),h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"font-type-item menu-item"},h.default.createElement("span",{"data-value":"2"},"中标题"))),h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"font-type-item menu-item"},h.default.createElement("span",{"data-value":"3"},"大标题")))))),h.default.createElement("li",{id:"font-size",className:"dropdown-item editbar-dropdown-item editbar-list-item"},h.default.createElement("a",{href:"javascript:;",className:"toolbar-item font-size-toolbar","data-content":"字号 (Ctrl+Shift+↑/↓)"},h.default.createElement("span",{className:"toolbar-icon"},h.default.createElement("span",{className:"size-txt"},"14"),h.default.createElement("span",{className:"new-icon new-icon-down font-icon-down toolbar-icon-down"}))),h.default.createElement("div",{className:"toolbar-menu font-size-menu"},h.default.createElement("ul",{id:"size-list",className:"toolbar-menu-list"}))),h.default.createElement("li",{className:"editbar-list-item","data-type":"button","data-key":"bold"},h.default.createElement("a",{className:"grouped-left toolbar-item",href:"javascript:void(0);","data-content":"粗体 (Ctrl+B)"},h.default.createElement("span",{className:"new-icon new-icon-bold","data-l10n-id":"pad.toolbar.bold.title"}))),h.default.createElement("li",{className:"editbar-list-item","data-type":"button","data-key":"italic"},h.default.createElement("a",{className:"grouped-left toolbar-item",href:"javascript:void(0);","data-content":"斜体 (Ctrl+I)"},h.default.createElement("span",{className:"new-icon new-icon-italic","data-l10n-id":"pad.toolbar.italic.title"}))),h.default.createElement("li",{className:"editbar-list-item","data-type":"button","data-key":"underline"},h.default.createElement("a",{className:"grouped-left toolbar-item",href:"javascript:void(0);","data-content":"下划线 (Ctrl+U)"},h.default.createElement("span",{className:"new-icon new-icon-underline","data-l10n-id":"pad.toolbar.underline.title"}))),h.default.createElement("li",{className:"editbar-list-item","data-type":"button","data-key":"strikethrough"},h.default.createElement("a",{className:"grouped-left toolbar-item",href:"javascript:void(0);","data-content":"中划线"},h.default.createElement("span",{className:"new-icon new-icon-strikethrough","data-l10n-id":"pad.toolbar.strikethrough.title"}))),h.default.createElement("li",{className:"editbar-list-item editbar-dropdown-item dropdown-item font-color","data-type":"button","data-key":"fontcolor"},h.default.createElement("a",{className:"toolbar-item",href:"javascript:void(0);","data-content":"字体颜色"},h.default.createElement("span",{className:"new-icon new-icon-font-color"},h.default.createElement("span",{className:"new-icon new-icon-down font-color-icon-down"}),h.default.createElement("span",{className:"icon-font-color-bottom"}))),h.default.createElement("div",{className:"toolbar-menu font-color-menu"},h.default.createElement("ul",{id:"color-list",className:"toolbar-menu-list font-color-list"}))),h.default.createElement("li",{className:"separator editbar-list-item"}),h.default.createElement("li",{className:"editbar-list-item","data-type":"button","data-key":"insertorderedlist"},h.default.createElement("a",{className:"grouped-left toolbar-item",href:"javascript:void(0);","data-content":"有序列表 (Ctrl+Shift+U)"},h.default.createElement("span",{className:"new-icon new-icon-ul-list","data-l10n-id":"pad.toolbar.ol.title"}))),h.default.createElement("li",{className:"editbar-list-item","data-type":"button","data-key":"insertunorderedlist"},h.default.createElement("a",{className:"grouped-left toolbar-item",href:"javascript:void(0);","data-content":"无序列表 (Ctrl+Shift+I)"},h.default.createElement("span",{className:" new-icon new-icon-ol-list","data-l10n-id":"pad.toolbar.ul.title"}))),h.default.createElement("li",{className:"editbar-list-item","data-type":"button","data-key":"checklist"},h.default.createElement("a",{className:"grouped-left toolbar-item",href:"javascript:void(0);","data-content":"任务列表 (Ctrl+Shift+Y)"},h.default.createElement("span",{className:"new-icon new-icon-check-list"}))),h.default.createElement("li",{className:"editbar-list-item","data-type":"button","data-key":"indent"},h.default.createElement("a",{className:"grouped-left toolbar-item",href:"javascript:void(0);","data-content":"增加缩进 (TAB)"},h.default.createElement("span",{className:" new-icon new-icon-indent","data-l10n-id":"pad.toolbar.indent.title"}))),h.default.createElement("li",{className:"editbar-list-item","data-type":"button","data-key":"outdent"},h.default.createElement("a",{className:"grouped-right toolbar-item",href:"javascript:void(0);","data-content":"减少缩进 (Shift+TAB)"},h.default.createElement("span",{className:" new-icon new-icon-outdent","data-l10n-id":"pad.toolbar.unindent.title"}))),h.default.createElement("li",{className:"editbar-list-item editbar-dropdown-item dropdown-item",id:"align-toolbar-btn"},h.default.createElement("a",{href:"javascript:;",className:"toolbar-item","data-content":"对齐"},h.default.createElement("span",{className:"toolbar-icon new-icon new-icon-align-left icon-align-arrow"}),h.default.createElement("span",{className:"new-icon new-icon-down toolbar-icon-down align-icon-down"})),h.default.createElement("div",{className:"toolbar-menu align-toolbar-menu"},h.default.createElement("ul",{className:"toolbar-menu-list"},h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"menu-item align-toolbar-item","data-index":"0","data-content":"左对齐"},h.default.createElement("span",{className:"new-icon new-icon-align-left align-item-icon"}))),h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"menu-item align-toolbar-item","data-index":"1","data-content":"居中对齐"},h.default.createElement("span",{className:"new-icon new-icon-align-center align-item-icon"}))),h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"menu-item align-toolbar-item","data-index":"2","data-content":"右对齐"},h.default.createElement("span",{className:"new-icon new-icon-align-right align-item-icon"}))),h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"menu-item align-toolbar-item","data-index":"3","data-content":"两端对齐"},h.default.createElement("span",{className:"new-icon new-icon-align-justify align-item-icon"})))))),h.default.createElement("li",{className:"separator editbar-list-item"}),h.default.createElement("li",{id:"doc-insert",className:"dropdown-item editbar-dropdown-item editbar-list-item"},h.default.createElement("a",{href:"javascript:;",className:"toolbar-item"},h.default.createElement("span",{className:"toolbar-icon font-type-toolbar-icon"},h.default.createElement("span",{className:"doc-insert-txt"},"插入"),h.default.createElement("span",{className:"new-icon new-icon-down font-icon-down toolbar-icon-down"}))),h.default.createElement("div",{className:"toolbar-menu doc-insert-menu"},h.default.createElement("ul",{id:"doc-insert-selection",className:"toolbar-menu-list doc-insert-menu-list"},h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"menu-item",id:"image-upload-button"},h.default.createElement("span",{className:"new-icon new-icon-img"}),h.default.createElement("span",{className:"doc-insert-info"},"图片"))),h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"menu-item",id:"insert-table-btn"},h.default.createElement("span",{className:"new-icon new-icon-table"}),h.default.createElement("span",{className:"doc-insert-info"},"表格"))),h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"menu-item",id:"link-btn"},h.default.createElement("span",{className:"toolbar-icon new-icon new-icon-link"}),h.default.createElement("span",{className:"doc-insert-info"},"超链接"))),h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"menu-item",id:"horizontal-line"},h.default.createElement("span",{className:"toolbar-icon new-icon new-icon-horizontal-line"}),h.default.createElement("span",{className:"doc-insert-info"},"分隔线"))),h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"menu-item",id:"upload-attachment"},h.default.createElement("span",{className:"toolbar-icon new-icon new-icon-attachment"}),h.default.createElement("span",{className:"doc-insert-info"},"附件"))),h.default.createElement("li",null,h.default.createElement("a",{href:"javascript:;",className:"menu-item",id:"code-area-btn","data-content":"```+空格"},h.default.createElement("span",{className:"toolbar-icon new-icon new-icon-code-area"}),h.default.createElement("span",{className:"doc-insert-info"},"代码块")))))),h.default.createElement("li",{className:"separator editbar-list-item"}),h.default.createElement("li",{className:"editbar-list-item",id:"select-comment"},h.default.createElement("a",{href:"javascript:void(0);",className:"toolbar-item","data-content":"评论 (Ctrl+Shift+P)"},h.default.createElement("span",{className:"toolbar-icon new-icon new-icon-comment-add"}))))))),h.default.createElement("div",{id:"doc-view",className:"doc-view"},h.default.createElement("div",{className:"outer-container"},h.default.createElement("div",{className:"content-container"},h.default.createElement("div",{className:"container commentable doc-container",id:"doc-container"},h.default.createElement("div",{id:"editorcontainerbox"},h.default.createElement("div",{id:"editorcontainer",className:"pc editorcontainer"},h.default.createElement("div",{className:"doc-title-box"},h.default.createElement("input",{id:"doc-title-input",className:"mousetrap",defaultValue:"无标题",placeholder:"无标题","data-value":"未命名",maxLength:"100",ref:"docTitle"})),h.default.createElement("div",{id:"outerdocbody"},h.default.createElement("div",{id:"innerdocbody",spellCheck:"false",className:"syntax needsclick innerdocbody mousetrap",autoCorrect:"off",autoComplete:"off"}),h.default.createElement("div",{id:"mention-pop",className:"doc-mention-pop"},h.default.createElement("div",{className:"trangle-box"},h.default.createElement("span",{className:"top doc-metion-trangle-item"}),h.default.createElement("span",{className:"down doc-metion-trangle-item"})),h.default.createElement("ul",{className:"doc-mention-list"},h.default.createElement("li",{className:"doc-mention-placeholder doc-mention-item"},"@朋友或者文档")),h.default.createElement("ul",{className:"result-list doc-mention-list doc-mention-result-list"})),h.default.createElement("span",{id:"mention-width"}),h.default.createElement("div",{id:"track-avatars"}),h.default.createElement("div",{id:"drag-li",tabIndex:"-1"})),h.default.createElement("div",{id:"buddle-box"}),h.default.createElement("div",{id:"buddle-comment-btn",className:"hicon icon-comment-add buddle-comment-btn"}),h.default.createElement("div",{id:"image-resize-frame"}),h.default.createElement("div",{className:"image-resize-bar"}),h.default.createElement("div",{className:"copy-container",contentEditable:"true"}))),h.default.createElement("div",{id:"overlaysdiv"})),h.default.createElement("div",{id:"sidebar",className:"sidebar"},h.default.createElement("div",{className:"sidebar-body"},h.default.createElement("div",{className:"list-mask"}),h.default.createElement("div",{id:"doc-history",className:"document-info-list hide"},h.default.createElement("div",{className:"doc-history-title"},h.default.createElement("span",{className:"content"},"历史"),h.default.createElement("span",{className:"icon-close hicon doc-sidebar-close"})),h.default.createElement("ul",{className:"history-list"})),h.default.createElement("ul",{className:"temp-list"},h.default.createElement("div",{className:"close-temp hicon icon-close"}),h.default.createElement("div",{className:"no-target"},"标注已被删除"),h.default.createElement("div",{className:"trangle-box temp-list-trangle"},h.default.createElement("span",{className:"left temp-list-trangle-item"}),h.default.createElement("span",{className:"right temp-list-trangle-item"}))),h.default.createElement("div",{id:"document-cover-box"},h.default.createElement("div",{className:"document-cover top"}),h.default.createElement("div",{className:"document-cover bottom"}),h.default.createElement("div",{className:"document-cover right"})),h.default.createElement("div",{id:"doc-directory",className:"doc-directory hide"},h.default.createElement("div",{className:"doc-directory-title"},h.default.createElement("span",{className:"icon-close hicon doc-sidebar-close"}),"目录"),h.default.createElement("ul",{className:"doc-directory-list"})))))),!S.default.isMobile()&&h.default.createElement(_.default,{guid:e}),h.default.createElement("div",{id:"text-count",className:"text-count hide"},h.default.createElement("span",{className:"text-count-number"}),"个字"),h.default.createElement("div",{id:"footer",className:"editable-footer"},!(window.cow.currentFile.team&&window.cow.currentFile.team.resources)&&h.default.createElement("span",{className:"copy footer-copy"},"文档编写于",h.default.createElement("a",{href:"/"},"石墨")))),h.default.createElement("input",{id:"focus-target"}),h.default.createElement("div",{className:"mention-pop",id:"comment-mention-pop"}),i&&h.default.createElement(N.default,{ref:"tutorial"}))}}]),t}(m.Component),M=P(l,c,d,{withRef:!0})(D);e.exports={Doc:D,DocContainer:M}}).call(t,n(1))},1527:function(e,t,n){(function(i,o){function a(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var c=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),d=n(0),u=a(d),m=n(13),h=a(m),p=n(1528),f=a(p),g=n(22),v=n(9),y=a(v),b=n(33),w=a(b),C=n(5),E=a(C),x=n(1454),k=a(x),_=n(854),T=function(e){function t(){r(this,t);var e=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.state={comments:[],dirtyCheck:1,activeGuid:"",mainGuid:"",user:window.cow.currentUser,newSelectionGuid:[],curInput:"",fileGuid:window.cow.currentFile.guid},e.changeInputValue=e.changeInputValue.bind(e),e._resetActive=e._resetActive.bind(e),e.pushComment=e.pushComment.bind(e),e.deleteComment=e.deleteComment.bind(e),e.closeComments=e.closeComments.bind(e),e}return l(t,e),c(t,null,[{key:"propTypes",get:function(){return{guid:d.PropTypes.string}}}]),c(t,[{key:"componentDidMount",value:function(){(window.cow.currentFile.permissions||{}).commentable&&this._queryComments(this.props.guid),this._bindPush(),this._bindEvent(),this.inputMap={},y.default.attach("dirtyCheck",this._dirtyCheck.bind(this)),y.default.attach("comment:start",this._startComment.bind(this)),y.default.attach("comment:show",this._showComment.bind(this))}},{key:"componentWillReceiveProps",value:function(e){this.setState({comments:[],fileGuid:window.cow.currentFile.guid}),(window.cow.currentFile.permissions||{}).commentable&&this._queryComments(e.guid)}},{key:"_bindEvent",value:function(){var e=this;i(document).on("click",function(t){e.state.activeGuid&&"buddle-comment-btn"!==t.target.id&&!e._isInComment(t.target)&&e._resetActive()}),i(window).on("resize",function(){e._dirtyCheck()})}},{key:"_bindPush",value:function(){var e=this;w.default.bind("Comment",function(t){if("create"===t.db_event){var n=t.data;e._handleCommentPush(n),"duang"===n.content&&e._duang()}else"update"===t.db_event?e._deleteCommentFromUi(t.data.comment_guid):"closeComments"===t.db_event&&e._deleteCommentsBySelectionGuid(t.data.selection_guid)})}},{key:"_deleteCommentsBySelectionGuid",value:function(e){var t=this.state.comments;o.remove(t,function(t){return t.selection_guid===e});this.state.activeGuid===e&&this._resetSelectionActive(),this.setState({comments:t})}},{key:"_handleCommentPush",value:function(e){if(-1===o.findIndex(this.state.comments,function(t){return t.comment_guid==e.comment_guid})){var t=this.state.comments;t.push(this._addUserAttrs(e)),this.setState({comments:t})}}},{key:"_duang",value:function(){var e=i("#pad-view");e.addClass("duang"),setTimeout(function(){e.removeClass("duang")},1e3)}},{key:"_isInComment",value:function(e){return i(e).parents(".doc-comment-box")[0]||i(e).hasClass("doc-comment-box")||i(e).parents(".doc-comment-number")[0]||i(e).hasClass("doc-comment-number")||i(e).hasClass("doc-comment-btn")||i(e).parents(".confirm-wrap")[0]}},{key:"_startComment",value:function(e){y.default.notify("comment:show");var t=this.state.newSelectionGuid;t.push(e),this._focusInput(e),this.setState({newSelectionGuid:t,activeGuid:e,mainGuid:e})}},{key:"_showComment",value:function(e){this.activeGuid!==e&&(this._focusInput(e),this.setState({activeGuid:e,mainGuid:e,curInput:this.inputMap[e]}),y.default.notify("active:change",[e]))}},{key:"_resetActive",value:function(e){var t=this.state,n=t.newSelectionGuid,i=t.activeGuid,a=e||i,r=this.inputMap[a];n.indexOf(a)>-1&&!k.default.hasContent(r)&&this._hasNoComments(a)&&(o.remove(n,function(e){return e===a}),y.default.notify("comment:cancel",a)),this.setState({activeGuid:"",mainGuid:""}),this._resetSelectionActive()}},{key:"_resetSelectionActive",value:function(){y.default.notify("active:change",[])}},{key:"_hasNoComments",value:function(e){return-1===o.findIndex(this.state.comments,function(t){return t.selection_guid==e})}},{key:"_dirtyCheck",value:function(){this.setState({dirtyCheck:this.state.dirtyCheck+1})}},{key:"_filterList",value:function(e){var t={};return o.forEach(e,function(e){var n=e.selection_guid;t[n]?t[n].push(e):t[n]=[e]}),this._filterGuid(t)}},{key:"_filterGuid",value:function(e){var t=this,n=document.getElementById("innerdocbody"),i=n&&n.getElementsByClassName("is-commented"),a=[],r={};return i&&i.length?(o.forEach(i,function(n){var i=n.className.match(/comment-\w{16}/)[0];r[i]||(i&&e[i]||t.state.newSelectionGuid.indexOf(i)>-1)&&(r[i]=!0,a.push({selection_guid:i,comments:e[i]||[],top:n.offsetTop}))}),a):[]}},{key:"_addUserAttrsByArray",value:function(e){var t=this;return o.forEach(e,function(e){t._addUserAttrs(e)}),e}},{key:"_addUserAttrs",value:function(e){return e.formattedTime=E.default.DateTime.format(e.created_at),e}},{key:"_queryComments",value:function(e){var t=this;(0,g.ajaxGet)("/api/comment/"+e).then(function(e){0===e.code&&t.setState({comments:t._addUserAttrsByArray(e.data)})}).catch(function(e){console.log("request comments error: "+e)})}},{key:"_getContainerStyle",value:function(){var e=document.getElementById("editorcontainerbox");return e?{left:e.offsetLeft+e.clientWidth-40}:{}}},{key:"_commentClick",value:function(e){this._showComment(e)}},{key:"_focusInput",value:function(e){var t=this;document.getElementById("innerdocbody").blur(),setTimeout(function(){var n=h.default.findDOMNode(t.refs[e]);if(n){var i=(0,_.getInstance)();i&&i.clearSelected();var o=n.getElementsByClassName("doc-comment-input")[0];o&&o.focus()}},500)}},{key:"_changeContainerClass",value:function(){var e=i("#editorcontainerbox");this.state.activeGuid?e.addClass("comment-actived"):e.removeClass("comment-actived")}},{key:"_adjustPosition",value:function(e){if(e.length){var t=Math.max(o.findIndex(e,{selection_guid:this.state.mainGuid}),0),n=i(".doc-comment-box");n[t].style.top=e[t].top+"px";for(var a=t+1;a<e.length;a++)this._adjustComment(e,n,a,"bottom");for(var r=t-1;r>=0;r--)this._adjustComment(e,n,r,"top");i(".doc-comment-container").css("opacity","1")}}},{key:"_adjustComment",value:function(e,t,n,i){var o=t[n-1],a=t[n],r=t[n+1],s=+a.style.top.replace("px",""),l=e[n].top;if(this.state.mainGuid&&s&&(l=s),"bottom"===i){var c=+o.style.top.replace("px","")+o.clientHeight+10;l=Math.max(c,l)}else{var d=+r.style.top.replace("px","")-a.clientHeight-10;l=Math.min(d,l)}a.style.top=l+"px"}},{key:"changeInputValue",value:function(e,t){this.inputMap[e]=t,this.setState({curInput:t})}},{key:"pushComment",value:function(e,t){var n=this.state.comments;this.inputMap[t]="",n.push(this._addUserAttrs(e)),this.setState({comments:n})}},{key:"closeComments",value:function(e){var t=this,n=this.state.comments,i=o.remove(n,function(t){return t.selection_guid===e}),a=this.state.newSelectionGuid;o.remove(a,function(e){return e===t.state.activeGuid}),this.setState({comments:n,newSelectionGuid:a}),this._resetSelectionActive(),this._closeCommentsBySelectionGuid(e,i)}},{key:"deleteComment",value:function(e){this._deleteCommentFromUi(e),this._deleteCommentByCommentGuid(e)}},{key:"_deleteCommentFromUi",value:function(e){var t=this.state.newSelectionGuid,n=this.state.comments,i=o.remove(n,function(t){return t.comment_guid===e}),a=i[0],r=this.state.activeGuid;if(a&&a.selection_guid===r&&-1===t.indexOf(r)){-1===o.findIndex(n,function(e){return e.comment_guid===a.selection_guid})&&(r="",this._resetSelectionActive())}this.setState({comments:n,activeGuid:r})}},{key:"_deleteCommentByCommentGuid",value:function(e){i.ajax({type:"post",url:"/api/comment/delete/"+e,data:{},dataType:"json",success:function(){console.log("delete comment success")},error:function(){console.log("delete comment error")}})}},{key:"_closeCommentsBySelectionGuid",value:function(e,t){var n=this;i.ajax({type:"post",url:"/api/comment/closeComments",data:{select_guid:e,target_guid:this.state.fileGuid},success:function(){console.log("delete comments success")},error:function(){console.log("delete comments error");var e=n.state.comments.concat(t);n.setState({comments:e})}})}},{key:"_notifyCommentsChange",value:function(e){var t={};o.forEach(e,function(e){t[e.selection_guid]=e.comments}),y.default.notify("comment:change",t)}},{key:"changeState",value:function(e){this.setState(e)}},{key:"render",value:function(){var e=this,t=this._filterList(this.state.comments),n=t.map(function(t,n){var i=t.selection_guid;return u.default.createElement(f.default,{activeGuid:e.state.activeGuid,ref:i,fileGuid:e.state.fileGuid,changeInputValue:e.changeInputValue,user:e.state.user,defaultValue:e.inputMap[i],index:n,resetActive:e._resetActive,onClick:e._commentClick.bind(e,i),pushComment:e.pushComment,deleteComment:e.deleteComment,closeComments:e.closeComments,selectionObj:t,key:i})}),i=this._getContainerStyle();return clearTimeout(this.adjustTimeout),this.adjustTimeout=setTimeout(function(){e._adjustPosition(t)},0),this._notifyCommentsChange(t),this._changeContainerClass(),u.default.createElement("div",{className:"doc-comment-container",style:i},u.default.createElement("div",{className:"doc-comment-list"},n),u.default.createElement("div",{className:"doc-comment-render"}))}}]),t}(d.Component);t.default=T,e.exports=t.default}).call(t,n(2),n(1))},1528:function(e,t,n){(function(i,o){function a(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var c=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),d=n(0),u=a(d),m=n(1529),h=a(m),p=n(5),f=a(p),g=n(647),v=a(g),y=n(9),b=a(y),w=n(146),C=a(w),E=n(1454),x=a(E),k=function(e){function t(){r(this,t);var e=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.state={afterAdjust:!1,isMac:f.default.isMac()},e.onMouseDown=e.onMouseDown.bind(e),e.onMouseUp=e.onMouseUp.bind(e),e._closeComments=e._closeComments.bind(e),e._onKeyDown=e._onKeyDown.bind(e),e._onInput=e._onInput.bind(e),e._cancelComment=e._cancelComment.bind(e),e._sendComment=e._sendComment.bind(e),e}return l(t,e),c(t,null,[{key:"propTypes",get:function(){return{activeGuid:d.PropTypes.string,selectionObj:d.PropTypes.object,onClick:d.PropTypes.func,user:d.PropTypes.object,changeInputValue:d.PropTypes.func,resetActive:d.PropTypes.func,closeComments:d.PropTypes.func,deleteComment:d.PropTypes.func,defaultValue:d.PropTypes.string,pushComment:d.PropTypes.func,fileGuid:d.PropTypes.string}}}]),c(t,[{key:"componentDidMount",value:function(){var e=this;this.lastShowFooter=!1,i(this.refs.box).on("mouseover",function(){e._changeActiveSelection("hover")}).on("mouseout",function(){e._changeActiveSelection()}),i(this.refs.body).on("mousewheel DOMMouseScroll",function(e){if(this.scrollHeight!==this.offsetHeight){var t=e.originalEvent,n=t.wheelDelta||-t.detail,i=n>0?"up":"down";("up"===i&&0===this.scrollTop||"down"===i&&this.scrollTop===this.scrollHeight-this.offsetHeight)&&t.preventDefault()}}),setTimeout(function(){e.setState({afterAdjust:!0})},0)}},{key:"componentWillReceiveProps",value:function(e){var t=this;this._changeToActive(e)&&setTimeout(function(){t._fillInput(),t._scrollToEnd()},0)}},{key:"_changeActiveSelection",value:function(e){var t=[],n=this.props.selectionObj.selection_guid;this.props.activeGuid||("hover"===e&&(t=[n]),b.default.notify("active:change",t))}},{key:"_changeToActive",value:function(e){var t=this.props,n=t.activeGuid,i=t.selectionObj,o=e.activeGuid===e.selectionObj.selection_guid;return!(n===i.selection_guid)&&o}},{key:"_scrollToEnd",value:function(e){e=e||this.refs.body,e.scrollTop=e.scrollHeight}},{key:"_fillInput",value:function(){this.refs.input.innerHTML=this.props.defaultValue||""}},{key:"_initMention",value:function(){var e=this;setTimeout(function(){e.mentionPop=new v.default("#comment-mention-pop"),e.mentionPop.mentionable(i(".doc-comment-input"))},0)}},{key:"_transformInput",value:function(e){return e.replace(/(\s|&nbsp;)+$/g,"").replace(/(\s|<br>)+$/g,"")}},{key:"_sendComment",value:function(e){var t=this,n=this._transformInput(this.refs.input.innerHTML),a=this.props.selectionObj.selection_guid,r=i("#innerdocbody").find("."+a).text(),s={comment_guid:f.default.genGuid(),content:n,selection_guid:a,selection_title:r,created_at:new Date,user_id:this.props.user.id};this.props.pushComment(o.extend(s,{User:this.props.user})),this.refs.input.innerHTML="",this.refs.input.focus(),this.props.changeInputValue(a,""),this._doSend(s),e.stopPropagation(),setTimeout(function(){t._scrollToEnd()},0)}},{key:"_doSend",value:function(e){var t=this.props.fileGuid;i.ajax({type:"post",url:"/api/comment/create?target_type=file&guid="+t,data:e,dataType:"json",success:function(){console.log("success")},error:function(){console.log("error")}})}},{key:"_cancelComment",value:function(e){var t=this.props.selectionObj.selection_guid;this.props.changeInputValue(t,""),this.props.resetActive(t),e.stopPropagation()}},{key:"_onInput",value:function(e){this.props.changeInputValue(this.props.selectionObj.selection_guid,e.target.innerHTML)}},{key:"_onKeyDown",value:function(e){if(!e.shiftKey&&13===e.keyCode&&(!this.mentionPop||!this.mentionPop.inMention)&&x.default.hasContent(e.target.innerHTML))return this._sendComment(e),e.preventDefault(),!1}},{key:"_closeComments",value:function(){var e=this;(0,C.default)({title:"结束讨论",description:"结束讨论后该讨论将被彻底删除，确定结束吗？",confirmFun:function(){var t=e.props.selectionObj.selection_guid;e.props.closeComments(t)}})}},{key:"_getBodyDom",value:function(e){var t=this.props.user,n=this.props.selectionObj.comments,i=n.length,o=this.props.deleteComment,a=void 0;if(i>2&&!e){var r=n[0],s=n[i-1];a=[u.default.createElement(h.default,{user:t,deleteComment:o,comment:r,key:r.comment_guid}),u.default.createElement("div",{className:"doc-comment-number",key:"0"},"中间还有 ",i-2," 条评论"),u.default.createElement(h.default,{user:t,deleteComment:o,comment:s,key:s.comment_guid})]}else a=n.map(function(e){return u.default.createElement(h.default,{user:t,deleteComment:o,comment:e,key:e.comment_guid})});return a}},{key:"onMouseDown",value:function(e){this.mousePointerOnDown={x:e.clientX,y:e.clientY}}},{key:"onMouseUp",value:function(e){Math.abs(e.clientX-this.mousePointerOnDown.x)<10&&Math.abs(e.clientY-this.mousePointerOnDown.y)<10&&this.props.onClick(e)}},{key:"render",value:function(){var e=this.props,t=e.selectionObj,n=e.activeGuid,i=e.user,o=e.defaultValue,a=t.selection_guid,r=n===a,s=!t.comments.length,l=x.default.isEmpty(o),c=x.default.hasContent(o),d=r||s,m=r&&!s,h=this._getBodyDom(r),p=r?"active":"";return d&&!this.lastShowFooter&&this._initMention(),this.lastShowFooter=d,this.state.afterAdjust||(p+=" comment-init"),u.default.createElement("div",{ref:"box",className:"doc-comment-box "+p,onMouseDown:this.onMouseDown,onMouseUp:this.onMouseUp},m&&u.default.createElement("div",{className:"doc-comment-header"},u.default.createElement("a",{onClick:this._closeComments,className:"doc-comment-close"},u.default.createElement("span",{className:"doc-comment-close-icon"}),"结束讨论")),u.default.createElement("div",{className:"doc-comment-body",ref:"body"},h),d&&!s&&u.default.createElement("div",{className:"doc-footer-divide"}),d&&u.default.createElement("div",{className:"doc-comment-footer"},u.default.createElement("img",{className:"doc-comment-avatar",src:i.avatar}),l&&u.default.createElement("div",{className:"doc-comment-input-placeholder"},"按enter发送，shift+enter换行"),u.default.createElement("div",{contentEditable:"true",onKeyDown:this._onKeyDown,onInput:this._onInput,ref:"input",className:"doc-comment-input"}),c&&u.default.createElement("div",{className:"doc-comment-btn-box"},u.default.createElement("a",{onClick:this._cancelComment,className:"doc-comment-btn doc-comment-cancel btn"},"取消"),u.default.createElement("a",{onClick:this._sendComment,className:"doc-comment-btn doc-comment-send btn btn-ok"},"确定"))))}}]),t}(d.Component);t.default=k,e.exports=t.default}).call(t,n(2),n(1))},1529:function(e,t,n){function i(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),l=n(0),c=i(l),d=n(146),u=i(d),m=function(e){function t(){return o(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),s(t,[{key:"_deleteComment",value:function(){var e=this;(0,u.default)({title:"删除评论",description:"确认要永久删除该评论吗？",confirmFun:function(){e.props.deleteComment(e.props.comment.comment_guid)}})}},{key:"_getContentHeight",value:function(){var e=this.props.comment.content,t=document.getElementsByClassName("doc-comment-render")[0],n="<div>"+e+"</div>";return t.innerHTML=n,t.firstChild.scrollHeight}},{key:"render",value:function(){var e=this.props.comment,t=this.props.user,n=e.content,i=e.formattedTime,o=e.User||window.cow.defaultAnonymousUser,a=o.avatar,r=o.name,s=o.id,l="",d="";return this.contentHeight||(this.contentHeight=this._getContentHeight()),this.contentHeight>50&&(l="over-range"),t.id===s&&(d="current-user"),c.default.createElement("div",{className:"doc-comment-item "+d},c.default.createElement("img",{className:"doc-comment-avatar",src:a}),c.default.createElement("span",{className:"doc-comment-online"}),c.default.createElement("div",{className:"doc-comment-text"},c.default.createElement("span",{className:"doc-comment-time"},i),c.default.createElement("span",{className:"doc-comment-delete",onClick:this._deleteComment.bind(this)},"删除"),c.default.createElement("span",{className:"doc-comment-name"},r),c.default.createElement("br",null),c.default.createElement("span",{className:"doc-comment-content "+l,dangerouslySetInnerHTML:{__html:n}})))}}],[{key:"propTypes",get:function(){return{comment:l.PropTypes.object,deleteComment:l.PropTypes.func,user:l.PropTypes.object}}}]),t}(l.Component);t.default=m,e.exports=t.default},1530:function(e,t,n){(function(i,o){function a(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function c(e){for(var t=Object.keys(E),n=0;n<t.length;n++)if(E[t[n]]===e)return t[n];return""}Object.defineProperty(t,"__esModule",{value:!0});var d=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),u=n(0),m=a(u),h=n(20),p=a(h),f=n(337),g=a(f),v=n(87),y=n(9),b=a(y),w=n(72),C=a(w);n(1531);var E={realTime:0,teamwork:1,share:4,comment:2,at:3,history:5,last:6},x=function(e){function t(e){r(this,t);var n=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={step:0,hide:!0,tipsVisible:[!1,!1,!1,!1,!1,!1],tipsElement:[{},{},{},{},{},{}]},n.autoNextTimer=-1,n.reset=n.show,n.handleClick=n.handleClick.bind(n),n.handlePadInput=n.handlePadInput.bind(n),n.changeGuideTipVisible=n.changeGuideTipVisible.bind(n),n.handlePadReady=n.handlePadReady.bind(n),n.handleMentionShow=n.handleMentionShow.bind(n),n.handleCommentBtnClick=n.handleCommentBtnClick.bind(n),n.hideHistoryTip=n.hideHistoryTip.bind(n),n.handleGuideTipVisibleChangedWithBc=function(e){(e.tag&&n.state.tipsVisible[E[e.tag]]||void 0!==e.index&&n.sate.tipsVisible[e.index])&&(n.changeGuideTipVisible.call(n,e),n.autoNext())},n}return l(t,e),d(t,[{key:"componentDidMount",value:function(){b.default.attach("guideTip:visible",this.handleGuideTipVisibleChangedWithBc),b.default.attach("pad:showMention",this.handleMentionShow),i(window).on("pad_ready",this.handlePadReady)}},{key:"componentWillUnmount",value:function(){b.default.detach("guideTip:visible"),b.default.detach("pad:showMention",this.handleMentionShow),i(window).off("pad_ready",this.handlePadReady);var e=document.getElementById("innerdocbody"),t=document.getElementById("buddle-comment-btn");e.removeEventListener("input",this.handlePadInput),t.removeEventListener("click",this.handleCommentBtnClick),this.clearAutoNextTimer()}},{key:"handleMentionShow",value:function(){this.changeGuideTipVisible({index:E.at,value:!1}),this.autoNext()}},{key:"handleCommentBtnClick",value:function(){this.changeGuideTipVisible({index:E.comment,value:!1}),this.autoNext()}},{key:"handlePadReady",value:function(){if(C.default.checkIsWelcomeFile()){this.show();var e=document.getElementById("innerdocbody"),t=document.getElementById("buddle-comment-btn");e.removeEventListener("input",this.handlePadInput),e.addEventListener("input",this.handlePadInput),t.removeEventListener("click",this.handleCommentBtnClick),t.addEventListener("click",this.handleCommentBtnClick)}}},{key:"handlePadInput",value:function(){this.state.tipsVisible[0]&&(this.changeGuideTipVisible({index:0,value:!1}),this.autoNext())}},{key:"clearAutoNextTimer",value:function(){this.autoNextTimer>-1&&clearTimeout(this.autoNextTimer)}},{key:"autoNext",value:function(){var e=this;this.clearAutoNextTimer(),this.autoNextTimer=setTimeout(function(){e.handleClick({target:{dataset:{action:"next"}}})},1e4)}},{key:"changeGuideTipVisible",value:function(e,t){var n=this.state.tipsVisible.map(function(t,n){return!(!e.value||n!==e.index&&e.tag!==c(n))});if(t)return n;this.setState({tipsVisible:n})}},{key:"$",value:function(e){var t=(0,v.qsa)(e),n=t[0]||null;return n?"none"===n.style.display?null:"0"===n.style.opacity?null:"hidden"===n.style.visibility?null:n:null}},{key:"handleClick",value:function(e){var t=this;switch(this.clearAutoNextTimer(),e.target.dataset.action){case"next":var n=this.state.step+1,a=0;["realTime","comment","at"].indexOf(c(n))>-1&&b.default.notify("pad:setCaretFixedPosition"),"comment"===c(n)&&(a=500),"last"===c(n)&&b.default.notify("guideTip:visible:desktop",!0);var r=this.changeGuideTipVisible({index:n,value:!0},!0);return void o.delay(function(){t.setState({step:n,tipsVisible:r,tipsElement:t.getTipsElement(n)})},a);case"prev":return n=this.state.step-1,r=this.changeGuideTipVisible({index:n,value:!0},!0),this.setState({step:n,tipsVisible:r});case"close":return r=this.changeGuideTipVisible({index:0,value:!1},!0),this.setState({hide:!0,step:0,tipsVisible:r});case"again":return b.default.notify("guideTip:visible:desktop",!1),void this.reset();case"help":return r=this.changeGuideTipVisible({index:0,value:!0},!0),i(".user-guide").prev(".fixed-button").click(),this.setState({hide:!0,tipsVisible:r});default:return}}},{key:"show",value:function(){var e=[].concat(this.state.tipsVisible).map(function(e,t){return 0===t});b.default.notify("pad:setCaretFixedPosition"),this.setState({step:0,hide:!1,tipsVisible:e,tipsElement:this.getTipsElement(0)})}},{key:"getSelectionLineElement",value:function(){var e=window.getSelection(),t=document.getElementById("innerdocbody");if(!t)return null;var n=e.anchorNode;if(3===n.nodeType&&(n=n.parentNode),!n)return null;var i=n.closest('div[id^="magicdom"]');return t.contains(i)?i:null}},{key:"getTipsElement",value:function(e){var t=this.state.tipsElement,n=o.isNumber(e)?e:this.state.step,i=this.$("#innerdocbody"),a=this.$("#doc-view"),r={positionNodeElement:i,triggerNodeElement:a},s=c(n);return"realTime"===s?t[n]=o.assign(r,{positionNodeElement:this.getSelectionLineElement()}):"teamwork"===s?t[n]=o.assign(r,{positionNodeElement:this.$(".teamwork-popover-trigger")}):"share"===s?t[n]=o.assign(r,{positionNodeElement:this.$(".share-btn-wrap")}):"comment"===s?t[n]=o.assign(r,{positionNodeElement:this.$("#buddle-comment-btn")}):"at"===s?t[n]=o.assign(r,{positionNodeElement:this.getSelectionLineElement()}):"history"===s?t[n]=o.assign(r,{positionNodeElement:this.$(".header-right-box .history-icon")}):"last"===s&&(t[n]=o.assign(r,{positionNodeElement:this.$(".header-back-up")})),[].concat(t)}},{key:"hideGuideTip",value:function(e){var t=[].concat(this.state.tipsVisible);t[e]=!1,this.setState({tipsVisible:t})}},{key:"hideHistoryTip",value:function(){this.state.tipsVisible[E.history]&&(this.hideGuideTip(E.history),this.autoNext())}},{key:"onImageClick",value:function(e){var t=e.target.src;t&&window.open(t)}},{key:"render",value:function(){var e=(0,p.default)("tutorial","step-wrapper-"+this.state.step,{active:!this.state.hide}),t=window.innerHeight,n=this.state.tipsVisible,i=this.state.tipsElement;return m.default.createElement("div",{className:e,onClick:this.handleClick},m.default.createElement("span",{className:"hicon icon-close","data-action":"close"}),m.default.createElement("div",{className:"step step-"+E.realTime+" center"},m.default.createElement("img",{className:"guide",onClick:this.onImageClick,src:"https://assets-cdn.shimo.im/assets/images/user_guide/guide_realtime_save-209d79ee50.gif"}),m.default.createElement("div",null,m.default.createElement("p",null,"Hi，"+cow.currentUser.name+"！",m.default.createElement("span",{className:"image-font font-realtime"},"欢迎使用石墨文档")),m.default.createElement("p",null,"试试 ",m.default.createElement("b",null,"写几个字"),"，你的编辑将实时保存到云端"))),m.default.createElement("div",{className:"step step-"+E.teamwork},m.default.createElement("img",{className:"guide",src:"https://assets-cdn.shimo.im/assets/images/user_guide/guide_teamwork-a462dd5645.gif"}),m.default.createElement("div",null,m.default.createElement("p",null,m.default.createElement("span",{className:"image-font font-teamwork"},"邀请好友协作")),m.default.createElement("p",null,"在",m.default.createElement("b",null,"“协作”")," 里添加成员的邮箱，与协作者协作编辑",m.default.createElement("br",null),"可以给协作者设置不同的 ",m.default.createElement("b",null,"权限")," “只能评论”、“只能阅读”"))),m.default.createElement("div",{className:"step step-"+E.share},m.default.createElement("img",{className:"guide",src:"https://assets-cdn.shimo.im/assets/images/user_guide/guide_share-c9de567e7a.gif"}),m.default.createElement("div",null,m.default.createElement("p",null,m.default.createElement("span",{className:"image-font font-share"},"公开分享链接")),m.default.createElement("p",null,"在 ",m.default.createElement("b",null,"“分享”")," 里开启公开链接，有链接的人即可访问文档"),m.default.createElement("p",null,"可以设置分享权限，",m.default.createElement("b",null,"“只读 / 可写”"),"，可以随时关闭公开链接"))),m.default.createElement("div",{className:"step step-"+E.comment},m.default.createElement("img",{className:"guide",src:"https://assets-cdn.shimo.im/assets/images/user_guide/guide_comment-caad713501.gif"}),m.default.createElement("div",null,m.default.createElement("p",null,m.default.createElement("span",{className:"image-font font-comment"},"划词评论")),m.default.createElement("p",null,m.default.createElement("b",null,"选中文字 / 图片"),"，或者点击某行文字右侧的 ",m.default.createElement("span",{className:"hicon icon-comment-add"})),m.default.createElement("p",null,"添加划词评论"))),m.default.createElement("div",{className:"step step-"+E.at},m.default.createElement("img",{className:"guide",src:"https://assets-cdn.shimo.im/assets/images/user_guide/guide_at-cedcc4f72c.gif"}),m.default.createElement("div",null,m.default.createElement("p",null,m.default.createElement("span",{className:"image-font font-at"},"提醒 @人，@文档")),m.default.createElement("p",null,"输入 ",m.default.createElement("b",null,"“@” + 协作者的名字")," 提及协作者，对方会收到消息提醒"),m.default.createElement("p",null,"输入 ",m.default.createElement("b",null,"“@” + 文件名")," 提及你的文档、表格、文件夹，创建文档索引"))),m.default.createElement("div",{className:"step step-"+E.history},m.default.createElement("img",{className:"guide",src:"https://assets-cdn.shimo.im/assets/images/user_guide/guide_history-a3980efd56.gif"}),m.default.createElement("div",null,m.default.createElement("p",null,m.default.createElement("span",{className:"image-font font-history"},"编辑历史与还原")),m.default.createElement("p",null,"点击查看历史，你的所有编辑记录都在这里"),m.default.createElement("p",null,"还可随时还原历史编辑"))),m.default.createElement("div",{className:"step step-"+E.last+" center"},m.default.createElement("div",null,m.default.createElement("p",null,m.default.createElement("span",{className:"image-font font-last"},"太棒了！返回桌面")),m.default.createElement("p",null,"更多功能使用方法，请点击左下角 ",m.default.createElement("span",{className:"link","data-action":"help"},"帮助")),m.default.createElement("p",null,"你还可以返回 ",m.default.createElement("a",{className:"link",href:"/desktop"},"桌面"),"， 看看我们的示例文档"),m.default.createElement("p",null,m.default.createElement("span",{className:"btn","data-action":"again"},"再看一遍")))),m.default.createElement("div",{className:"guide-mask"}),m.default.createElement("div",{className:"guide-tips-wrap"},m.default.createElement(g.default,{text:"输入一些文字",placement:"left",offsetLeft:70,offsetTop:-5,visible:n[E.realTime],positionNodeElement:i[E.realTime].positionNodeElement,triggerNodeElement:i[E.realTime].triggerNodeElement,triggerEvents:["scroll"],viewRect:{minTop:100,maxTop:t-300},autoUpdate:!0}),m.default.createElement(g.default,{text:"点这里，添加协作者",placement:"bottomRight",offsetLeft:8,offsetTop:0,visible:n[E.teamwork],autoUpdate:!0,positionNodeElement:i[E.teamwork].positionNodeElement}),m.default.createElement(g.default,{text:"点这里，开启公开分享链接",placement:"bottomRight",offsetLeft:8,offsetTop:0,visible:n[E.share],autoUpdate:!0,positionNodeElement:i[E.share].positionNodeElement}),m.default.createElement(g.default,{text:"点这里，添加评论",placement:"left",offsetLeft:-20,offsetTop:-7,visible:n[E.comment],positionNodeElement:i[E.comment].positionNodeElement,triggerNodeElement:i[E.comment].triggerNodeElement,triggerEvents:["scroll","click"],isDebounced:!0,debounceConfig:{click:100,scroll:0},maxWait:100,viewRect:{minTop:100,maxTop:t-300},autoUpdate:!0}),m.default.createElement(g.default,{text:"输入“@"+cow.currentUser.name+"”提及自己",placement:"left",offsetLeft:70,offsetTop:-5,visible:n[E.at],positionNodeElement:i[E.at].positionNodeElement,triggerNodeElement:i[E.at].triggerNodeElement,triggerEvents:["scroll"],viewRect:{minTop:100,maxTop:t-300},autoUpdate:!0}),m.default.createElement(g.default,{text:"点这里，查看历史",placement:"bottomRight",offsetLeft:3,offsetTop:-4,visible:n[E.history],positionNodeElement:i[E.history].positionNodeElement})),m.default.createElement("div",{className:"pagination"},m.default.createElement("span",{className:"btn next","data-action":"next"},"下一步")))}}]),t}(u.Component);t.default=x,e.exports=t.default}).call(t,n(2),n(1))},1531:function(e,t){},1534:function(e,t){function n(e){return{type:"RECEIVED_DOC_DATA",docData:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default={receivedDocData:n},e.exports=t.default},255:function(e,t,n){(function(i,o,a,r){var s,l,c=function(e,t){function n(){this.constructor=e}for(var i in t)d.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},d={}.hasOwnProperty;s=[n(33),n(5),n(549),n(335),n(9),n(179),n(735),n(34),n(441),n(194),n(736),n(48),n(738),n(662),n(739),n(442),n(201),n(323),n(72),n(740),n(21)],void 0!==(l=function(e,t,n,s,l,d,u,m,h,p,f,g,v,y,b,w,C,E,x,k,_){var T,S;return T=_.isClient(),S=_.isRNClient(),new(function(m){function h(){return h.__super__.constructor.apply(this,arguments)}return c(h,m),h.prototype.init=function(){var e;return e=this,this.cow=window.cow,this.imageDownloadLink="/download/image?url=",this.padView=i("#pad-view"),this.gallery=i("#gallery-box"),this.galleryImg=i("#gallery-img"),this.galleryDetail=i("#gallery-details"),this.galleryList=i("#gallery-list"),this.docTitleInput=i(".doc-title-input"),this.view=this.padView,this.isMouseMove=!1,this.isMouseDown=!1,this.isDisableLink=!1,this.isPadReady=!1,this.imgArray=[],this.originPos={},this.initFontColorParams(),this.fontSizeList=["9","10","11","12","14","18","24","30","36"],this.bindEvents(),this.subscribe(),this.initSaveToShimo(),this.tooltipInfo={},this.initDocTitleEditable(),this.changeIOSAppLink(),this.initialized=!0,t.isMobile()&&0===this.cow.currentFile.type&&"editable"===this.cow.currentFile.shareMode&&e.checkPadReady().then(function(){return k.renderStarFileComponent()}),t.isMobile()&&0===this.cow.currentFile.type&&this.cow.currentFile.team_id&&e.checkPadReady().then(function(){return e.handleTranslateNumber()}),e},h.prototype.eventMap={"blur #doc-title-input":"updateTitle","focus #doc-title-input":"focusTitle","input #doc-title-input":"changeTitle","keypress #doc-title-input":"docInputKeypress","click #doc-insert":"toggleInsertMenu","click #innerdocbody>div":"fadeUserline","mouseover #innerdocbody":"handleMouseOver","mouseout #innerdocbody":"handleMouseOut"},h.prototype.domEvents={focusTitle:function(e){if("无标题"===this.title.val()&&this.title.val(""),T)return l.notify("file:titleStatusChanged",!0)},stopPropagation:function(e){return e.preventDefault(),e.stopPropagation(),!1},updateTitle:function(e){return S?l.notify("file:titleStatusChanged",!1):this.updateTitle(e)},changeTitle:function(e){var t;if(S)return t=i(e.target).prop("value"),l.notify("file:updateTitle",t)},docInputKeypress:function(e){var n,o,a;if(e.keyCode===t.keyCodes.ENTER)return i(e.target).blur(),a=window.getSelection(),o=document.createRange(),n=document.getElementById("innerdocbody"),o.setStart(n,0),o.setEnd(n,0),a.removeAllRanges(),a.addRange(o),e.stopPropagation(),e.preventDefault(),!1},cancelShare:function(){var e;return e=window.cow.currentFile,p.show({okCallback:function(){return t.post("/api/share/delete",{guid:e.guid,user_id:window.cow.currentUser.id,file_type:"file"},function(){return t.alert({title:"已从此文档的共享中退出"}),window.location.href="/desktop"},function(){return t.alert({title:"操作失败",type:"error"})})},headText:"退出共享",bodyText:"确认要退出共享吗？<br />退出共享后你将无权限访问该文件"})},fadeUserline:function(e){var t;return e.offsetX<0?(t=i(e.target).data("author-name"))?i(e.target).removeClass("fadeUserline").siblings().each(function(e,n){return t!==i(n).data("author-name")?i(n).addClass("fadeUserline"):i(n).removeClass("fadeUserline")}):void 0:i("#innerdocbody > div").removeClass("fadeUserline")},handleMouseOver:function(e){var t,n,o,a,r,s;for(r=e.target,s=document.getElementById("innerdocbody");r&&!this._isAuthoredSpan(r)&&r!==s;)r=r.parentNode;if(this._isAuthoredSpan(r)&&this.tooltipInfo.target!==r&&"dotted"===this.getStyle(r,"border-bottom-style"))return a=this.getStyle(r,"border-bottom-color"),this.ensureTooltipExists(),t=this.getClassArray(r,function(e){return e.match("^author-")}),n=t[0].replace("author-",""),o=g.getUserName(n),this.tooltipInfo.target=r,this.tooltipInfo.tooltip.innerHTML=o,this.tooltipInfo.tooltip.style.display="block",this.tooltipInfo.tooltip.style.left=String(i(r).offset().left+i(r).outerWidth()/2-i("#tooltip").outerWidth()/2)+"px",this.tooltipInfo.tooltip.style.right="auto",this.tooltipInfo.tooltip.style.top=String(i(r).offset().top+i(r).outerHeight()+5)+"px",this.tooltipInfo.tooltip.style.background=a,this.tooltipInfo.tooltip.style.position="absolute"},handleMouseOut:function(e){if(this.tooltipInfo.tooltip&&(!e.relatedTarget||!this._isElementChildOf(e.relatedTarget,this.tooltipInfo.target)))return this.tooltipInfo.target=null,this.tooltipInfo.tooltip.style.display="none"},toggleInsertMenu:function(e){var n;return e.stopPropagation(),n=i("#doc-insert"),n.hasClass("active")||t.clearDropdown(),n.toggleClass("active")}},h.prototype.dingtalkBackText=function(e){var t;if(t=i("#dingtalk-back"),"desktop"===e)return t.text("我的桌面"),void t.addClass("dingtalk-desktop");"back"===e&&(t.text("返回"),t.removeClass("dingtalk-desktop"))},h.prototype.translateNumber=function(e){var t,n,i,o,a,r,s,l,c,d,u,m,h,p;if(o="零",t=["","一","二","三","四","五","六","七","八","九"],i=["","十","百","千"],n=["","万","亿","兆"],""===e)return"";if(""===(e=e.replace(/^0+/g,"")))return o;for(h="",s=!0,d=!1,l=c=0,m=e.length;0<=m?c<m:c>m;l=0<=m?++c:--c)u=e.length-1-l,a=parseInt(e[l]),p=u%i.length,r=(u-p)/i.length,0!==a&&(d&&(h+=o),(1!==a||1!==p||!s||0===r&&d)&&(h+=t[a]),h+=i[p]),s=s&&0===a,0!==p||s||(h+=n[r]),d=0===a&&(0!==p||s),0===p&&(s=!0);return h+" 阅"},h.prototype.handleTranslateNumber=function(){var e,t,n;return n=this,e=i(".mobile-anonymous-doc-desc, .doc-desc"),t=e.text(),e.html(n.translateNumber(t))},h.prototype._goback=function(){var e,t;return e=cow.currentFile,t="",t=window.cow.authorized?e.parent&&e.parent.guid?"/folder/"+e.parent.guid:"/desktop":"/login",o(t)},h.prototype.changeIOSAppLink=function(){if(t.isIOS())return i(".app-link").attr("href","https://itunes.apple.com/app/id1013727678")},h.prototype.setHeaderAndFooter=function(){var e;e=this,e.checkPadReady().then(function(){var e;return e=window.cow.currentFile,e.authorized?i(".edit-heading").show():"editable"===e.shareMode?i(".mobile-editable-header, .mobile-editable-footer").show():void 0})},h.prototype.reset=function(){var e,o;return e=this,this.comment=n.getInstance(".sidebar-body"),this.title=this.view.find("#doc-title-input"),this.titleSpan=this.view.find("#doc-title-span"),this.shareBox=this.view.find(".list-share-box"),this.operationBox=i(".operation-box"),this.focusTarget=i("#focus-target"),this.padWrap=i("#pad-wrap"),this.docView=i("#doc-view"),this.editbar=i("#editbar"),this.sidebar=i("#sidebar"),this.editHeader=i("#edit-heading"),this.mobileMoreBtn=i("#mobile-more-btn"),this.crumbWrap=i(".crumb-wrap"),this.mobileShareLink=i(".share-link"),this.textCount=i("#text-count"),this.isMouseMove=!1,this.isMouseDown=!1,this.isDisableLink=!1,this.isPadReady=!1,this.imgArray=[],this.originPos={},this.initName(),this.initScroll(),this.initToolbar(),this.checkPadReady().then(function(){return e.bindTextCount(),e.docView.on("scroll",function(){return 0===i(this).scrollTop()?i("body").removeClass("scroll"):i("body").addClass("scroll")})}),window.cow.authorized?t.isMobile()?(o=_.getShareMode(),this.mobileShareLink.removeClass().addClass("share-link share-"+o),this.mobileMoreBtn.removeClass("transparent")):(l.notify("doc:init","doc"),this.shareBox.removeClass("hide")):t.isMobile()?this.mobileMoreBtn.addClass("transparent"):this.shareBox.addClass("hide")},h.prototype.initToolbar=function(){return this.initCtrlOrCmd(),this.initFontList(),this.initDisplayBtn(),i(".toolbar-item").each(function(e,t){return new b(t)}),i(".menu-item").each(function(e,t){return new b(t,{placement:"left"})}),new b("#image-upload-button"),new b("#upload-attachment")},h.prototype.initFontList=function(){var e,t,n,i,o;return i=this,e=this.editHeader.find("#color-list"),e.empty(),n="",a.each(this.fontColorList,function(e,t){var o,a;return o=i.colorNameList[t],a="",t<9&&(a="margin-bottom: 5px;"),n+="<li class='font-color-list-item' style='background:"+e+"; "+a+"'><a href='javascript:void(0);' class='color-item'><span class='doc-color-name s-tooltip'>"+o+"</span></a></li>"}),e.append(n),t=this.editHeader.find("#size-list"),t.empty(),o="",a.each(this.fontSizeList,function(e,t){return o+='<li class="font-size-list-item"><a href="javascript:;" class="menu-item"><span data-value="'+(t+1)+'">'+e+"</span></a></li>"}),t.append(o)},h.prototype.initCtrlOrCmd=function(){var e,t,n;if(t=i(".toolbar-item,.menu-item"),e=i(".font-size-toolbar"),r.win)"Ctrl";else if("Cmd",a.each(t,function(e){var t,n,o;if(n=i(e),"string"==typeof(t=n.data("content")))return o=t.replace("Ctrl","Cmd"),n.data("content",o)}),"string"==typeof e.data("content"))return n=e.data("content").replace("↑/↓","⬆/⬇"),e.data("content",n)},h.prototype.initScroll=function(){var e,n,o,a,r;return r=this,/^#(comment-)?[a-zA-Z0-9]{16}$/.test(location.hash)?(this.comment.off("ready"),e=window.cow.currentFile.guid,n=location.hash.substring(1),o=location.href.indexOf("?"),a=location.href,o>-1?(a=a.replace(location.hash,""),a=a.replace("http://"+location.host,""),history.replaceState({guid:e},"",a)):history.replaceState({guid:e},"",location.pathname),/^comment-[a-zA-Z0-9]{16}$/.test(n)?(t.isMobile()&&!T&&d("移动版暂不支持查看评论"),this.comment.isReady?this.showComment(n):this.comment.on("ready",function(){return r.showComment(n)})):/^[a-zA-Z0-9]{16}$/.test(n)?this.scrollToMention(n):void 0):void r.checkPadReady().then(function(){var e;return e=i(t.isMobile()?"#pad-wrap":"#doc-view"),e.scrollTop(0)})},h.prototype.initDisplayBtn=function(){return y.postAceInit()},h.prototype.scrollToMention=function(e){var n;return n=this,n.checkPadReady().then(function(){var o,a,r;if(o=n.docView.find("."+e),o.length>0)return a=o.offset().top-i(document).height()/2,r=i(t.isMobile()?"#pad-wrap":"#doc-view"),r.scrollTop(a)})},h.prototype.showComment=function(e){var t,n;if(n=this,null!=(t=this.comment.commentData[e]))return n.checkPadReady().then(function(){var t;return T?(t=n.docView.find("."+e),s.repositionBuddle(t),s.showListComment(e)):setTimeout(function(){return l.notify("comment:show",e)},100)}),l.notify("comments",{comments:[t]})},h.prototype.checkPadReady=function(){var e,t,n;return n=this,e=i.Deferred(),n.isPadReady?e.resolve():(t=function(n){return i(window).off("pad_ready",t),e.resolve()},i(window).on("pad_ready",t)),e.promise()},h.prototype.initName=function(e){if(e=window.cow.readonly?e||this.title.html():e||this.title.prop("value"))return t.cutName(e,32),this.titleSpan.html(a.escape(e)),window.cow.readonly?this.title.html(a.escape(e)).attr("title",e):this.title.val(e).attr("data-value",e),this.cow.updateTitle(e)},h.prototype.subscribe=function(){var t;return t=this,e.bind("File",function(e){var n;if("doc"===window.cow.pageType&&"update"===e.db_event&&(null!=e&&null!=(n=e.data)?n.id:void 0)===window.cow.currentFile.id){if(0==+e.data.is_delete)return window.cow.updateDocCurrentFile({name:e.data.name}),t.initName(e.data.name);if(+e.data.is_delete>=1&&e.data.deleted_by&&+e.data.deleted_by!==window.cow.currentUser.id)return t.backParent()}})},h.prototype.initFontColorParams=function(){var e;return e=this,this.attrValuesMap=[13,14,15,16,2,3,17,4,5,18,6,19,20,21,22,23,24,25,26,27,1,28,29,30,31,32,33,34,35,7,8,36,9,10,38,39,40,12,41,42,43,44,45,37,11],this.fontColorList=["#ffffff","#0d0015","#fe2c23","#ff9900","#ffd900","#a3e043","#37d9f0","#4da8ee","#aa17d0","#f3f3f1","#949494","#fcdbd6","#fde9d0","#fff0cf","#d4e9d6","#def3f3","#cee0ef","#dfdbec","#dcdedd","#595856","#ee837d","#f8c387","#e6b322","#9abd9d","#83ccd2","#89b0ce","#9389b1","#c1c6ca","#41464b","#d51228","#cf770b","#8d634a","#557b5c","#01a3b0","#3776a6","#765c83","#adadad","#2b2b2b","#a91913","#884702","#563725","#00552e","#00767a","#194e77","#530e6f"],this.colorNameList=["白","漆黑","红","橙","黄","葱绿","湖蓝","天色","紫","白练","鼠","虹","薄卵","蒸栗","白绿","蓝白","天空","紫水晶","白鼠","墨","甚三红","雄黄","金子","薄青","白群","薄花","紫苑","灰青","石墨","红绯","红金","枯茶","绿青","浅葱","薄缥","紫霞","薄钝","黑","朱绯","褐","黑茶","深绿","苍蓝","琉璃","葡萄"],this.fontColorObj={},a.each(this.attrValuesMap,function(t,n){return e.fontColorObj[t]=e.fontColorList[n]})},h.prototype.bindEvents=function(){var e;return e=this,"gallery"===location.hash.slice(1)&&(location.hash=""),i(window).on("pad_ready",function(){return e.isPadReady=!0}).on("hashchange",function(){return e.initScroll(),e.swapStatus()}).on("keydown keypress",function(e){if(8===e.keyCode&&"BODY"===e.target.tagName)return e.preventDefault()}),this.padView.on("click","#sidebar .change",function(e){return!1}),this.padView.on("hover",".history-show .document-info-list",function(e){return i("#sidebar").css("z-index","1")}).on("mousemove",".history-show .document-info-list",function(e){return i("#sidebar").css("z-index","-1")}),this.padView.on("click","#innerdocbody img",function(n){var o,a,r,s,c,d,u,m,h,p,f;if(f=i("#tempImageResizeStyle").text(),o=i(n.target).parents("span[class*=img-]"),r=o.length>0?o.attr("class"):"",c=r.match(/img-[0-9A-Za-z]{16}/),c=c&&c[0],i(".image-resize-bar").is(":visible")&&f.indexOf(c)>-1||window.cow.readonly||t.isMobile())return n.preventDefault(),n.stopPropagation(),h=i(n.target).attr("src"),window.cow.readonly?void window.open(h.replace(/!thumbnail$/,"")):(u=e.view.find("#innerdocbody img"),p=[],d=[],a=-1,u.each(function(e,t){var o,r,s;return o=i(t),s=o.attr("src"),p.push(s),r=o.closest("span").attr("class"),c=r.match(/img-([0-9|a-z|A-Z]{16})/),c=c&&c[1]?c[1]:"",o.is(n.target)&&(a=e),d.push(c)}),T?(s=u.index(n.target),void l.notify("openImage",{imgs:p,guids:d,currentIndex:s})):(e.originPos.e=n,e.imgArray=u,m=n.target.src,e.setPosition(),e.isMobile()?C.previewImage({urls:p,current:m}):(l.notify("img:preview",a,p),l.notify("body:addOverflowHidden"))))}),i(document).on("keyup",function(n){if(e.gallery.hasClass("modal"))return n.keyCode===t.keyCodes.LEFT||n.keyCode===t.keyCodes.UP?e.changeActive("up"):(n.keyCode===t.keyCodes.RIGHT||n.keyCode===t.keyCodes.DOWN)&&e.changeActive("down")}),this.gallery.on("click",".thumb",function(t){if(!i(this).hasClass("active"))return e.showSpecifiedImg(i(this).index())}),this.gallery.on("click",function(t){if(t.stopPropagation(),!i(t.target).hasClass("return")&&!i(t.target).parents(".return").length)return e.isMobile()?"#gallery"===location.hash?history.back():location.hash="":e.changeGallery("hide")}),this.$view.on("click",".context-menu-list",function(e){var t;if((t=i(this).attr("data-guid").match(/table-(\w{16})/))&&!i(".table-"+t[1]).length)return i(this).remove(),i("#context-menu-layer").remove()})},h.prototype.bindTextCount=function(){var e,t,n,o,r;return u.start(),t=parseInt(this.textCount.css("bottom")),r=null,n=this,i(document).on("selectionchange",function(a){var s,l,c,d,u,m;return c=i(a.currentTarget.activeElement),0!==c.closest("#editorcontainer").length&&(m=window.getSelection(),m.toString().length?(clearTimeout(r),s=n.docView.children(".outer-container").outerHeight(),l=n.docView.outerHeight(),d=i("#footer").outerHeight(),u=s+d,i(document).off("click.removeTextCount").on("click.removeTextCount",function(e){if(0===i(e.currentTarget.activeElement).closest("#editorcontainer").length)return o()}),n.docView.off("scroll.TextCount").on("scroll.TextCount",function(e){var o,a;return a=i(e.currentTarget).scrollTop(),l+a>=s?(o=d-(u-(l+a))+t,n.textCount.css("bottom",o)):n.textCount.css("bottom",t)}),n.textCount.css("bottom",t).removeClass("hide fadeout").children(".text-count-number").text(e(m.toString())),n.docView.trigger("scroll.TextCount"),r=setTimeout(function(){return n.textCount.addClass("fadeout"),setTimeout(function(){return o()},500)},3e3)):n.textCount.hasClass("hide")?void 0:o())}),o=function(){return n.textCount.addClass("hide"),i(document).off("click.removeTextCount"),n.docView.off("scroll.TextCount")},e=function(e){var t,n,i,o,r,s;return o=0,i=/^[A-Za-z0-9]+$/gi,n=/[A-Za-z0-9]+/gi,r=/↵|\s/,t=/[^a-zA-Z0-9\s\u4e00-\u9fa5]/g,e=e.replace(/\b[a-zA-Z]+'[a-zA-Z]+\b/g,"0").replace(/\b\d+\.\d+\b/g,"0").replace(t," "),s=a.compact(e.split(r)),s.forEach(function(e){var t,a,r,s;return s=e.trim(),a=s.match(i),Array.isArray(a)?o+=a.length:(t=s.match(n),Array.isArray(t)?(r=s.split(n).join(""),o+=r.length,o+=t.length):o+=s.length)}),o}},h.prototype.swapStatus=function(){var e;return e=location.hash?location.hash.slice(1):"","gallery"===e?this.changeGallery("show"):this.changeGallery("hide")},h.prototype.updateTitle=function(e){var n,o,a;if(a=i(e.target).prop("value"),T&&l.notify("file:titleStatusChanged",!1),a||(a=i(e.target).val("无标题").val()),a!==i(e.target).attr("data-value")&&(n={name:a},o=this.cow.currentDocGuid||this.cow.currentFile.guid,t.post("/api/file/"+o,n).fail(t.error),l.notify("file:updateTitle",a),T))return l.notify("updateTitle",{title:a})},h.prototype.renderShare=function(){if("doc"===window.cow.pageType)return this.share?this.share.reload():this.share=new Share(" .list-share-box .dropdown.share",{teamworkerEle:" .list-share-box .dropdown.teamworker"})},h.prototype.reloadShare=function(){if("doc"===window.cow.pageType&&this.share)return this.share.reload()},h.prototype.initSaveToShimo=function(){var e;return e=this,this.checkPadReady().then(function(){if(window.cow.currentUser.id<0||window.cow.readonly)return e.saveDoc=new f("body")})},h.prototype.initDocTitleEditable=function(){return this.checkPadReady().then(function(e){return function(){if(!window.cow.currentFile.permissions.editable&&t.isMobile())return e.docTitleInput.attr("readonly","readonly")}}(this))},h.prototype.changeActive=function(e){var t;if(t=this.galleryList.find(".thumb.active").index(),"up"===e){if(0===t)return;t-=1}else{if(t===this.imgArray.length-1)return;t+=1}return this.showSpecifiedImg(t)},h.prototype.showSpecifiedImg=function(e){var t;return this.galleryList.find(".thumb.active").removeClass("active"),t=this.galleryList.find(".thumb:nth-child("+(e+1)+")"),t.addClass("active"),this.generateZoomImg(this.imgArray[e].src)},h.prototype.scrollToActiveThumb=function(){var e,t,n;if(e=this.galleryList.find(".thumb.active"),e.length){if(n=i(window).height(),t=this.galleryList.scrollTop(),e.offset().top<70)t=t+e.offset().top-70;else{if(!(e.offset().top>n-120))return;t=t+e.offset().top-n+120}return this.galleryList.scrollTop(t)}},h.prototype.showActiveInfo=function(){var e,t,n,i;return i=this.imgArray.length,e=this.galleryList.find(".thumb.active"),e.length?(n=e.index()+1,t=n+"/"+i):t="",this.galleryDetail.find("number").html(t)},h.prototype.setPosition=function(){var e,t,n,o,a,r,s;return o=this,n=o.originPos,this.imgArray.length>1&&this.gallery.hasClass("modal")?(e=o.galleryList.find(".thumb.active"),a=this.imgArray[e.index()]):null!=n.e&&(a=n.e.target),n=a&&i(a).parents("#innerdocbody").length?{off:i(a).offset(),width:i(a).width(),height:i(a).height()}:{off:!1,width:0,height:0},s=i(window).width(),r=i(window).height(),this.isMobile()?(t=r/s>=n.height/n.width?(r-n.height/n.width*s)/2:0,this.galleryImg.css({width:"100%",height:"auto","margin-top":t})):this.galleryImg.css({width:n.width,height:n.height,top:n.off?2*n.off.top-(r-n.height):0,left:n.off?2*n.off.left-(s-n.width):0})},h.prototype.showGalleryList=function(e,t){var n;return n=this,this.galleryList.show().html(""),a.each(e,function(e){var i,o,a;return i=e.src===t?" active":"",o=e.src,a='<p class="gallery-list-item thumb'+i+'"><img class="gallery-list-img" src="'+o+'" style=""></p>',n.galleryList.append(a)}),this.galleryDetail.css({right:this.galleryList.width()})},h.prototype.generateImgList=function(e){if(this.imgArray.length>1&&!this.isMobile())return this.showGalleryList(this.imgArray,e)},h.prototype.generateZoomImg=function(e){var t,n,o,a,r;return o=new Image,o.src=e,o&&o.width?a={width:o.width,height:o.height}:(t=this.galleryList.find(".thumb.active"),r=this.imgArray[t.index()],a={width:i(r).width(),height:i(r).height()}),n={width:i(window).width()-40-this.galleryList.width(),height:i(window).height()-40-this.galleryDetail.height()},a.width>n.width&&(a={width:n.width,height:a.height*n.width/a.width}),a.height>n.height&&(a={width:a.width*n.height/a.height,height:n.height}),a.left="block"===this.galleryList.css("display")?-this.galleryList.width():0,this.galleryDetail.find(".origin-link").attr("href",e.replace(/!thumbnail$/,"")),this.galleryImg.find("img").attr("src",e),this.galleryDetail.find(".origin-link")[0].hostname===window.cow.domain&&(e=e.replace("_large","")),this.galleryDetail.find(".link-download").attr("href",this.imageDownloadLink+e),this.galleryDetail.find(".link-download").show(),this.isMobile()||this.galleryImg.css({width:a.width,height:a.height,top:"-"+this.galleryDetail.height()+"px",left:a.left}),this.scrollToActiveThumb(),this.showActiveInfo()},h.prototype.resetGallery=function(){return this.imgList=[],this.setPosition(),this.gallery.css("background-color","transparent")},h.prototype.refreshGallery=function(){return this.gallery.attr("style","").removeClass("modal").children().attr("style","")},h.prototype.changeGallery=function(e){var t;return t=this,"show"!==e?(l.notify("body:removeOverflowHidden"),this.resetGallery(),this.isMobile()?(this.refreshGallery(),this.padWrap.removeClass("hide"),window.cow.padScroller&&window.cow.padScroller.refresh()):setTimeout(function(){return t.refreshGallery()},200)):(l.notify("body:addOverflowHidden"),this.gallery.addClass("modal"),this.isMobile()?(this.padWrap.addClass("hide"),i("#innerdocbody").blur()):void 0)},h.prototype.isMobile=function(){return window.cow.isMobile},h.prototype.backParent=function(){var e,t;return o.len>0?o.back():(e=window.cow.currentFile,t=window.cow.authorized?e.parent&&e.parent.guid?"/folder/"+e.parent.guid:"/desktop":"/login",o(t))},h.prototype.ensureTooltipExists=function(){if(!this.tooltipInfo.tooltip)return this.tooltipInfo.tooltip=document.createElement("DIV"),this.tooltipInfo.tooltip.id="tooltip",i("body").append(this.tooltipInfo.tooltip)},h.prototype._isAuthoredSpan=function(e){return!(!e||"SPAN"!==e.nodeName)&&this.getClassArray(e,function(e){return e.match("^author-")}).length},h.prototype.getClassArray=function(e,t){var n;return e.className?(n=[],e.className.replace(/\S+/g,function(e){if(!t||t(e))return n.push(e)}),n):[]},h.prototype.getStyle=function(e,t){var n;return n=function(e){return e.replace(/\-(\w)/g,function(e,t){return t.toUpperCase()})},e.currentStyle?e.currentStyle[n(t)]:document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(e,null).getPropertyValue(t):e.style[n(t)]},h.prototype._isElementChildOf=function(e,t){for(;e&&e!==t;)e=e.parentNode;return e===t},h}(t.DomModule))("#pad-view")}.apply(t,s))&&(e.exports=l)}).call(t,n(2),n(23),n(1),n(262))},335:function(e,t,n){(function(i,o){var a,r;a=[n(33),n(5),n(549),n(9),n(48),n(21)],void 0!==(r=function(e,t,n,a,r,s){var l,c,d,u,m,h,p,f,g,v,y,b,w,C,E,x,k,_,T,S,I,N,L,O,P,D,M,R,A;return y={},u="",f="",L="",C="",m=!0,N=!1,A="",g="",v="",I=!1,c=96/72,R=void 0,l=void 0,P={},a.attach("pad:render_content",function(){if(l=n.getInstance(".sidebar-body"),!R)return R=new d}),k=s.isClient(),S=s.isRNClient(),d=function(){function n(){this.view=i("#pad-view"),this.header=i("#header"),this.editHeading=i("#edit-heading"),this.buddleBox=i("#buddle-box"),this.cover=i("#document-cover-box"),this.comment=i(".sidebar-body"),this.container=i("#doc-container"),this.editor=i("#innerdocbody"),this.editContainer=i("#editorcontainer"),this.sideCommentBtn=i("#buddle-comment-btn"),this.commentInput=this.comment.find(".comment-input"),this.documentCover=this.cover.find(".document-cover"),this.sCommentInfo=this.comment.find(".selection-comment-info"),this.docView=i(k?"#pad-wrap":"#doc-view"),this.dirtyCheck="",this.buddleList={},this.lineToComments=[],this.fontList=["9","10","11","12","14","18","24","30","36"],this.sideHover=!0,this.cutLength=S?80:k?90:98,this.autoScroll=!1,this.currentLineNum=-1,this.Comment=l,this.isAndroidApp=t.isAndroidApp(),this.init()}return n.prototype.init=function(){var e;return e=this,this.bind(),this.bindWin(),this.resizeWin(),this.changeMode("document-comment"),this.initBuddle(),this.Comment.getCommentFont=this.getCommentFont,this.Comment.fontList=this.fontList,a.attach("contact:loaded",function(){var t,n,i,o,a,s,l;s=e.Comment.commentData;for(n in s)for(t=s[n],o=0,a=t.length;o<a;o++)i=t[o],l=r.get(i.user_id),i.name=l.name,i.avatar=l.avatar;return e.refreshAuthor()}),a.attach("active:change",function(e){return M(e)}),a.attach("comment:cancel",function(t){return e.context.ace.callWithAce(function(e){var n,i;return n=document.getElementsByClassName(t)[0],i=e.ace_domToRep(n),e.ace_cancelComment(i)},"cancel-comment",!0)}),a.attach("comment:change",function(e){return P=e})},n.prototype.initBuddle=function(){var e,t,n;return n=this,e=function(){var e;return e=0,n.Comment.isReady?(clearInterval(t),n.buddleDirtyCheck(),n.commentPushCheck()):e>50?clearInterval(t):void 0},t=setInterval(e,200)},n.prototype.bind=function(){return t.bindEvents.call(this,"",this.bindFun)},n.prototype.bindFun={buddleClick:function(e){var t,n,o,r;return t=i(e.target),t.hasClass("comment-buddle")?(this.Comment.resetTempList(),this.repositionBuddle(t),"document-comment"!==this.comment.attr("comment-mode")&&this.refreshSelection(),t.hasClass("beClick")?t.removeClass("beClick"):(this.buddleBox.find(".beClick").removeClass("beClick"),this.buddleBox.find(".active").removeClass("active"),t.addClass("beClick"),o=i(e.target).attr("data-buddle"),r=this.buddleList[o].group,i(e.target).data("select-array",r),k?(n=this.getCommentData(),n.current=r[0],a.notify("comments",n)):this.showListComment(e))):void t.parent().click()},buddleMouseOver:function(e){if(m)return this.changeHighLight(e,"show")},buddleMouseOut:function(e){if(m)return this.changeHighLight(e,"hide")},commentBtnClick:function(e){if(this.Comment.isReady)return this.newComment(),e.stopPropagation()},commentKeyPress:function(e){var n;if(n=this.comment.attr("comment-mode"),e.keyCode===t.keyCodes.ENTER&&"start-selection-comment"===n)return this.finishComment(),this.buddleDirtyCheck()},coverClick:function(){return this.hideCover()},editKeyDown:function(){var e;return e=this,clearTimeout(e.dirtyCheck),e.dirtyCheck=setTimeout(function(){return e.buddleDirtyCheck()},100)},padClick:function(e){if(!i(e.target).parents(".sidebar-body").length&&!i(e.target).hasClass("comment-buddle")&&"buddle-comment-btn"===!e.target.id&&"document-mode"!==this.comment.attr("comment-mode"))return this.hideCover()},sideCommentClick:function(e,t){return N=!0,i("#select-comment").click()},maskClick:function(){return this.closeSelectionUnfold()},docClick:function(){if(this.view.hasClass("selection-unfold"))return this.closeSelectionUnfold()},closeTemp:function(){return this.closeSelectionUnfold()},startComment:function(e,t){var n,o,a;if(!this.comment.hasClass("start-s-comment")&&"document-comment"!==this.comment.attr("comment-mode")&&!this.comment.find(".temp-list").hasClass("only"))return o=i(e.target),a=o.parents(".document-info-li").attr("data-s-guid"),n=this.editContainer.find("."+a),a&&n[0]?(this.repositionBuddle(n),R.showListComment("",[a],"start-comment")):R.showListComment("",[a],"remove"),this.buddleDirtyCheck()}},n.prototype.events={"click .start-comment, .selection-header, .show-comments":"startComment","click .close-temp":"closeTemp","click .list-mask":"maskClick","click #buddle-comment-btn":"sideCommentClick","click #select-comment":"commentBtnClick","click .document-cover":"coverClick","click .comment-buddle":"buddleClick","click #doc-container":"padClick","mouseout .comment-buddle":"buddleMouseOut","mouseover .comment-buddle":"buddleMouseOver","keypress .selection-comment-input":"commentKeyPress","click #innerdocbody":"docClick"},n.prototype.bindWin=function(){var e;return e=this,i(document).on("click",function(t){var n;if(v=window.getSelection().toString(),e.view.hasClass("selection-unfold"))return n=i(t.target),0===n.parents(".document-info-li,.temp-list").length&&"buddle-comment-btn"!==n.attr("id")&&0===n.parents("#buddle-box").length?e.closeSelectionUnfold():void 0}),this.docView.on("scroll",function(t){return e.autoScroll?void(e.autoScroll=!1):!e.view.hasClass("selection-unfold")&&void 0}),i(document).on("tap",".comment-buddle",function(t){return e.bindFun.buddleClick.call(e,t),t.preventDefault()}),i(document).on("keyup",function(){return v=window.getSelection().toString()})},n.prototype.getCommentData=function(){var e,t;return t=[],e=[],i("#innerdocbody .is-commented").each(function(){var n,o;if(o=i(this).attr("class").match(/comment-\w{16}/)[0],-1===t.indexOf(o))return n=l.commentData[o],n?(t.push(o),e.push(n)):void 0}),this.isAndroidApp&&e.forEach(function(e){return e.forEach(function(e){return e.content=e.content.replace(/"/g,"'")})}),{guids:t,comments:e}},n.prototype.newComment=function(){var e,n;if(this,n=t.getSelection(),!(!this.isCursorInEditor(n.selection)||this.noTextInLine(n.selection)&&this.isEtherpadSelectionNoText()))return e={},this.context.ace.callWithAce(function(n){var o,a,r;a=n.ace_getRep(),r=a.selStart[0],o=a.selEnd[0],r<o&&a.selEnd[1]===a.lines.atIndex(o).lineMarker&&(a.selEnd=[o-1,a.lines.atIndex(o-1).text.length]),n.ace_insertHighLight(),f&&(e={guid:f,title:t.cutLength(i("."+f).text(),42)},f="")},"insert-highlight-comment",!0),k?e:e.guid&&"add"===L?a.notify("comment:start",e.guid):void 0},n.prototype.repositionBuddle=function(e){var t,n,o,a;return a=i(document).height(),o=e.position().top,S?(t=o+70+a-this.docView.prop("scrollHeight")+parseInt(this.editor.css("paddingBottom")||0)-document.body.scrollTop,t>0?this.editor.css("paddingBottom",t):this.editor.css("paddingBottom",""),this.docView.scrollTop(o+70)):(n=this.docView.scrollTop(),t=o<120?o-120:o>a-100?o-a+100:0,this.docView.scrollTop(n+t)),this.autoScroll=!0},n.prototype.getOutLineNum=function(e){for(;e.parentNode&&"innerdocbody"!==e.parentNode.id;)e=e.parentNode;return i(e).index()},n.prototype.getFontNode=function(e){for(;e.parentNode.parentNode&&"innerdocbody"!==e.parentNode.parentNode.id&&"li"!==e.parentNode.tagName.toLowerCase();){if(i(e).attr("class")&&i(e).attr("class").indexOf("font-size-")>-1)return;e=e.parentNode}return e},n.prototype.refreshAuthor=function(){return this.view.find(".doc-comment-item").each(function(){var e,t,n;if(e=i(this),n=e.attr("data-user-id"),r.exists(n))return t=r.get(n),e.find(".comment-author").html(t.name),e.find(".comment-avatar img").attr("src",t.avatar)})},n.prototype.commentInLine=function(e,t){var n;return t&&this.buddleList[t]&&this.buddleBox.find('.comment-buddle[data-buddle="'+t+'"]').addClass("hide"),n=this.cutLength-this.docView.scrollTop()+15,this.sideCommentBtn.css({top:e-n}).show()},n.prototype.closeSelectionUnfold=function(){return this.buddleBox.find(".beClick").removeClass("beClick"),this.refreshSelection()},n.prototype.refreshSelection=function(){return C="",this.editContainer.find(".is-commented.active").removeClass("active"),this.hideCover()},n.prototype.resizeWin=function(){return this},n.prototype.showListComment=function(e,t,n){if(this.changeHighLight(e,"show",t),this.coverDocument("buddle",e,t),!k)return this.Comment.createSelectionListArea(e,t,n)},n.prototype.isCursorInEditor=function(e){var t;return!((t=e.focusNode)&&!i(t).parents("#innerdocbody").length)||i(t).hasClass("icon-comment-add")},n.prototype.coverDocument=function(e,t,n){var i;return g=[e,t],i="select"===g[0]?"start-selection-comment":"selection-comment",m=!1,this.changeMode(i)},n.prototype.changeHighLight=function(e,t,n){var o,a,r;return this.editContainer.find(".is-commented.active").removeClass("active"),this,n&&n.length?"show"===t?(C=n,i("."+n[0]).addClass("active")):C="":(o=i(e.target),o.hasClass("comment-buddle")||(o=i(e.target).parent()),a=o.attr("data-buddle"),r=i("."+this.buddleList[a].group.join(", .")),"show"===t?(r.addClass("active"),C=this.buddleList[a].group):(r.removeClass("active"),C=""))},n.prototype.finishComment=function(){return A=""},n.prototype.changeMode=function(e){},n.prototype.getCommentFont=function(e){return e&&e.indexOf("font-size-")>-1?e.match(/font-size-([0-9]+)/)[1]-1:2},n.prototype.isEtherpadSelectionNoText=function(){var e;return e="",this.context.ace.callWithAce(function(t){var n,i,o,a,r,s,l,c;for(o=t.ace_getRep(),s=[o.selStart[0],o.selStart[1]],r=[o.selEnd[0],o.selEnd[1]],n=s[0],a=[];n<=r[0]&&(i=o.lines.atIndex(n),c=i.text,n===s[0]?(l=0===s[0]?i.lineMarker:s[0],e+=c.slice(l,c.length)):n===r[0]?e+=c.slice(i.lineMarker,r[0]):e+=c.slice(i.lineMarker,c.length),e=e.replace(/\s/g,""),!(e.length>0));)a.push(n+=1);return a},"get-selection",!0),!(e.length>0)},n.prototype.noTextInLine=function(e){var n,o,a;return o=e.focusNode,o?"buddle-comment-btn"!==i(o)[0].id&&!!(t.getLineDom(o).textContent.length<1)&&i(t.getLineDom(o)).find(".upload-image").length<1:(n=i("#tempAttachmentStyle"),!(n.length>0)||(a=n.text().match(/attachment-[a-z,A-Z,0-9]{16}/),a=a&&a[0]?a[0]:"",!(i("."+a).length>0)))},n.prototype.buddleDirtyCheck=function(e,t){var n,r,s,l,d,m,h,p,f,g;a.notify("dirtyCheck"),f=this,s=[],f.lineToComments=[],r={},f.buddleList={},p=this.docView.scrollTop(),g=this.cutLength-p+15,l=this.container.find(".is-commented"),f.view.hasClass("selection-unfold")?u=f.view.find(".temp-list .document-info-li").attr("data-s-guid"):k||(u=""),o.each(l,function(e,t){var n,o,a,l,c;if(n=i(e).attr("class"),c=n.match(/comment-([A-Za-z0-9]{16})/)[0],l=f.getCommentFont(n),!0!==r[c])return r[c]=!0,o=f.Comment.commentData[c],a={guid:c,font:l,number:o?o.length:0},s.push(a)}),o.each(s,function(e,t){var n,a,r,s,l;if(n=i(f.container.find("."+e.guid)[0]),r=f.fontList[e.font]*c,n.length>0&&(a=n.offset().top+r,l=null,o.forIn(f.buddleList,function(e,t){if(Math.abs(t-a)<10)return l=f.buddleList[t]}),e.number)){if(!l)return s=f.getOutLineNum(n[0]),f.lineToComments[s]=f.lineToComments[s]||[],f.lineToComments[s].push(a),f.buddleList[a]={num:1,total:e.number,group:[e.guid],min:a,lineNum:s};if(l.group||(l.group=[]),l.group.join("").indexOf(e.guid)<0&&(l.num++,l.total+=e.number,l.group.push(e.guid),a<l.min))return l.min=a}}),f.buddleBoxDomCache||(f.buddleBoxDomCache={}),n=o.clone(f.buddleBoxDomCache),f.buddleBoxDomCache={},m=[],o.forIn(f.buddleList,function(i,o){var a,r,s,l,c,d,h;if(i.total)return r="",s="",i.total>=99&&(i.total="99+"),u&&i.group.toString().indexOf(u)>-1&&(s="beClick"),k||u||e!==i.lineNum||I||(r="active"),t&&t===o&&(""!==r&&(r+=" "),r+="hide"),c='<a class="comment-buddle hicon '+s+" icon-comment "+r+'" title="'+i.group.length+"处标记"+i.total+'处评论" data-buddle="'+o+'" style="top:'+(i.min-g)+'px;" ><span class="comment-buddle-text">'+i.total+"</span></a>",l=n[o],h='<a class="comment-buddle hicon (beClick)? icon-comment (active|hide|active hide)?" title="'+i.group.length+"处标记"+i.total+'处评论" data-buddle="'+o+'" style="top:'+(i.min-g)+'px;" ><span class="comment-buddle-text">'+i.total+"</span></a>",d=new RegExp(h),m.push(o),a=f.buddleBox.find('.comment-buddle[data-buddle="'+o+'"]'),l!==c?l&&l.match(d)&&c.match(d)?a.removeClass("beClick").removeClass("active").removeClass("hide").addClass(s).addClass(r):(a.remove(),f.buddleBox.append(c)):(""!==r&&!a.hasClass(r)||""===r&&(a.hasClass("active")||a.hasClass("hide"))||""===s&&a.hasClass("beClick")||"beClick"===s&&!a.hasClass("beClick"))&&(a.remove(),f.buddleBox.append(c)),f.buddleBoxDomCache[o]=c}),h=[];for(d in n)n[d],o.includes(m,d)?h.push(void 0):h.push(f.buddleBox.find('.comment-buddle[data-buddle="'+d+'"]').remove());return h},n.prototype.commentPushCheck=function(){var t;return t=this,e.bind("Comment",function(e){if(e.data.selection_guid)return setTimeout(function(){return t.buddleDirtyCheck()},100)})},n.prototype.getLineSelects=function(e){var t,n,a;return t=i(e.target).attr("data-buddle"),n=this.buddleList[t].group,i(e.target).data("select-array",n),a={y:0,height:0},o.each(n,function(e,t){var n,o;if(o=i("."+e),0===t&&o[0]&&(a.y=o.offset().top),o.height=o.outerHeight(),o.length>=2&&(n=i(o[o.length-1]),o.height=n.offset().top-i(o[0]).offset().top+n.outerHeight()),o.height>a.height)return a.height=o.height}),a},n.prototype.hideCover=function(e){this.changeMode("document-comment"),m=!0,C=""},n.prototype.updateCommentBtnPosition=function(e){var n,a,r,s,d,u,m,h,p,f,g,y,b,w,C,E,x,_,T,S;if(!e.selStart||!l.isReady)return void this.sideCommentBtn.hide();if(C=t.getSelection(),this.isCursorInEditor(C.selection)){if(y=e.selStart[0],a=i("#innerdocbody").children().eq(y),i(".comment-buddle.hide").removeClass("hide"),a.find(".image-placeholder").length)return void this.sideCommentBtn.hide();if(a.find(".attachment-placeholder").length)return void this.sideCommentBtn.hide();if(E=C.string&&!C.string.replace(/\s/g,"").length,p=C.string&&C.string.replace(/\s/g,"").length,h=v.replace(/\s/g,"").length&&v.length===e.selEnd[1]-e.selStart[1],E)this.sideCommentBtn.hide();else if(p){if(I=!0,w=t.getSelectionPosition(),!(T=window.getSelection().anchorNode))return;if(m=this.getFontNode(T),s=i(m).attr("class"),!(u=this.getCommentFont(s))||!i(m).offset())return;b=i(m).offset().top,f=b-w.y,S=f>-5?b:w.y,r=S+this.fontList[u]*c,_=null,o.forIn(this.buddleList,function(e,t){if(Math.abs(t-r)<10)return _=t}),this.commentInLine(r,_)}else{if(h)return;if(I=!1,y<e.lines.length())if((d=e.lines.atIndex(y))&&d.text)if(x=this,g=this.lineToComments[y],g&&!!g.length&&k)this.sideCommentBtn.hide(),k||o.each(g,function(e){return x.buddleBox.find('.comment-buddle[data-buddle="'+e+'"]').addClass("active")});else{if(n=i(a.find("span")[0]),!n.length)return;s=n.attr("class"),u=this.getCommentFont(s),r=n.offset().top+x.fontList[u]*c,this.commentInLine(r)}else this.sideCommentBtn.hide()}this.buddleDirtyCheck(y,_),this.view.hasClass("selection-unfold")&&this.sideCommentBtn.hide()}},n}(),y.getCommentData=function(){return R.getCommentData()},y.changeActiveGuid=function(e){return u=e,R.buddleDirtyCheck()},y.changeHighLight=function(e){return R.changeHighLight(null,"show",[e])},y.refreshSelection=function(){return R.refreshSelection()},y.newComment=function(){return R.newComment()},y.finishComment=function(){return R.finishComment()},y.commentTop=function(e){var t,n,i;n=R.buddleList;for(i in n)if(t=n[i],-1!==t.group.indexOf(e))return i},y.updateCommentBtnPosition=function(e){return R.updateCommentBtnPosition(e)},y.repositionBuddle=function(e){return R.repositionBuddle(e)},y.showListComment=function(e){return R.showListComment("",[e])},y.postAceInit=function(e,t){if(R)return R.context=t,this.sComment=R},y.aceAttribsToClasses=function(e,t){if("comment"===t.key)return C&&o.each(C,function(e,n){if(t.value.indexOf(e)>-1&&t.value.indexOf("active")<0)return t.value+=" active"}),["is-commented "+t.value]},b=function(){var e,t,n;for(t=17,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=[];t-=1;)n.push(e[parseInt(62*Math.random())]);return n.join("")},T=function(e){var n,a,r,s,c,d,u,m,h,f,g,v,y,b,C;return this,b=e.selStart[0],a=R.view.find("#innerdocbody").children("div:nth-child("+(b+1)+")"),n=a.find(".is-commented"),c=[],s=[],f=e,h=[e.selStart[1],e.selEnd[1]],y="",u=a.text().length<1,C="add",r=t.isMobile()?l.commentData:P,o.each(n,function(e){var t;if(t=e.className.match(/\b\w{7}-\w{16}/),r[t[0]]&&r[t[0]].length)return s.push(e)}),g=t.getSelection(),v=g.string&&!g.string.replace(/\s/g,"").length,v?y=a[0]:e.selStart[0]===e.selEnd[0]&&e.selStart[1]===e.selEnd[1]?s.length>0?(C="position",y=s[0]):y=a[0]:(e.selStart[0]<e.selEnd[0]&&(d=p(f)||b,d!==b&&(s=[],a=R.view.find("#innerdocbody").children("div:nth-child("+(d+1)+")"),n=a.find(".is-commented"),o.each(n,function(e){var t;if(t=e.className.match(/\b\w{7}-\w{16}/),r[t[0]]&&r[t[0]].length)return s.push(e)})),h[0]=f.selStart[1],h[1]=f.selEnd[1]),s.length>0&&(o.each(s,function(e){if(_(e,h))return c.push(e)}),c.length&&(y=c[0],C="position"))),y&&"add"===C&&(m=w(y),h=[m,m+i(y).text().length],f.selStart[1]=h[0],f.selEnd=[e.selStart[0],h[1]]),{rep:f,type:C,dom:y,noText:u}},p=function(e){var t,n,i,o,a,r,s,l,c,d;for(d=e.selStart[0],n=e.selEnd[0],i=o=s=d,l=n;s<=l?o<=l:o>=l;i=s<=l?++o:--o)if(r=e.lines.atIndex(i).lineMarker,a=e.lines.atIndex(i).text.length,c=r,t=a,i===d&&(c=e.selStart[1]),i===n&&(t=e.selEnd[1]),t-c>0)return e.selStart=[i,c],e.selEnd=[i,t],i},_=function(e,t){var n,o;return o=w(e),n=[o,o+i(e).text().length],!(n[1]<=t[0]||n[0]>=t[1])},w=function(e){var t,n,i,o,a;for(i=document.getElementById("innerdocbody"),a="​",t=0;(n=e.parentNode)!==i;)(o=e.previousSibling)?(e=o,t+=O(e).length,O(e)[0]===a&&(t=Math.max(t-1,0))):e=n;return e.firstChild&&x(e.firstChild)&&(t+=1),t},O=function(e){return e.innerText||e.textContent||e.nodeValue||""},x=function(e){var t;return t={div:1,p:1,pre:1,li:1,ol:1,ul:1,inherit:1},!!t[(e.tagName||"").toLowerCase()]},h=function(e){if(e&&e.selStart&&e.selEnd)return this.documentAttributeManager.setAttributesOnRange(e.selStart,e.selEnd,[["comment",""]])},E=function(e,t){var n,o,a,r;if("cancel"===e){if(!t.selStart||!t.selEnd)return;R.finishComment(),this.documentAttributeManager.setAttributesOnRange(t.selStart,t.selEnd,[["comment",""]])}else{if(a=this.rep,!a.selStart||!a.selEnd)return;if(r=T(a),L=r.type,"add"===r.type){if(n="comment-"+b(),f=n,C=[n],o=i("#innerdocbody").find(">div").eq(a.selStart[0]),!o.length)return;if(o.find(".image-placeholder, .attachment-placeholder").length)return;a.selStart[0]===a.selEnd[0]&&a.selStart[1]===a.selEnd[1]&&o.find(".upload-image, .upload-attachment").length&&(a.selEnd[1]+=1),this.documentAttributeManager.setAttributesOnRange(a.selStart,a.selEnd,[["comment",n]]),A={code:n,temp:!0},R.coverDocument("select")}else D(r.dom)}return R.buddleDirtyCheck()},D=function(e){var n;return n=e.className.match(/\b\w{7}-\w{16}/),f=n[0],t.isMobile()?R.showListComment("",n):(M([f]),a.notify("comment:show",f))},M=function(e){if(C=e,i(".is-commented.active").removeClass("active"),C&&C.length)return i("."+C[0]).addClass("active")},y.aceInitialized=function(e,t){var n;n=t.editorInfo,n.ace_insertHighLight=o.bind(E,t),n.ace_cancelComment=o.bind(h,t)},y}.apply(t,a))&&(e.exports=r)}).call(t,n(2),n(1))},544:function(e,t,n){e.exports=function(){n(74).injection.injectEventPluginsByName({TapEventPlugin:n(550)})}},549:function(e,t,n){(function(i,o){var a,r,s=function(e,t){function n(){this.constructor=e}for(var i in t)l.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},l={}.hasOwnProperty;a=[n(33),n(5),n(647),n(733),n(734),n(152),n(194),n(48),n(21),n(69),n(9)],void 0!==(r=function(e,t,n,a,r,l,c,d,u,m,h){var p,f,g,v;return v=u.isRNClient(),g=u.isClient(),p=function(u){function p(){return p.__super__.constructor.apply(this,arguments)}return s(p,u),p.prototype.fetchData=!1,p.prototype.opened=!0,p.prototype.init=function(){if(!window.cow.readonly)return this,this.container=i(".container"),this.infoList=this.$view.find(".document-info-list"),this.tempList=this.$view.find(".temp-list"),this.list=this.$view.find(".comment-list"),this.noTarget=this.tempList.find(".no-target"),this.input=this.$view.find(".comment-input"),this.header=i("#header"),this.editHeading=i("#edit-heading"),this.docView=i("#doc-view"),this.topCut=98,this.btn=i("#comment-btn"),this.createURL="/api/comment/create",this.imgRex="ImAgEuRl/?/iMaGeUrL",this.mentionPop=new n("#comment-mention-pop"),this.commentData={},this.commentCache={},this.editCache={},this.initPush()},p.prototype.commentInit=function(){this.isReady=!1,this.commentData={},this.commentCache={},this.inputHeight=0,this.initComments(),e.getConnectSocket().then(function(){return self.fileGuid=window.cow.currentFile.guid})},p.prototype.domEvents={selectionChange:function(){return this.checkInputEmpty()},selectionPaste:function(e){var t,n;return n=i(e.target),t=n.parents(".document-info-li").attr("data-s-guid"),this.resizeCommentList(t,!0)},selectionKeyUp:function(e){var t,n;return n=i(e.target),t=n.parents(".document-info-li").attr("data-s-guid"),this.setEditCache(t,n.html().trim()),this.resizeCommentList(t)},selectionKeyPress:function(e){var n;if(n=i(e.target),n.parents(".document-info-li").attr("data-s-guid"),e.keyCode===t.keyCodes.ENTER)return!!n.text().trim().length&&(this.createSelectionComments(n),e.preventDefault())},selectionFocus:function(e){return this.inputHeight=i(e.target).height(),this.$view.find(".document-info-li.active").removeClass("active"),i(e.target).parents(".document-info-li").addClass("active"),this.checkInputEmpty()},deleteComment:function(e,t){var n;return n=this,c.show({okCallback:function(){return n.sureDelete(t)},headText:"删除评论",bodyText:"确认要永久删除该评论吗？"})},resendComment:function(e){var t,n,o;return t=i(e.target).parents(".doc-comment-item"),n=t.attr("data-comment-guid"),o=this.commentCache[n],t.addClass("sending").removeClass("sending-error"),this.sendCreatePost(o,t)}},p.prototype.eventMap={"propertychange .selection-comment-input":"selectionChange","input .selection-comment-input":"selectionChange","paste .selection-comment-input":"selectionPaste","keyup .selection-comment-input":"selectionKeyUp","keypress .selection-comment-input":"selectionKeyPress","focus .selection-comment-input":"selectionFocus","click .delete-comment":"deleteComment","click .resend-comment":"resendComment"},p.prototype.initComments=function(){return this.queryComments()},p.prototype.show=function(){this.container.addClass("commentable"),this.queryComments("show")},p.prototype.hide=function(){this.container.removeClass("commentable")},p.prototype.setReady=function(){if(this.isReady=!0,window.cow.isMobile&&!g||this.trigger("ready"),v)return h.notify("document:commentsReady")},p.prototype.sureDelete=function(e){var t,n,o;return this,t=i(e),n=t.parents(".doc-comment-item"),o=n.attr("data-comment-id"),n.addClass("deleting"),i.post("/api/comment/delete/"+o,{},function(e){if(e.code)return n.removeClass("deleting"),console.log("remove comment error"),console.log(e)})},p.prototype.checkInputEmpty=function(){var e,t,n;return n=i(".sidebar-body"),e=n.find(".selection-comment-input"),t=n.find(".input-placeholder"),e.text().length?t.hide():t.show()},p.prototype.setEditCache=function(e,t){return this.editCache[e]=t},p.prototype.queryComments=function(e){var n,i;if(i=this,i.fileGuid=window.cow.currentFile.guid,n=window.cow.currentFile.permissions||{},n.commentable)return this.ajax.get(m.GET_COMMENTS.replace("{%guid%}",i.fileGuid),function(n){var a,r,s,c,u;if(a=0===n.code?n.data:n,u=!g&&i.infoList[0].scrollTop+i.infoList.height()===i.infoList[0].scrollHeight,e)for(i.list.empty(),s=0,c=a.length;s<c;s++)r=a[s],i.format(r);return o.each(a,function(e,n){var a;return a=o.pick(d.get(e.user_id),"avatar","email","name"),o.assign(e,a),e.online=l.isOnline(e.user_id),e.formattedTime=t.DateTime.format(e.created_at),i.handlerSelectionComment.call(i,e)}),u&&i.infoList.scrollTop(i.infoList[0].scrollHeight),i.setReady()})},p.prototype.changeInputBoxShow=function(e){var t;return t=i(e.target).parents(".comment-input-box"),t.hasClass("active")?t.removeClass("active"):t.addClass("active").find("input").focus()},p.prototype.createSelectionComments=function(e){var t,n,i,a;return t=e.html(),e.html("").focus(),i=e.parents(".document-info-li"),n=i.attr("data-s-guid"),a=o.unescape(i.find(".selection-comment-title").attr("data-title")),this.createComments(t,n,a)},p.prototype.createSelectionListArea=function(e,t,n){var a,s;if(s=this,a=t||i(e.target).data("select-array"),a.length>1?(s.tempList.addClass("has-many").removeClass("only"),n="has-many"):s.tempList.addClass("only").removeClass("has-many"),s.resetTempList(),o.each(a,function(e,t){var i,a,c,d;return i=s.commentData[e],d=i?i[0].selection_title:"",s.createSelectionCommentsArea(e,d,n),a=s.tempList.find(".document-info-li[data-s-guid="+e+"]"),c=a.find(".selection-comment-list"),i.length&&a.addClass("has-comment"),o.each(i,function(e,t){return e.online=l.isOnline(e.user_id),e.is_current=+e.user_id==+window.cow.currentUser.id,c.append(o.template(r)(e)),s.addSelectionTitle(a,"",e)}),s.changeSelectionCommentNumber(a)}),setTimeout(function(){return s.tempList.find(".selection-comment-input").off().focus(),s.mentionPop.mentionable(s.tempList.find(".selection-comment-input"))},200),a[0])return s.setCommentBoxPosition(a[0],!0,n)},p.prototype.createSelectionCommentsArea=function(e,n,i){var r,s,l,c,d;return d=n&&n.replace(/\s/g,"").length?n:t.cutLength(this.container.find("."+e).text(),42),c={title:d,type:"s-comment",list_type:i,s_guid:e},r=o.template(a)(c),"has-many"===i?(l=this.tempList.find(".scroll-list"),s=l.length?l:this.tempList.append('<div class="scroll-list"></div>').find(".scroll-list")):(this.tempList.find(".scroll-list").remove(),s=this.tempList),s.append(r),this.mentionPop.mentionable(this.tempList.find(".selection-comment-input")),this.tempList.find(".selection-comment-input").html(this.editCache[e]),this.tempList.find(".document-info-li[data-s-guid="+e+"]")},p.prototype.fixImgSelection=function(e,t){var n,o;if(n=e.find(".selection-comment-title"),o=i("."+t).find("img")[0]||n.find("img")[0],i(o).attr("src"))return n.html("图片评论").attr("data-title",this.imgRex+i(o).attr("src"))},p.prototype.fixAttachmentSelection=function(e,t){var n,o;if(o=e.find(".selection-comment-title"),n=i("."+t).find(".attachment-wrapper"),n.length>0)return o.html("附件评论")},p.prototype.resetTempList=function(){return this.tempList.find(".selection-comment-input").off(),this.tempList.find("li").remove()},p.prototype.changeDeleteTag=function(e){return"remove"===e?this.noTarget.show():this.noTarget.hide()},p.prototype.scrollToBottom=function(){return this.infoList.scrollTop(this.infoList[0].scrollHeight)},p.prototype.setCommentBoxPosition=function(e,t,n){var o,a,r,s,l,c,d,u,m,h,p,f,g,v,y,b;if(e)return this.fixImgSelection(this.tempList,e),this.fixAttachmentSelection(this.tempList,e),o=this.container.find("."+e),a=this.tempList.find(".trangle-box"),p={},m=0,s=0,o.length?(l=o.attr("class"),u=this.getCommentFont(l),m=96*(this.fontList[u]-1.2)/72,s=20,p.top=o.offset().top,a.show()):(p.top=114,a.hide()),v=this.topCut,f=0,b=i(window).height(),this.changeDeleteTag(n),this.tempList.hasClass("has-many")&&this.tempList.find(".document-info-li").length>1?c=this.tempList.find(".scroll-list"):(o.length&&(p.top-=this.scrollSelection(p.top)),c=this.tempList.find(".selection-comment-list"),h=69+this.tempList.find(".comment-input-box").outerHeight(),f=h,"remove"===n&&(f=h+this.noTarget.height())),d=Math.min(Math.max(b-300,400),b-f-v),c.css("max-height",d),r=this.tempList.outerHeight(),g=Math.max(Math.min(p.top-v-r/2,b-v-r-5),1),!this.contentNeedScroll(c)&&!t||this.tempList.hasClass("has-many")||c.scrollTop(c[0].scrollHeight),y=Math.max(p.top+m-s/2-v-g,0),this.tempList.css({top:g}),a.css({top:y})},p.prototype.scrollSelection=function(e){var t,n,o;return n=this.docView.scrollTop(),o=i(document).height(),t=e<120?e-120:e>o-100?e-o+100:0,this.docView.scrollTop(n+t),t},p.prototype.contentNeedScroll=function(e){var t;return t=e||this.tempList.find(".selection-comment-list"),!!t.length&&t[0].scrollTop+t.height()===t[0].scrollHeight},p.prototype.sendCreatePost=function(e,t){var n;return n=this,n.fileGuid=window.cow.currentFile.guid,i.ajax({type:"post",url:this.createURL+"?target_type=file&guid="+n.fileGuid,data:e,dataType:"json",success:function(e){return 0===e.code?n.input.val(""):t.removeClass("sending").addClass("sending-error")},error:function(){return t.removeClass("sending").addClass("sending-error")}})},p.prototype.createComments=function(e,n,a){var s,l,c,u;if(this,u={comment_guid:t.genGuid(),content:e,selection_guid:n,selection_title:a},c=window.cow.currentUser,l={online:!0,created_at:new Date,formattedTime:t.DateTime.format(new Date),name:d.getUserName(c.id),sending:"sending",user_id:c.id,id:"",avatar:c.avatar,is_current:!0,type:n?"s-comment":"w-comment"},l=i.extend(l,u),l.selection_title=o.escape(l.selection_title),s=i(o.template(r)(l)),this.handlerSelectionComment(l,!0,s,"add"),this.infoList.scrollTop(this.infoList[0].scrollHeight),this.sendCreatePost(u,s),this.commentCache[u.comment_guid]=u,n)return this.editCache[n]=""},p.prototype.changeSelectionCommentNumber=function(e,t){var n,i,o;if(t||(t=e),i=e.attr("data-s-guid"),this.commentData[i]&&(n=this.commentData[i].length,o=t.find(".show-comments"),n<1?e.removeClass("has-comment"):e.addClass("has-comment"),o.length))return t.find(".selection-comment-list").attr("data-number",n).parents(".document-info-li").addClass("has-comment"),o.html("查看所有"+n+"条")},p.prototype.handlerSelectionComment=function(e,t,n,i){var a,s,l,c,d,u,m,h;return u=this,e.sending="",s=e.comment_guid,d=e.selection_guid,m=u.$view.find(".sending."+s),m.length?(d&&(e.type="s-comment",u.commentData[d]&&u.commentData[d].length?u.commentData[d].push(e):(u.commentData[d]=[],u.commentData[d].push(e)),a=u.$view.find(".document-info-li[data-s-guid="+d+"]"),u.changeSelectionCommentNumber(a)),m.removeClass("sending").attr("data-comment-id",e.id)):(e.is_current=+e.user_id==+window.cow.currentUser.id,d&&(e.type="s-comment",u.commentData[d]&&u.commentData[d].length?i||u.commentData[d].push(e):(u.commentData[d]=[],i||u.commentData[d].push(e)),l=u.$view.attr("comment-mode"),"document-comment"!==l&&this.checkSelectionOpen(e.selection_guid))?(this.tempList.find(".selection-comment-input").off(),h=u.tempList.find(".document-info-li[data-s-guid="+d+"]"),h.length||(h=u.createSelectionCommentsArea(d,e.selection_title,"temp")),u.addSelectionTitle(h,l,e),(u.contentNeedScroll()||t)&&(c=!0),h.find(".selection-comment-list").append(n||o.template(r)(e)),this.mentionPop.mentionable(this.tempList.find(".selection-comment-input")),u.setCommentBoxPosition(e.selection_guid,c),u.changeSelectionCommentNumber(h)):void 0)},p.prototype.checkSelectionOpen=function(e){var t,n;return n=!1,t=this.tempList.find(".document-info-li"),o.each(t,function(t,o){if(i(t).attr("data-s-guid")===e)return n=!0}),n},p.prototype.addSelectionTitle=function(e,n,o){var a,r;if(a=e.find(".selection-header"),r=a.find(".selection-comment-title"),!a.find(".author").html())return e.find(".comment-avatar.first img").attr("src",o.avatar),a.find(".author").text(o.name),a.find("small").attr("data-time",o.created_at).text(o.formattedTime),r.attr("data-title",o.selection_title).html(o.selection_title),o.selection_title.indexOf(this.imgRex)<0?r.text('"'+t.cutLength(i(r[0]).text(),42)+'"'):r.html("").append('<img src="'+o.selection_title.substr(19,o.selection_title.length)+'" />')},p.prototype.changeFromManyToOnly=function(){var e,t,n,i;if(i=this.tempList.find(".scroll-list"),n=i.children(),1===n.length)return e=this.tempList.find(".selection-comment-list"),i.remove(),t='<div class="comment-input-box"><input class="selection-comment-input" placeholder="回复"></div>',this.tempList.removeClass("has-many").addClass("only").append(n).find(".document-info-li").append(e).append(t).find(".selection-comment-content").remove()},p.prototype.handlerCommentDelete=function(e){var t,n,o;if(this,n=i(".doc-comment-item[data-comment-id="+e.data.id+"]"),t=n.parents(".document-info-li"),o=e.data.selection_guid)return this.tempList.hasClass("has-many")&&0===n.siblings().length?(t.remove(),this.changeFromManyToOnly()):n.remove(),this.removeDelete(o,e)},p.prototype.removeDelete=function(e,t){var n,a,r;return a=this.commentData[e],n=i('.document-info-li[data-s-guid="'+e+'"]'),r=0,o.each(a,function(e,n){if(e.id===t.data.id)return r=n}),a.splice(r,1),this.changeSelectionCommentNumber(n),this.setCommentBoxPosition(e)},p.prototype.updateComments=function(){},p.prototype.initPush=function(){var n;if(t.isMobile())return n=this,e.bind("Comment",function(e){var i;if("create"===e.db_event){if(i=e.data,l.format(e.data),e.data.online=l.isOnline(e.data.user_id),e.data.formattedTime=t.DateTime.format(e.data.created_at),e.data.name=d.getUserName(e.data.user_id),n.handlerSelectionComment.call(n,i),g||n.infoList[0].scrollTop+n.infoList.height()===n.infoList[0].scrollHeight&&n.infoList.scrollTop(n.infoList[0].scrollHeight),"duang"===i.content)return n.duang()}else if("update"===e.db_event)return n.handlerCommentDelete(e)})},p.prototype.duang=function(){var e;return e=i("#pad-view"),e.addClass("duang"),setTimeout(function(){return e.removeClass("duang")},1e3)},p.prototype.resizeCommentList=function(e,t){var n;return n=this.tempList.find(".selection-comment-input").height(),(n!==this.inputHeight||t)&&this.setCommentBoxPosition(e),this.inputHeight=n},p.prototype.resizeContainer=function(){var e,t;e=i("body").width(),t=this.container.width(),this.container.css("left",(e-t)/2)},p}(t.DomModule),f=null,{getInstance:function(e,t){return f||(f=new p(e,t)),f}}}.apply(t,a))&&(e.exports=r)}).call(t,n(2),n(1))},550:function(e,t,n){"use strict";function i(e,t){var n=c.extractSingleTouch(t);return n?n[e.page]:e.page in t?t[e.page]:t[e.client]+d[e.envScroll]}function o(e,t){var n=i(w.x,t),o=i(w.y,t);return Math.pow(Math.pow(n-e.x,2)+Math.pow(o-e.y,2),.5)}var a=n(35),r=n(264),s=n(75),l=n(76),c=n(551),d=n(180),u=n(49),m=a.topLevelTypes,h=r.isStartish,p=r.isEndish,f=function(e){return[m.topTouchCancel,m.topTouchEnd,m.topTouchStart,m.topTouchMove].indexOf(e)>=0},g=10,v=750,y={x:null,y:null},b=null,w={x:{page:"pageX",client:"clientX",envScroll:"currentPageScrollLeft"},y:{page:"pageY",client:"clientY",envScroll:"currentPageScrollTop"}},C=[m.topTouchStart,m.topTouchCancel,m.topTouchEnd,m.topTouchMove],E=[m.topMouseDown,m.topMouseMove,m.topMouseUp].concat(C),x={touchTap:{phasedRegistrationNames:{bubbled:u({onTouchTap:null}),captured:u({onTouchTapCapture:null})},dependencies:E}},k=function(){return Date.now?Date.now:function(){return+new Date}}(),_={tapMoveThreshold:g,ignoreMouseThreshold:v,eventTypes:x,extractEvents:function(e,t,n,a,r){if(f(e))b=k();else if(b&&k()-b<v)return null;if(!h(e)&&!p(e))return null;var c=null,d=o(y,a);return p(e)&&d<g&&(c=l.getPooled(x.touchTap,n,a,r)),h(e)?(y.x=i(w.x,a),y.y=i(w.y,a)):p(e)&&(y.x=0,y.y=0),s.accumulateTwoPhaseDispatches(c),c}};e.exports=_},551:function(e,t){var n={extractSingleTouch:function(e){var t=e.touches,n=e.changedTouches,i=t&&t.length>0,o=n&&n.length>0;return!i&&o?n[0]:i?t[0]:e}};e.exports=n},647:function(e,t,n){(function(i,o){var a,r,s=function(e,t){function n(){this.constructor=e}for(var i in t)l.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},l={}.hasOwnProperty;a=[n(5),n(731),n(732),n(152),n(648)],void 0!==(r=function(e,t,n,a,r){return function(l){function c(){return c.__super__.constructor.apply(this,arguments)}return s(c,l),c.prototype.init=function(){var e;return e=this,this.$view.html(i.template(t)({})),this.inMention=!1,this.maxSearch=6,this.halfMaxSearch=.5*this.maxSearch,this.$resultListView=this.$view.children(".result-list"),this.$placeholder=this.$view.find(".placeholder"),this.docResultList=[],this.userResultList=[],this.allResultList=[],this.placeholderText="在此@同伴或者文档",this.$placeholder.text(this.placeholderText),this.$arrowUp=this.$view.find(">.arrow-up"),this.$arrowDown=this.$view.find(">.arrow-down"),this.docGuid=window.cow.currentFile.guid,this.fileId=window.cow.currentFile.id,this.start=i.debounce(function(e){return function(t){return e.search(t)}}(this),500),o("body").append('<div id="mention-pop-shadow" contenteditable="true"></div'),this.$shadow=o("#mention-pop-shadow"),o(document).on("mousedown",function(t){0===e.$view.has(o(t.target)).length&&e.cancel()})},c.prototype.currentTarget=void 0,c.prototype.currentKeyword="",c.prototype.currentNode=null,c.prototype.currentCursorPosition=0,c.prototype.timer=void 0,c.prototype.eventMap={"mouseenter .mention-result":"mouseEnterResult","click .mention-result":"clickResult","click .placeholder":"stopPropagation","click .down":"stopPropagation"},c.prototype.domEvents={mouseEnterResult:function(e){var t;t=o(e.target),t.hasClass("active")||(this.$resultListView.find("li").removeClass("active"),t.addClass("active"))},clickResult:function(e){return this.create(),e.stopPropagation()},stopPropagation:function(e){return e.stopPropagation()}},c.prototype.mentionList={doc:{},user:{}},c.prototype.mentionable=function(t){var n;return n=this,t instanceof o||(t=o(t)),t.off("click"),t.off("keyup"),t.on("click keyup",function(i){var o,a,r,s,l,c,d,u;(l=i.keyCode)!==e.keyCodes.UP&&l!==e.keyCodes.DOWN&&l!==e.keyCodes.ENTER&&(n.currentTarget=t,s=window.getSelection().getRangeAt(0),u=s.endOffset,a=s.endContainer,n.currentCursorPosition=s.endOffset,n.currentNodeIndex=n.getCurrentNodeIndex(a),r=a.parentNode,"DIV"===a.parentNode.nodeName&&"true"===r.getAttribute("contenteditable")&&"#text"===a.nodeName&&(d=a.nodeValue.slice(0,u).split(/\s+/),o=d[d.length-1],o.indexOf("@")>-1?(c=o.slice(o.lastIndexOf("@")+1),n.start(c)):n.cancel({keyword:c})))}),t.on("keydown",function(t){var i;n.inMention&&((i=t.keyCode)!==e.keyCodes.UP&&i!==e.keyCodes.DOWN||(n.select(t.keyCode===e.keyCodes.UP?"up":"down"),t.preventDefault()),t.keyCode===e.keyCodes.ENTER&&(n.create(),t.preventDefault()))}),t.on("paste",function(e){var n,i;return n=function(e){return e.replace(/(<[\w\W]*?)(style)([\w\W]*?>)/g,function(e,t,n,i){return t+"style_replace"+i})},i=function(e){return o.trim(e.replace(/<\/?((?!a)(\w+))\s*[\w\W]*?>/g,""))},setTimeout(function(){var e;return e=t.html(),e=n(e),e=i(i(e)),t.html(e)},0)})},c.prototype.cancel=function(){if(this.inMention)return this.hide(),this.inMention=!1},c.prototype.show=function(){return this.position(this.currentTarget),this.$view.addClass("active"),this.inMention=!0},c.prototype.hide=function(){return this.$view.removeClass("active"),this.$resultListView.empty(),this.$placeholder.html(this.placeholderText).show(),this.inMention=!1},c.prototype.select=function(e){var t,n,i;n=this.$resultListView.find("li"),"init"===e?n.removeClass("active").first().addClass("active"):(t=this.$resultListView.find("li.active"),t.length>0&&(i=t.attr("data-index"),"down"===e&&i<n.length-1&&t.removeClass("active").next("li").addClass("active"),"up"===e&&i>0&&t.removeClass("active").prev("li").addClass("active")))},c.prototype.create=function(){var e,t,n,i,r,s,l,c,d,u,m,h,p,f,g,v;if(t=this.$resultListView.find("li.active"),0!==t.length)return v={type:t.attr("data-type"),name:t.attr("data-name")},"doc"===v.type&&(v.guid=t.attr("data-guid")),"user"===v.type&&(v.id=t.attr("data-id")),this.currentTarget.focus(),h=this.currentTarget[0].childNodes[this.currentNodeIndex],this.moveCursor(h,this.currentCursorPosition),p=h.parentNode,m=h.nextSibling,i=h.nodeValue,n=i.lastIndexOf("@"),s=this.currentCursorPosition,f=i.slice(0,n),i.slice(n,s),g=i.slice(s),c=document.createTextNode(f+" "),d=document.createTextNode(" "+g),l=document.createElement("a"),e=o(l),"doc"===v.type&&(e.attr("data-file-id",v.id),e.attr("href","/"+v.guid)),"user"===v.type&&(e.attr("href","javascript:void(0);"),u=a.isOnline(v.id),u&&e.addClass("online"),e.attr("data-user-id",v.id),e.attr("contenteditable","false")),e.addClass("mention-"+v.type),l.innerText=l.textContent=v.name,p.insertBefore(c,m),p.insertBefore(l,m),p.insertBefore(d,m),p.removeChild(h),r=d,this.moveCursor(r,1),null===m&&p.insertBefore(document.createElement("br"),m),setTimeout(function(e){return function(){return e.cancel()}}(this),100)},c.prototype.position=function(e){var t,n,i,a,r,s,l,c,d,u,m,h,p,f,g,v,y,b,w,C,E;return p=this,this.$shadow.html(this.currentTarget.html()),["fontSize","width","height","lineHeight","padding","border","outline"].forEach(function(e){return p.$shadow.css(e,p.currentTarget.css(e))}),f=this.$shadow[0],d=f.childNodes[this.currentNodeIndex],c=d.nextSibling,y=d.nodeValue,u=d.parentNode,a=this.currentCursorPosition,n=y.slice(0,a).lastIndexOf("@"),m=y.slice(0,n),h=y.slice(n),r=document.createTextNode(m),s=document.createTextNode(h),v=document.createElement("span"),v.innerText="1",u.insertBefore(r,c),u.insertBefore(v,c),u.insertBefore(s,c),u.removeChild(d),i=o(v).offset(),g=o(".doc-comment-input").offset(),i.top+=g.top+5e3,i.left+=g.left+5e3,g.left-=10,l=+/\d+/.exec(this.$view.css("maxHeight"))[0],b=this.$view.height(),E=this.$view.width(),w=g.left,t=i.left-g.left,t+20>E&&(w+=t-E+20,t-=t-E+20),o(window).height()-g.top<l?(C=i.top-b-25,this.$arrowUp.hide(),this.$arrowDown.show().find("span").css("left",t)):(C=i.top+25,this.$arrowDown.hide(),this.$arrowUp.show().find("span").css("left",t)),this.$view.css({left:w,top:C-50})},c.prototype.search=function(e){if(!(window.cow.currentUser.id<0))return this.mentionStr=e,e?(this.docResultList=[],this.userResultList=[],this.render("result"),function(e){return function(t){return r.searchAll(t,"file,recent_contact,team_member,collaborator",0,6,e.fileId).then(function(n){var o,a,r,s;if(t===e.mentionStr)return e.docResultList=i.get(n,"file.results",[]).map(function(e){return e.source}),a=i.get(n,"recent_contact.results",[]),r=i.get(n,"team_member.results",[]),o=i.get(n,"collaborator.results",[]),e.userResultList=i.unionBy(i.unionBy(a,r,"id"),o,"id"),s=e.userResultList.splice(e.halfMaxSearch),e.docResultList.length>e.halfMaxSearch?e.docResultList.splice(e.maxSearch-e.userResultList.length):e.docResultList.length<e.halfMaxSearch&&s.length>0&&(s.splice(e.halfMaxSearch-docResultList.length),e.userResultList=e.userResultList.concat(s)),e.render("result"),e.select("init")})}}(this)(e)):(this.userResultList=[],this.docResultList=[],this.render("placeholder"))},c.prototype.render=function(e){if(!(window.cow.currentUser.id<0))return this.$resultListView.empty(),"placeholder"===e&&(this.$placeholder.show(),this.$resultListView.hide(),this.show()),"result"===e?(this.$placeholder.hide(),this.userResultList.length||this.docResultList.length?(this.$resultListView.append(i.template(n)({list:this.userResultList})).append(i.template(n)({list:this.docResultList})).show(),this.$resultListView.find("li").each(function(e){return o(this).attr("data-index",e)}),this.show()):this.hide()):void 0},c.prototype.moveCursor=function(e,t,n){var i,o;n=n||this.currentTarget[0],i=document.createRange(),i.selectNodeContents(n),i.setStart(e,t),i.collapse(!0),o=window.getSelection(),o.removeAllRanges(),o.addRange(i)},c.prototype.getCurrentNodeIndex=function(e,t){var n,i,o,a,r;for(r=-1,t=t||this.currentTarget[0],a=t.childNodes,i=n=0,o=a.length;n<o;i=++n)a[i]===e&&(r=i);return r},c}(e.DomModule)}.apply(t,a))&&(e.exports=r)}).call(t,n(1),n(2))},648:function(e,t,n){function i(e){var t=e.apiUrl;return new Promise(function(n,i){(0,l.ajaxPost)(t,(0,c.omit)(e,"apiUrl")).then(function(e){0===e.code?n(e.data):e&&void 0===e.code?n(e):i(new Error(e.message))},function(e){i(e)})})}function o(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"file,recent_contact,team_member,collaborator",n=arguments[2],o=arguments[3],a=arguments[4];return i({apiUrl:d.SEARCH_ALL,keyword:e,type:t,page:n,pageSize:o,fileId:a})}function a(e,t,n){return i({apiUrl:d.SEARCH_FILES,keyword:e,page:t,pageSize:n})}function r(e,t,n){return i({apiUrl:d.SEARCH_RECENT_CONTACTS,keyword:e,page:t,pageSize:n})}function s(e,t,n){return i({apiUrl:d.SEARCH_TEAM_MEMBERS,keyword:e,page:t,pageSize:n})}Object.defineProperty(t,"__esModule",{value:!0}),t.searchAll=o,t.searchFiles=a,t.searchRecentContacts=r,t.searchTeamMembers=s;var l=n(22),c=n(1),d=n(69);t.default={searchAll:o,searchFiles:a,searchRecentContacts:r,searchTeamMembers:s}},662:function(e,t,n){(function(i){var o,a;o=[n(5),n(9)],void 0!==(a=function(e,t){var n,o,a,r,s;return a={},s=i("#pad-view"),a.postAceInit=function(e,n){var o;return o=this,i(".doc-sidebar-close").off().on("click",function(e){return o.closeSidebar(e)}),t.attach("comment:show",function(){if(!s.hasClass("comment-show"))return r()})},r=function(){return s.addClass("comment-show").removeClass("history-show"),n(),o()},o=function(){return t.notify("doc:history:hide"),t.notify("history:toggle")},n=function(){return s.removeClass("directory-show"),i("#doc-directory").addClass("hide"),window.cow.directory.isOpened=!1,t.notify("doc:directory:hide")},a.closeSidebar=function(e){return o(),n(),s.removeClass("history-show")},a}.apply(t,o))&&(e.exports=a)}).call(t,n(2))},703:function(e,t){e.exports="<% if (list.guid) {%>\n    <% if (list.content) {%>\n        span.<%= classTag %>-placeholder.<%= list.guid%> .upload-loading-block .upload-loading-info::before {\n            content: '<%= list.content %>'!important;\n        }\n    <% }%>\n    .<%= classTag %>-placeholder.<%= list.guid%> .upload-progress-bar{\n        width: <%= list.percentVal%>!important;\n    }\n<% }%>\n"},731:function(e,t){e.exports='<div class="arrow-up">\n  <span class="top"></span>\n  <span class="down"></span>\n</div>\n<div class="arrow-down">\n  <span class="top"></span>\n  <span class="down"></span>\n</div>\n<ul>\n  <li class="placeholder">@朋友或者文档</li>\n</ul>\n<ul class="result-list">\n</ul>'},732:function(e,t){e.exports='<% _.each(list, function (data, index) { %>\n\t\t<li class="mention-result" data-guid="<%= data.guid %>" data-name="<%= data.name %>" data-id="<%= data.id %>" data-type="<% data.guid ? print(\'doc\') : print(\'user\') %>">\n\t\t\t<% if (!data.guid){ %>\n\t\t\t\t<img class="avatar" src="<%= data.avatar %>"><%= data.name %>\n\t\t\t<% } else { %>\n        <% if (data.type === \'folder\') {%>\n            <span class="file-sprite file-folder-icon mention-icon"></span>\n        <% } else if (data.type === \'document\' || data.type === \'newdoc\') { %>\n            <span class="file-sprite file-doc-icon mention-icon"></span>\n        <% } else if (data.type === \'sheet\' || data.type === \'spreadsheet\') { %>\n            <span class="file-sprite file-spreadsheet-icon mention-icon"></span>\n        <% } %>\n\t\t\t\t<%= data.name %>\n\t\t\t<% } %>\n\t\t</li>\n<% }) %>\n\n'},733:function(e,t){e.exports='<li class="document-info-li <%= type%>"  data-s-guid="<%= s_guid%>">\n    <%if(list_type === \'info\' || list_type === \'has-many\'){%>\n        <div class="selection-header">\n            <div class="selection-comment-title" data-title="<%- title%>"></div>\n        </div>\n        <div class="selection-comment-content">\n            <ul class="selection-comment-list" data-number="">\n            </ul>\n            <div class="comment-input-box">\n                <input class="selection-comment-input" placeholder="评论"></input>\n                <div class="input-box-footer">\n                    <a href="javascript:void(0);" class="show-comments">所有评论</a>\n                    <span class="start-comment"><span class="hicon icon-comment-add"></span>评论</span>\n                </div>\n            </div>\n        </div>\n        <img class="shadow-img" src="https://assets-cdn.shimo.im/assets/images/shadow-3c0f519ff8.png"></img>\n    <%}else{%>\n        <div class="selection-header">\n            <div class="selection-comment-title" data-title="<%- title%>">"<%- title%>"</div>\n        </div>\n        <ul class="selection-comment-list" data-number="">\n        </ul>\n        <div class="comment-input-box">\n            <div class="input-placeholder">按Enter键发送</div>\n            <div class="selection-comment-input editable mousetrap" placeholder="评论" contenteditable="true"></div>\n        </div>\n    <%}%>\n</li>\n'},734:function(e,t){e.exports='<li data-user-id="<%= user_id %>" data-comment-id="<%= id %>" class="doc-comment-item <%= comment_guid%> <%= sending %> <%= is_current? \'current-user\':\'\'%> <%= type == \'w-comment\' ? \'document-info-li w-comment\' : \'\'%> <%= online?\'online\':\'\' %>" <% if (sending) { %> data-comment-guid="<%= comment_guid %>"<% } %>>\n    <div class="comment-avatar">\n        <img class="comment-avatar-img" src="<%= avatar %>"/>\n        <span class="comment-online-circle online-circle"></span>\n    </div>\n    <div class="comment-body">\n        <div class="comment-info">\n            <span class="comment-author"><%= name %></span>\n            <small class="comment-item-time" data-time="<%= created_at %>"><%= formattedTime %></small>\n        </div>\n        <div class="comment-content"><%= content%></div>\n    </div>\n    <% if (is_current) { %>\n        <a href="javascript:void(0);" class="fun delete-comment icon-box">\n            <span class="delete-comment-icon hicon icon-trash-delete"></span>删除\n        </a>\n        <span class="fun deleting-comment">删除中...</span>\n    <% } %>\n    <% if (sending) { %>\n        <span class="fun sending-comment">发送中...</span>\n        <a href="javascript:void(0);" class="fun resend-comment icon-box">\n            <span class="resend-comment-icon hicon icon-refurbish"></span>重发\n        </a>\n        <span class="comment-error-span error-span icon-box">\n            <span class="comment-error-icon hicon icon-remind"></span>发送失败\n        </span>\n    <% } %>\n</li>\n'},735:function(e,t,n){var i;void 0!==(i=function(){return function(e){function t(t){var n=t.onselectionchange;if(n!==e)try{return t.onselectionchange=0,null===t.onselectionchange}catch(e){}finally{t.onselectionchange=n}return!1}function n(){return"undefined"!=typeof WeakMap?new WeakMap:(console.error("selectionchange: WeakMap not supported"),null)}function i(e){var t=e.getSelection();return t.rangeCount?t.getRangeAt(0):null}function o(e,t,n){e.addEventListener(t,n,!0)}function a(e,t,n){e.removeEventListener(t,n,!0)}function r(e){b[e.target.tagName]||m(this,!0)}function s(e){var t=e.keyCode;(65===t&&e[v]&&!e.shiftKey&&!e.altKey||t>=37&&t<=40||e.ctrlKey&&f&&g.indexOf(t)>=0)&&(b[e.target.tagName]||setTimeout(m.bind(null,this),0))}function l(e){0===e.button&&(o(this,"mousemove",c),setTimeout(m.bind(null,this),0))}function c(e){1&e.buttons?m(this):a(this,"mousemove",c)}function d(e){0===e.button?setTimeout(m.bind(null,this),0):a(this,"mousemove",c)}function u(){setTimeout(m.bind(null,this.document),0)}function m(e,t){var n=i(e);!t&&h(n,p.get(e))||(p.set(e,n),setTimeout(e.dispatchEvent.bind(e,new Event("selectionchange")),0))}function h(e,t){return e===t||e&&t&&y.every(function(n){return e[n]===t[n]})}var p,f=/^Mac/.test(navigator.platform),g=[65,66,69,70,78,80],v=f?"metaKey":"ctrlKey",y=["startContainer","startOffset","endContainer","endOffset"],b={INPUT:1,TEXTAREA:1};return{start:function(e){var a=e||document;(p||!t(a)&&(p=n()))&&(p.has(a)||(p.set(a,i(a)),o(a,"input",r),o(a,"keydown",s),o(a,"mousedown",l),o(a,"mousemove",c),o(a,"mouseup",d),o(a.defaultView,"focus",u)))},stop:function(e){var t=e||document;p&&p.has(t)&&(p.delete(t),a(t,"input",r),a(t,"keydown",s),a(t,"mousedown",l),a(t,"mousemove",c),a(t,"mouseup",d),a(t.defaultView,"focus",u))}}}()}.call(t,n,t,e))&&(e.exports=i)},736:function(e,t,n){(function(i,o){var a,r,s=function(e,t){function n(){this.constructor=e}for(var i in t)l.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},l={}.hasOwnProperty;a=[n(33),n(5),n(179),n(737),n(89),n(21)],void 0!==(r=function(e,t,n,a,r,l){return function(e){function c(){return c.__super__.constructor.apply(this,arguments)}return s(c,e),c.prototype.init=function(){var e,n,i,o;if(this.registerPendingAction("/api/file/copy",{guid:window.cow.tempCurrentFile.guid,source_url:window.location.href},this.saveSharedDocAsCopy),window.cow.currentUser.id<0&&"editable"===l.getShareMode()){if(e=window.cow.currentFile.guid,o=window.localStorage.getItem("visitedAnonymousDocGuids"),void 0!==o&&null!==o||(o=""),i=".*,"+e+",.*",n=new RegExp(i),n.test(o)&&r.get("Anonymous-"+e)&&!t.isMobile())return void this.showSaveDocDialog();if(!n.test(o)&&!t.isMobile())return o=","+e+","+o,window.localStorage.setItem("visitedAnonymousDocGuids",o),r.set("Anonymous-"+e,!0,{expires:1}),this.showSaveDocDialog()}},c.prototype.eventMap={"click .save-to-shimo-link":"saveSharedDoc","click .save-to-shimo-btn":"saveSharedDoc","click .goto-desktop-btn":"gotoDesktop","click .login-write-btn":"gotoLogin","click .stay-here-btn":"hideSaveDocDialog","click .save-doc-dialog-close":"hideSaveDocDialog","touchmove .flat-dialog-mask":"stopPropagation","click .flat-dialog-mask":"stopPropagation"},c.prototype.domEvents={stopPropagation:function(e){return e.stopPropagation(),e.preventDefault(),!1},saveSharedDoc:function(e){if(window.cow.currentUser.id<0&&"editable"===l.getShareMode()&&!t.isMobile()?this.showSaveDocDialog():this.saveSharedDocAsCopy.call(this,this.pendingAction.data.url,this.pendingAction.data.data),window.ga)return window.ga("send","event","save","save_to_shimo",location.pathname)},gotoDesktop:function(e){if(window.location.href="/desktop",!t.isMobile())return i("body").removeClass("overflow-hidden")},gotoLogin:function(e){var n;if(e.stopPropagation(),n="/login",(t.isWechat()||t.isWechatPc())&&(n+="?need_auto_login=true"),window.location.href=n,!t.isMobile())return i("body").removeClass("overflow-hidden")},hideSaveDocDialog:function(e){var n;if(e.stopPropagation(),n=this,this.$saveDocDialog.css("opacity",0),setTimeout(function(){return n.$saveDocDialog.removeClass("active")},200),!t.isMobile())return i("body").removeClass("overflow-hidden")}},c.prototype.initSaveDocDialog=function(){var e,n;return n={isMobile:t.isMobile(),readonly:!!window.cow.readonly,docTitle:window.cow.currentFile.name,shareCount:window.cow.currentFile.share_count},e=o.template(a)(n),i(".save-doc-dialog").remove(),i("body").append(e),this.$saveDocDialog=i(".save-doc-dialog")},c.prototype.showSaveDocDialog=function(){var e;return this.initSaveDocDialog(),e=this,this.$saveDocDialog.addClass("active"),setTimeout(function(){return e.$saveDocDialog.css("opacity",1)},0),t.isMobile()||i("body").addClass("overflow-hidden"),setTimeout(function(){return i("#innerdocbody").blur()},200)},c.prototype.saveSharedDocAsCopy=function(e,n){var i;return i=this,window.cow.currentFile.guid,window.cow.currentUser.id<0?void(window.location.href="/register"):t.post(e,n,function(e){return 0===e.code?i.showSaveDocDialog():i.alertMsg("保存失败","error")},function(e){return setTimeout(function(){return i.alertMsg("保存失败","error")},500)})},c.prototype.alertMsg=function(e,i){return t.isMobile()?n(e):t.alert({title:e,type:i})},c}(t.DomModule)}.apply(t,a))&&(e.exports=r)}).call(t,n(2),n(1))},737:function(e,t){e.exports='<div class="flat-dialog-wrapper save-doc-dialog">\n    <div class="flat-dialog-mask">\n        <div class="flat-dialog-content">\n            <div class="save-doc-title">\n                <span>「<%= docTitle %>」</span>\n            </div>\n            <div class="doc-share-info">\n                <span><%= shareCount + 1 %>人正在协作编辑此文档</span>\n            </div>\n            <div class="login-write-btn flat-dialog-btn">\n                <span>登录并参与协作</span>\n            </div>\n            <div class="stay-here-btn">\n                <span>匿名编辑</span>\n            </div>\n        </div>\n    </div>\n</div>'},738:function(e,t,n){(function(i){var o,a;o=[n(77),n(9)],void 0!==(a=function(e,t){var n,o,a,r,s;return r=[".header-back-up",".sm-share-btn",".operation-btn",".account-setting-btn",".message-box",".toolbar-upload-file-input","#select-comment"],s=["table"],a=["#pad-back-btn","#mobile-more-btn",".toolbar-upload-file-input"],n=function(){if(!window.cow.client)return window.cow.isMobile?a.forEach(function(e){return i(e).on("tap",!1)}):r.forEach(function(e){return i(e).on("click",!1)}),"doc"===window.cow.pageType?s.forEach(function(e){if(e=window.padeditbar.getItem(e))return e.setEnable(!1)}):void 0},o=function(){if(window.cow.isMobile?a.forEach(function(e){return i(e).off("tap",!1)}):r.forEach(function(e){return i(e).off("click",!1)}),"doc"===window.cow.pageType)return s.forEach(function(e){if(e=window.padeditbar.getItem(e))return e.setEnable(!0)})},t.attach("socket:disconnected",function(){return n()}),t.attach("socket:reconnected",function(){return o()})}.apply(t,o))&&(e.exports=a)}).call(t,n(2))},739:function(e,t,n){(function(n,i){function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=function(){function e(t,n){o(this,e),this.type=null,this.options=null,this.enabled=null,this.timer=null,this.$element=null,this.init("tooltip",t,n)}return a(e,[{key:"init",value:function(e,t,i){this.enabled=!0,this.type=e,this.$element=n(t),this.options=this.getOptions(i);var o=this.options.trigger;if("click"===o)this.$element.on("click."+this.type,this.options.selector,function(){n.proxy(this.generate,this)});else if("manual"!==o){var a="hover"===o?"mouseenter":"focusin",r="hover"===o?"mouseleave":"focusout",s=this;setTimeout(function(){s.$element.on(a+"."+s.type,s.options.selector,function(){s.generate()})},0),this.options.isautohide&&(this.$element.on(r+"."+this.type,this.options.selector,n.proxy(this.destroy,this)),this.$element.on("click."+this.type,this.options.selector,n.proxy(this.destroy,this)))}}},{key:"getDefaults",value:function(){return e.DEFAULTS}},{key:"getOptions",value:function(e){return e=i.assign({},this.getDefaults(),e),e.delay&&"number"==typeof e.delay&&(e.delay={show:e.delay,hide:e.delay}),e}},{key:"popup",value:function(){this.generate()}},{key:"popdown",value:function(){this.destroy()}},{key:"hasContent",value:function(){var e=this.$element.data("content");return e||!1}},{key:"show",value:function(){var e=this.tip();if(!this.hasContent())return!1;e.addClass(this.options.placement).find(".smtooltip-inner").html(this.hasContent()),n("body").hasClass("smtooltip")||n("body").append(e)}},{key:"generate",value:function(){clearTimeout(this.timer);var e=this.$element.height(),t=null,i=null,o=0,a=0;switch(this.show(),this.hasContent()&&(t=this.tip().outerWidth(!0),i=this.tip().outerHeight()),this.options.placement){case"top":o=Math.round(this.$element.offset().top-n(window).scrollTop()+e+10),a=Math.round(this.$element.offset().left+this.$element.outerWidth()/2-n(window).scrollLeft()-t/2);break;case"bottom":o=Math.round(this.$element.offset().top-n(window).scrollTop()-this.tip().outerHeight()-e-10),a=Math.round(this.$element.offset().left+this.$element.outerWidth()/2-n(window).scrollLeft()-t/2);break;case"right":o=Math.round(this.$element.offset().top+this.$element.outerHeight()/2-n(window).scrollTop()-i/2),a=Math.round(this.$element.offset().left+this.$element.outerWidth()-n(window).scrollLeft()+10);break;case"left":o=Math.round(this.$element.offset().top+this.$element.outerHeight()/2-n(window).scrollTop()-i/2),a=Math.round(this.$element.offset().left-n(window).scrollLeft()-t-10)}this.tip().css({top:o,left:a})}},{key:"destroy",value:function(){var e=this;e.timer=setTimeout(function(){e.tip().remove()},30)}},{key:"tip",value:function(){return this.$tip=this.$tip||n(this.options.template)}}]),e}();r.DEFAULTS={isautohide:!0,placement:"top",selector:"",template:'<div class="smtooltip"><div class="smtooltip-inner"></div></div>',html:!1,trigger:"hover",container:!1},t.default=r,e.exports=t.default}).call(t,n(2),n(1))},740:function(e,t,n){(function(e){function i(e){return e&&e.__esModule?e:{default:e}}function o(){v.authorized||(y.id>0?(d.default.render(l.default.createElement(m.default,{currentUser:y}),e("#avatar")[0]),d.default.render(l.default.createElement(p.default,{currentFile:v,currentUser:y}),e(".mark-star-container")[0])):v.teamId&&g.default.isMobile()?d.default.render(l.default.createElement(p.default,{currentFile:v,currentUser:y}),e(".favorite-btn-wrap")[0]):d.default.render(l.default.createElement(p.default,{currentFile:v,currentUser:y}),e(".mark-star-wrap")[0]),a())}function a(){"undefined"!==w&&null!==w||(w="");var t=".*"+b+".*";new RegExp(t).test(w)||(w+=b+",",window.localStorage.setItem("visitedDocGuids",w),e(".editable-hint").animate({bottom:"20px"},"linear",r()))}function r(){e(window).click(function(){e(".editable-hint").animate({bottom:"-44px"},"linear")})}Object.defineProperty(t,"__esModule",{value:!0}),t.renderStarFileComponent=o;var s=n(0),l=i(s),c=n(13),d=i(c),u=n(330),m=i(u),h=n(331),p=i(h),f=n(5),g=i(f),v=window.cow.currentFile=window.cow.tempCurrentFile,y=window.cow.currentUser,b=v.guid,w=window.localStorage.getItem("visitedDocGuids")}).call(t,n(2))},854:function(e,t,n){(function(i,o,a){var r,s,l=function(e,t){function n(){this.constructor=e}for(var i in t)c.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},c={}.hasOwnProperty;r=[n(5),n(179),n(703),n(200),n(863),n(9),n(178),n(194),n(147)],void 0!==(s=function(e,t,n,r,s,d,u,m,h){var p,f,g,v,y,b,w,C,E,x,k,_,T,S,I,N,L,O,P,D,M;return v={},k={uploadFailed:"上传失败, 请上传 jpg / jpeg / png / gif 格式图片",uploadSuccess:"上传成功"},x=610,y=[],D="#tempImageResizeStyle",p=function(t){function p(){return p.__super__.constructor.apply(this,arguments)}return l(p,t),p.prototype.init=function(){this.bindWindowEvents(),d.attach("doc:goback",i.bind(this.cancelAllUpload,this))},p.prototype.reset=function(t){var n,r;if(this.brokenImagesGuids=[],this.listenToCheckBrokenImage(),void 0!==t&&null!==t&&void 0!==t.context&&null!==t.context&&(this.context=t.context),y=[],this,this.maxFileSize=h.initLimition().fileSize,this.allowedExtensions=["png","gif","jpg","jpeg"],this.addSpecialCss(),this.$padView=o("#innerdocbody"),this.$editorContainer=o("#editorcontainer"),this.$copyContainer=o(".copy-container"),this.isMac=e.isMac(),this.clearRemainingPlaceholder(),n="",this.allowedExtensions.forEach(function(e){return""!==n&&(n+=", "),n+="image/"+e}),r={isMultiple:!0,title:"上传图片",accept:n},e.isMobile()&&(r.width=45,r.height=45),this.$galleryBox=o("#gallery-box"),this.initializeUploadImage().createOpacityFormInside("#image-upload-button",r),this.isMovingImage=!1,this.uploadList=[],this.$progressTag=o("#progress-style"),this.dragEnterCounter=0,this.$currentEditingImage=o(),this.currentEditingImageSelector="",this.$isResizing=!1,this.$tempStyleDom=o(),this.needHideCaret=!1,this.clickOther=!1,this.$menuLeftBar=o(".menu_left"),this.firstIntoDoc=!0,this.maxImageWidth=x=this.$padView.find(">div:first").width()-3,e.isMobile()&&["doc","spreadsheet","sheet"].indexOf(cow.pageType)>-1&&u.init(),e.isMobile()||window.cow.readonly||d.attach("caret:change",i.bind(this.listenCaretChange,this),{isAsync:!1}),document.execCommand&&a.mozilla)return document.execCommand("enableObjectResizing",!1,"false")},p.prototype.bindWindowEvents=function(){return o(window).on("beforeunload",function(){if(y.length>0)return"确认要离开页面吗？离开后您正在上传的图片将无法保存"}),o(window).on("unload",i.bind(this.cancelAllUpload,this))},p.prototype.cancelAllUpload=function(){var e,t,n,i,a,r,s,l;if(0!==y.length){for(t={},this.$padView.find(".image-placeholder").each(function(){var e,n,i;if(e=o(this).parents("div[id^=magicdom]"),n=e.find(".image-placeholder").attr("class"),i=n.match(/placeholder-[a-z,A-Z,0-9]{16}/),i=i&&i[0]?i[0]:"")return t[i]=e}),l=null,a=0,r=y.length;a<r;a++)i=y[a],t.hasOwnProperty(i.guid)&&(e=t[i.guid],n=e.index("#innerdocbody>div"),e.remove(),s=o("#innerdocbody>div")[n],this.context.ace.callWithAce(function(e){if(s)return e.ace_observeChangesAroundNode(s),e.ace_fastIncorp(1,"call")},"delete-image-placeholder",!0)),i.abortUpload&&(l=i);return y.length=0,l?l.abortUpload():void 0}},p.prototype.clearRemainingPlaceholder=function(e){var t,n,i,a;return a=this,i=function(e){var t;if((t=e.index("#innerdocbody>div"))>-1)return a.context.ace.callWithAce(function(e){return e.ace_doRemoveOldLine(t)},"delete-image-placeholder",!0)},e&&(n=o("."+e),t=n.closest("div[id^=magicdom]"),i(t)),this.$padView.find(".image-placeholder").each(function(){return t=o(this).parents("div[id^=magicdom]"),i(t)})},p.prototype.eventMap={"click .image-placeholder .upload-remove-media":"cancelUpload","dragstart .upload-image":"prepareDragging","dragover #innerdocbody>div":"handleDrag","drag #innerdocbody>div":"handleDrag","drop #innerdocbody":"handleDrop","dragend .upload-image":"cleanDragOverStyle","paste #innerdocbody":"handlePaste","dragstart .image-resize-bar":"stopPropagation","mousedown .image-resize-bar":"startImageResize","mousemove body":"doingImageResize","mouseup body":"doneImageResize","imageredraw #innerdocbody":"onImageRedraw","click body":"onImageClick","keydown body":"onSelectedImageKeydown"},p.prototype.domEvents={cancelUpload:function(e,t){var n,a,r,s,l,c;return n=o(t).parents("div[id^=magicdom]"),a=n.find(".image-placeholder").attr("class"),a&&(r=a.split(" "),l=r.indexOf("image-placeholder")+1,s=r[l],c=null,s&&i.remove(y,function(e){return e.guid===s&&(!e.abortUpload||(c=e,!1))}),c&&"function"==typeof c.abortUpload&&c.abortUpload()),n.remove()},onImageClick:function(e,t){var n,i;if(this.isInDocbody(e.target))"IMG"===e.target.tagName?(this.selectImage(e.target),this.moveCaretToImageLine()):this.clearSelected(),this.clickOther=!1,this.firstIntoDoc=!1;else{if(!(this.$menuLeftBar.has(e.target).length>0))return this.clearSelected(),this.clickOther=!0;if(n=o(e.target).closest("li[data-key]").attr("data-key")||"",i="bold,italic,underline,insertorderedlist,insertunorderedlist,checklist,indent,outdent",-1===i.indexOf(n))return this.clearSelected(),this.clickOther=!0}},startImageResize:function(e,t){return this.isResizing=!0,this.resizeStartPoint={x:e.clientX,y:e.clientY},this.imageOriginSize={width:this.$currentEditingImage.width(),height:this.$currentEditingImage.height()}},doingImageResize:function(e,t){var n,i,o,a;if(this.isResizing)return this.$editorContainer.hasClass("disable-select")||this.$editorContainer.addClass("disable-select"),o=e.clientX-this.resizeStartPoint.x,a=e.clientY-this.resizeStartPoint.y,Math.abs(o)/Math.abs(a)>=this.imageOriginSize.width/this.imageOriginSize.height?(i=this.imageOriginSize.width+o,n=this.imageOriginSize.height*i/this.imageOriginSize.width):(n=this.imageOriginSize.height+a,i=this.imageOriginSize.width*n/this.imageOriginSize.height),i<50&&(i=50,n=this.imageOriginSize.height*i/this.imageOriginSize.width),i>=this.maxImageWidth&&(i=this.maxImageWidth,n=this.imageOriginSize.height*i/this.imageOriginSize.width),this.dynamicChangeImageSizeWhenMove({width:i,height:n}),this.repositionResizeBar(),this.stopPropagation(e)},doneImageResize:function(e,t){var n,a,r,s;if(this.isResizing)return this.$editorContainer.removeClass("disable-select"),this.isResizing=!1,this.$currentEditingImage=o(this.currentEditingImageSelector),n=this.$currentEditingImage.parents("div[id^=magicdom]"),s=this.$currentEditingImage.width(),r=this.$currentEditingImage.height(),a=this.currentEditingImageSelector.match(/img-([0-9A-Za-z]{16})/),a=a&&a[1]?a[1]:"",i.includes(this.brokenImagesGuids,a)||this.context.ace.callWithAce(function(e){return e.ace_resizeImage(e,n,{width:s,height:r})},"resizeImage",!0),this.$currentEditingImage=o(this.currentEditingImageSelector),this.dynamicChangeImageSizeWhenMove(this.currentEditingImageSelector),this.stopPropagation(e)},onImageRedraw:function(e,t){var n;return n=this,this.needHideCaret=!0,setTimeout(function(){return n.$currentEditingImage=o(n.currentEditingImageSelector),n.repositionResizeBar()},10)},onSelectedImageKeydown:function(t,n){var i,a,r,s,l,c,d;if(d=this,l=o("#pad-view").hasClass("selection-unfold"),o(D).length>0&&!l&&!this.$galleryBox.hasClass("modal")){if(a=this.$currentEditingImage.parents("div[id^=magicdom]"),r=o("#innerdocbody div[id^=magicdom]"),s=r.index(a[0]),8==+t.keyCode||46==+t.keyCode)return this.context.ace.callWithAce(function(e){var n,i,o;if(a.length>0){if(e.ace_doRemoveOldLine(s),e.ace_getLineListType(s+1)&&e.ace_getLineListType(s)&&e.ace_renumberList(s+1),o=e.ace_getRep(),d.setDocEditable(!0),e.ace_activeCaret(),0===s)return o.selEnd=[0,0],o.selStart=[0,0];if(8==+t.keyCode)return n=o.lines.atIndex(s-1),i=n.lineMarker+n.text.length,o.selEnd=[s-1,i],o.selStart=[s-1,i];if(46==+t.keyCode)return o.selEnd=[s,0],o.selStart=[s,0]}},"delete-selected-image",!0),this.clearSelected(),this.stopPropagation(t);if(32==+t.keyCode)return this.stopPropagation(t);if(13==+t.keyCode)return this.context.ace.callWithAce(function(t){var n,i,o;return t.ace_performDocumentReplaceRangeWithAttributes([s+1,0],[s+1,0],"\n",[]),(i=t.ace_getLineListType(s-1))&&(n=/[a-z]+([123456789])/.exec(i),t.ace_performDocumentReplaceRangeWithAttributes([s+1,0],[s+1,0],"*",[["author",t.ace_getAuthor()],["list","indent"+(n?n[1]:"1")],["lineguid",e.genGuid()]])),d.setDocEditable(!0),t.ace_activeCaret(),o=t.ace_getRep(),o.selStart=o.selEnd=[s+1,0]},"insert-line",!0),this.repositionResizeBar(),this.stopPropagation(t);if(38==+t.keyCode||40==+t.keyCode)return this.context.ace.callWithAce(function(e){var n,i;return d.setDocEditable(!0),e.ace_activeCaret(),i=s+(38==+t.keyCode?-1:1),n=e.ace_getRep(),n.selStart=n.selEnd=[i,0],a.next().focus()},"move-caret",!0),this.stopPropagation(t);(this.isMac&&t.metaKey||!this.isMac&&t.ctrlKey)&&(i=this.$currentEditingImage.clone(),c=this.$currentEditingImage.offset(),this.$copyContainer.css("top",c.top+"px"),d=this,setTimeout(function(){var e,t;return d.$copyContainer.empty().append(i).focus().select(),e=document.createRange(),e.setStartBefore(i.first()[0]),e.setEndAfter(i.last()[0]),t=window.getSelection(),t.removeAllRanges(),t.addRange(e)},0),88==+t.keyCode&&(a=this.$currentEditingImage.parents("div[id^=magicdom]"),r=o("#innerdocbody div[id^=magicdom]"),s=r.index(a[0]),this.context.ace.callWithAce(function(e){if(a.length>0&&(e.ace_doRemoveOldLine(s),e.ace_getLineListType(s+1)&&e.ace_getLineListType(s)))return e.ace_renumberList(s+1)},"delete-selected-image",!0)))}if(this.$galleryBox.hasClass("modal"))return t.stopPropagation(),t.preventDefault(),!1},stopPropagation:function(e,t){return e.stopPropagation(),e.preventDefault(),!1},prepareDragging:function(e,t){var n;return window.cow.readonly?this.stopPropagation(e):(n=o(t).attr("class").match(/img-[0-9A-Za-z]{16}/),n&&(this.originImgGuid=n[0]),this.dropDirection="original",this.isMovingImage=!0,this.$curDragoverDom=o(),this.dragY=this.dragStartY=e.originalEvent.clientY)},handleDrag:function(e,t){var n;if(n=e.originalEvent.clientY,"dragover"===e.type){if(e.preventDefault(),this.aroundType=this.aroundOriginalImage(t),"original"===this.aroundType)return o(".dragged-over").removeClass("dragged-over"),this.dragY=this.dragStartY,void(this.$curDragoverDom=o());this.isMovingImage&&this.$curDragoverDom.attr("id")!==o(t).attr("id")&&(o(".dragged-over").removeClass("dragged-over"),this.$curDragoverDom=o(t),this.$curDragoverDom.addClass("dragged-over"),this.appendImgShadow(n))}else this.isMovingImage&&"drag"===e.type&&"original"!==this.aroundType&&this.appendImgShadow(n);return this.dragY=n},handleDrop:function(t,n){var i,a;return t.preventDefault(),o(D).remove(),this.$tempStyleDom=o(),this.changeResizeBarVisible(!1),a=function(t,n,i){return"original"!==t.aroundType&&t.aroundType!==t.dropDirection&&t.isMovingImage&&t.context.ace.callWithAce(function(n){var i,a,r;if(n.ace_doMoveImage(n,t.$curDragoverDom[0],t.originImgGuid,t.dropDirection),(r=o("#innerdocbody ."+t.originImgGuid)[0])&&(i=e.getLineDom(r))&&(a=o(i).index(),n.ace_doRemoveOldLine(a),n.ace_getLineListType(a)&&a>0&&n.ace_getLineListType(a-1)))return n.ace_renumberList(a)},"insertImageUrl",!0),t.$currentEditingImage=o()},i=function(t,n,i){var a,r,s,l,c,d,u;if(a=n.originalEvent.dataTransfer,u=t.initializeUploadImage(!0),"undefined"!=typeof FileReader&&a&&a.files.length>0){for(t.dragEnterCounter=0,t.$curDragoverDom=t.$curDragoverDom||o(),c=[],d=a.files,s=0,l=d.length;s<l;s++)r=d[s],c.push(new Promise(function(t,n){var i;return i=new FileReader,i.onloadend=function(n){var i,o,a,r;return r=n.target.result,i=r.slice(r.lastIndexOf(",")+1),r.match(/image\/\w+/)?(a=r.match(/image\/\w+/)[0],o=e.base64toBlob(i,a),t(o)):void t(null)},i.readAsDataURL(r)}));return Promise.all(c).then(function(t){return u.uploadFiles(t.filter(function(e){return!!e}).map(function(t){return{fields:{file:t},guid:e.genGuid("placeholder"),type:"blob"}}))})}},t.preventDefault(),this.isMovingImage?(a(this,t,n),o(".dragged-over").removeClass("dragged-over"),this.isMovingImage=!1):(this.removeDragAndDropShadow(),i(this,t,n)),self.dragEnterCounter=0},handleDragFileEnter:function(e,t){var n;if(e.preventDefault(),0==this.dragEnterCounter++&&(n=e.originalEvent.dataTransfer,null!==n.types&&(n.types.indexOf?-1!==n.types.indexOf("Files"):n.types.contains("application/x-moz-file"))))return this.context.ace.callWithAce(function(e){return e.ace_addShadowToCurrentCaretWhenDragging()},"addShadow",!0)},cleanDragAndDropShadow:function(e,t){var n;if(0==--this.dragEnterCounter&&(n=e.originalEvent.dataTransfer,null!==n.types&&(n.types.indexOf?-1!==n.types.indexOf("Files"):n.types.contains("application/x-moz-file"))))return this.removeDragAndDropShadow()},cleanDragOverStyle:function(){return o(".dragged-over").removeClass("dragged-over"),this.isMovingImage=!1},handlePaste:function(e,t){return this.handlePaste(t,e)}},p.prototype.appendImgShadow=function(e){return e<this.dragY?(this.dropDirection="top","top"===this.aroundType?this.$curDragoverDom.removeClass("dragged-bottom"):this.$curDragoverDom.addClass("dragged-top").removeClass("dragged-bottom")):e>this.dragY?(this.dropDirection="bottom","bottom"===this.aroundType?this.$curDragoverDom.removeClass("dragged-top"):this.$curDragoverDom.addClass("dragged-bottom").removeClass("dragged-top")):void 0},p.prototype.aroundOriginalImage=function(e){var t,n;return n="",t=o(e),t.find(".upload-image").hasClass(this.originImgGuid)&&(n=this.dropDirection="original"),t.next().find(".upload-image").hasClass(this.originImgGuid)&&(n="bottom"),t.prev().find(".upload-image").hasClass(this.originImgGuid)&&(n="top"),n},p.prototype.initializeUploadImage=function(e){var t;return t=this,new r({url:"https://up.qbox.me",fileQueue:y,onSubmit:function(n,i){return t.prepareUploadImage(t.context,i,e)},onValidationError:function(e,n){return t.handleValidationError(e,n)},onUploadBegin:function(e,t,n){if(e.length>0)return o.ajax({url:"/smapi/action/create_upload_forms",type:"POST",data:JSON.stringify(t),contentType:"application/json",success:function(t){var i,o,a,r,s,l,d;for(d=t.data,r=s=0,l=d.length;s<l;r=++s){a=d[r];for(i in a)c.call(a,i)&&(o=a[i],e[r].fields[i]=o)}return n()}})},onUploadComplete:function(e,n){return e.code?(g("上传失败","error"),void t.clearRemainingPlaceholder(n)):(g(k.uploadSuccess),t.handleUploadProgress(n,"100","上传成功"),t.handleReturnImage(t.context,n,e.data,!1),t.listenToCheckBrokenImage())},onWechatUploadComplete:function(e){return t.handleReturnImage(t.context,"",e,!0),t.listenToCheckBrokenImage()},onUploadError:function(e,n){return g("上传失败","error"),t.clearRemainingPlaceholder(n)},onUploadProgress:function(e,n){return t.handleUploadProgress(n,e)}})},p.prototype.handleUploadProgress=function(e,t,o){var a;return null==o&&(o="上传中"),t>98&&(t=98),a=t+"%",this.$progressTag.append(i.template(n)({classTag:"image",list:{guid:e,percentVal:a,content:o}})),this.clearProgressOldStyle()},p.prototype.clearProgressOldStyle=function(){var e,t,n,i,a,r,s,l,c;s=document.getElementById("progress-style"),l={},c="";try{for(a=s.sheet.rules?s.sheet.rules:s.sheet.cssRules,e=t=0,n=a.length;t<n;e=++t)i=a[e],l[i.selectorText]=i;for(r in l)i=l[r],c+=" "+i.cssText;return o(s).html(c)}catch(e){e}},p.prototype.addSpecialCss=function(){var e;return e=this.context.pad.getUserId(),o("<style type='text/css'> .author-"+e+".image-placeholder { display: block!important; } </style>").appendTo("head")},p.prototype.prepareUploadImage=function(e,t,n){return e.ace.callWithAce(function(e){return e.ace_doInsertImagePlaceholder(e,t,n)},"insertPlaceholder",!0)},p.prototype.handleReturnImage=function(e,t,n,i){var o;return o=encodeURIComponent(n.images),b(o).always(function(n){return e.ace.callWithAce(function(e){return e.ace_doReplacePlaceholderWithImage(e,t,o,n,i)},"uploadImage",!0)})},p.prototype.validateImageBlob=function(e){if(!i.includes(this.allowedExtensions,e.type.slice(6))||Infinity!==this.maxFileSize&&e.size>this.maxFileSize)return k.uploadFailed},p.prototype.handleValidationError=function(e){var t;switch(e){case"typeInvalid":return g(k.uploadFailed);case"sizeInvalid":return t={headText:"到达上限",bodyText:"最大上传10M的图片/附件，升级<b>石墨高级版</b>无此限制",buttons:[{type:"link-button",buttonLabel:"了解详情",href:"/payment",target:"_blank",customClass:"btn btn-ok",closeAfterClick:!0},{type:"button",buttonLabel:"取消",customClass:"btn btn-cancel",closeAfterClick:!0}]},m.show(t);case"maxSizeInvalid":return t={headText:"到达上限",bodyText:"暂时不支持上传超过500M的文件，请压缩或分隔后上传。",buttons:[{type:"button",buttonLabel:"取消",customClass:"btn btn-cancel",closeAfterClick:!0}]},m.show(t)}},p.prototype.handlePaste=function(e,t){return t=t.originalEvent,t&&t.clipboardData&&t.clipboardData.getData&&t.clipboardData.items?this.handleChromePaste(e,t):this.handleOtherBrowserPaste(e)},p.prototype.handleChromePaste=function(t,n){var i,o;if((o=n.clipboardData.items[0])&&o.type.match(/^image\//))return i=o.getAsFile(),this.initializeUploadImage().uploadFiles([{fields:{file:i},guid:e.genGuid("placeholder"),type:"blob"}])},p.prototype.handleOtherBrowserPaste=function(t,n){var i,a,r;return null==n&&(n=3),a=this,i=o("#innerdocbody img").filter(function(){return!o(this).parents().hasClass("upload-image")}),i.length?e.isSafari()?e.alert({title:"Safari 浏览器不支持图片粘贴，请上传本地图片或者使用其他浏览器",type:"error"}):a.processPaste(i):(r={e:t},r.callself=function(){return a.handleOtherBrowserPaste(r.e,n-1)},n>0?setTimeout(r.callself,20):void 0)},p.prototype.processPaste=function(t){var n,a,r,s,l,c,d,u;for(u=i.map(t,function(e){return o(e).attr("src")}),c=[],s=0,l=u.length;s<l;s++)d=u[s],d.match(/base64/)?(n=d.slice(d.lastIndexOf(",")+1),r=d.match(/image\/\w+/)[0],a=e.base64toBlob(n,r),c.push(this.initializeUploadImage().uploadFiles([{fields:{file:a},guid:e.genGuid("placeholder"),type:"blob"}]))):c.push(void 0);return c},p.prototype.removeDragAndDropShadow=function(){return o(".drag-and-drop-placeholder").removeClass("drag-and-drop-placeholder")},p.prototype.insertTempImageStyleForResize=function(e,t){var n,a,r;return o(D).remove(),r=t&&void 0!==t.width?"width:"+t.width+"px!important;":"",n=t&&void 0!==t.height?"height:"+t.height+"px!important;":"",a=i.template(s)({selector:e,width:r,height:n}),o("body").append(a),this.$tempStyleDom=o(a)},p.prototype.repositionResizeBar=function(){var e,t,n,i,a,r,s;return e=o(".image-resize-bar"),0===this.$currentEditingImage.length?this.changeResizeBarVisible(!1):(r=this.$currentEditingImage.offset(),i=o("#editorcontainer").offset(),s=this.$currentEditingImage.width(),a=this.$currentEditingImage.height(),n=e.width()+4,t=e.height()+4,e.css("left",r.left-i.left+s-n/2+"px").css("top",r.top-i.top+a-t/2+"px"))},p.prototype.dynamicChangeImageSizeWhenMove=function(e){if(e)return this.insertTempImageStyleForResize(this.currentEditingImageSelector,e)},p.prototype.changeResizeBarVisible=function(e){return e?o(".image-resize-bar").addClass("active"):o(".image-resize-bar").removeClass("active")},p.prototype.setDocEditable=function(e){var t;return null==e&&(e=!0),t=this,this.context.ace.callWithAce(function(t){return t.ace_setEditable(e)}),setTimeout(function(){if(!e&&(a.mozilla||a.id))return t.$padView.blur()},0)},p.prototype.moveCaretToImageLine=function(){var e,t;return e=o(this.currentEditingImageSelector),t=w(e[0]),this.context.ace.callWithAce(function(e){return e.ace_moveCaretToImageLine(e,t)},"moveCaretToImageLine",!0)},p.prototype.selectImage=function(e,t){var n,i;if(null==t&&(t=!1),!this.checkSelectImage(e)||t)return n=this.getImageGuidFromImage(e,!0),i="#innerdocbody ."+n+" img",this.currentEditingImageSelector=i,this.$currentEditingImage=o(e),this.insertTempImageStyleForResize(i),this.changeResizeBarVisible(!0),this.repositionResizeBar(),this.setDocEditable(!1)},p.prototype.clearSelected=function(){return this.setDocEditable(!0),this.changeResizeBarVisible(!1),this.$currentEditingImage=o(),this.currentEditingImageSelector="",o(D).remove()},p.prototype.listenCaretChange=function(e){var t,n,i,a;if(a=e.selStart,i=e.selEnd,!a||!a)return void this.repositionResizeBar();if(n=a[0],t=this.getImageInLine(n),a&&i&&a[0]===i[0]&&a[1]===i[1]&&t){if("true"===this.$padView.attr("contenteditable")&&this.setDocEditable(!1),this.firstIntoDoc)return;if(void 0!==t&&null!==t){if(t!==o(this.currentEditingImageSelector)[0]&&!this.clickOther)return this.selectImage(t);if(this.needHideCaret)return this.needHideCaret=!1,this.selectImage(t,!0)}}else if(o(this.currentEditingImageSelector).length>0)return this.clearSelected()},p.prototype.getImageInLine=function(e){var t;return void 0===(t=o("#innerdocbody>div")[e])||null===t?null:o(t).find("img")[0]},p.prototype.checkSelectImage=function(e){return this.$currentEditingImage.length>0&&this.$currentEditingImage[0]===e},p.prototype.getImageGuidFromImage=function(e,t){var n,i,a;return null==t&&(t=!0),n=o(e).parents("span[class*=img-]"),i=n.attr("class"),i?t?(a=i.match(/img-[0-9A-Za-z]{16}/),a=a&&a[0]?a[0]:""):(a=i.match(/img-([0-9A-Za-z]{16})/),a=a&&a[1]?a[1]:""):""},p.prototype.isInDocbody=function(e){return o(e).closest("#innerdocbody").length>0},p.prototype.listenToCheckBrokenImage=function(){var e;return e=this,o("#innerdocbody img").off("error").on("error",function(t){var n,a,r;if(n=o(t.target),a=n.closest(".upload-image").attr("class"),r=a.match(/img-([0-9A-Za-z]{16})/),r=r&&r[1]?r[1]:"",!i.includes(e.brokenImagesGuids,r))return e.brokenImagesGuids.push(r)})},p.prototype.stopPropagation=function(e){return e.stopPropagation(),e.preventDefault(),!1},p}(e.DomModule),M=null,v.postAceInit=function(e,t){return M||(M=new p("html")),M.reset({context:t})},v.aceAttribsToClasses=function(t,n){var i;return"upload-image"===n.key&&null!=n.value?(i=n.value.split(","),["upload-image:"+i[0]+" img-"+(i[1]||e.genGuid())+" "+(i[2]||"")+" "+(i[3]||"")]):"image-placeholder"===n.key?(i=n.value.split(","),"error"===i[1]?["image-placeholder "+i[0]+" upload-error"]:["image-placeholder "+i[0]]):[]},v.aceCreateDomLine=function(e,t){var n,i,a,r,s,l,c,d;return n=function(e){var t;return t=e.lastIndexOf("."),e.slice(t+1).toLowerCase()},r=function(e){var t;if(e)return 0===e.indexOf("static")&&(e="/"+e),0===e.indexOf("/static")&&e.indexOf("_large")<0&&"gif"!==n(e)&&(t=e.lastIndexOf("."),e=[e.slice(0,t),"_large",e.slice(t)].join("")),e},t.cls.indexOf("upload-image")>-1?(o(".image-resize-bar").is(":visible")&&o("#innerdocbody").trigger("imageredraw"),l=null,t.cls=t.cls.replace(/(^| )upload\-image:(\S+)/gi,function(e,t,n){return l=encodeURI(decodeURIComponent(n)),t+"upload-image"}),l=r(l),d=t.cls.match(/image-width-\d+/),c="",d&&d.length>0&&(d=d[0].replace("image-width-",""),c+="width:"+d+"px;"),i=t.cls.match(/image-height-\d+/),i&&i.length>0&&(i=i[0].replace("image-height-",""),c+="height:"+i+"px;"),+d>x&&(+i&&+i>0?(s=parseInt(+i*x/+d),c="width:"+x+"px;height:"+s+"px;"):c="width:"+x+"px;"),[{cls:t.cls,extraOpenTags:'<img alt="" style="'+c+'"src="'+l+'" /><div class="not-render">',extraCloseTags:"</div>"}]):t.cls.indexOf("image-placeholder")>-1?(a='<div class="upload-loading-block" contenteditable="false"><span class="upload-progress-groove"><span class="upload-progress-bar"></span></span> <span class="upload-loading-info"></span><span class="upload-remove-media hicon icon-remove-media"></span></div>',[{cls:t.cls,extraOpenTags:a+'<div class="image-error-msg" contenteditable="false">',extraCloseTags:"</div>"}]):void 0},P=function(e,t){var n,i,a,r,s;return n=o("#doc-view"),i=n.scrollTop(),r=97,s=o(window).height()-r,t=t||e.height(),a=e.offset().top-r+i,t<s&&(a-=s/2-t/2),n.scrollTop(a)},O=function(e){var t,n;return t=e.find("img"),n=o("#innerdocbody").width(),t[0].onload=function(){var t;return t=this.width>n?n/this.width*this.height:this.height,P(e,t)}},I=function(t,n,a,r,s){var l,c,d,u,m,h,p,f,g,v,y,b,w;if(s=!!s,m=" \n",s){if(!(b=this.rep)||!b.selStart)return;g=b.selStart,f=b.selEnd,w=b.selStart[0],b.selEnd[0],h=w,t.ace_isCaret()&&o(o("#innerdocbody>div")[w]).find(".upload-image, .upload-attachment").length>0&&(v=!0,g=f=[w+1,0],h+=1),b.selStart[1]>0&&!v&&(m="\n"+m,h+=1)}else{if(l=o(".image-placeholder."+n),l[0]||(l=o(".attachment-placeholder."+n)),!(b=t.ace_domToRep(l[0]))||!b.selEnd)return;h=b.selStart[0],l.prev().is("span")&&(m="\n"+m,h+=1),g=b.selStart,f=[b.selEnd[0],b.selEnd[1]-1]}if(p=[],r&&i.each(["width","height"],function(e){var t;if(!isNaN(t=parseInt(r[e])))return p.push("image-"+e+"-"+t)}),y=e.genGuid(),t.ace_performDocumentReplaceRangeWithAttributes(g,f,m,[["author",this.documentAttributeManager.author],["upload-image",[a,y].concat(p)],["lineguid",e.genGuid()]]),(u=t.ace_getLineListType(b.selStart[0]-1))&&(d=/[a-z]+([123456789])/.exec(u),t.ace_performDocumentReplaceRangeWithAttributes([g[0]+1,0],[g[0]+1,0],"*",[["author",this.documentAttributeManager.author],["list","indent"+(d?d[1]:"1")],["lineguid",e.genGuid()]])),t.ace_setAttributesOnline(h,[["line-align","center"],["inherit:inherit",!0]]),h+2<this.rep.lines.length()&&t.ace_getLineListType(h+2)&&t.ace_renumberList(h+2),c=o(".upload-image."+y),c.length)return O(c)},C=function(t,n){var i,o,a,r;if(this.rep.selStart)return L(this.rep),i=" ",a=this.rep.selStart[1],r=this.rep.selStart[0],o=r,a>0&&(i="\n"+i,o+=1),i+="\n",t.ace_performDocumentReplaceRangeWithAttributes(void 0,void 0,i,[["author",this.documentAttributeManager.author],["upload-image",[n,e.genGuid()]],["lineguid",e.genGuid()]]),t.ace_setAttributesOnline(o,[["line-align","center"],["inherit:inherit",!0]])},b=function(e){var t,n;return t=o.Deferred(),e||t.reject(),n=document.createElement("img"),n.onload=function(){var e;return e={width:this.width,height:this.height},t.resolve(e)},n.onerror=function(){return t.reject()},n.src=decodeURIComponent(e),t.promise()},E=function(e,t,n){var i,a,r,s,l,c,d;if(s=this.rep,l=void 0,r=void 0,s.selStart&&s.selEnd||(s.selStart=[0,0],s.selEnd=[0,0]),L(s),a=" ",n?(d=s.selEnd[0],c=s.lines.atIndex(d).text.length,l=[d,c],r=[d,c],c>0&&(a="\n ")):(c=s.selStart&&s.selStart[1],d=s.selStart&&s.selStart[0],s.selStart[0]===s.selEnd[0]&&s.selStart[1]===s.selEnd[1]&&o(o("#innerdocbody>div")[s.selStart[0]]).find(".upload-image, .upload-attachment").length>0&&(l=r=[d,c+1]),c>0&&(a="\n"+a)),e.ace_performDocumentReplaceRangeWithAttributes(l,r,a,[["author",this.documentAttributeManager.author],["image-placeholder",[t,"normal"]]]),i=o(".image-placeholder."+t),i.length)return P(i)},w=function(e){if(e){for(;e.parentNode&&"innerdocbody"!==e.parentNode.id;)e=e.parentNode;return"DIV"===e.tagName.toUpperCase()?o(e).index():void 0}},T=function(t,n,i,a){var r,s,l,c,d,u,m,h,p,f,g,v,y,b;if(c=o("#innerdocbody ."+i).attr("class"),b=c.match(/image-width-\d+/),u=c.match(/image-height-\d+/),(y=t.ace_domToRep(n))&&y.selEnd)return p=o("."+i+" img").attr("src"),p=encodeURIComponent(decodeURI(p)),p&&(l=[],l.push(p),l.push(e.genGuid()),b&&b[0]&&l.push(b[0]),u&&u[0]&&l.push(u[0]),v=w(o("."+i)[0]),null!=v&&(f=this.documentAttributeManager.getAttributeOnLine(v,"line-align")),c&&(g=c.match(/comment-[0-9A-Za-z]{16}/)),s=[["author",this.documentAttributeManager.author],["upload-image",l]],g&&g[0]&&s.push(["comment",g]),m=h="top"===a?[y.selEnd[0],0]:[y.selEnd[0]+1,0],d=m[0],r=this.rep.lines.length(),d>r-1?(m[0]=h[0]=r-1,t.ace_performDocumentReplaceRangeWithAttributes(m,h,"\n \n",s)):t.ace_performDocumentReplaceRangeWithAttributes(m,h," \n",s),f&&t.ace_setAttributesOnline(d,[["line-align",f],["inherit:inherit",!0]]),d+1<r&&t.ace_getLineListType(d+1)&&d>1&&t.ace_getLineListType(d-1))?t.ace_renumberList(d+1):void 0},function(e){return o(".image-placeholder."+e).text("")},S=function(e){var t;return t=this.rep.selStart[0],e.ace_performDocumentReplaceRangeWithAttributes([t,0],[t,1],"",[])},L=function(e){if(e.selStart)return setTimeout(function(){var t,n;return t=o("div[id^=magicdom]").eq(e.selStart[0]),n=t.offset().top-o("#innerdocbody").offset().top,o("#editorcontainer").scrollTop(n)},1e3)},f=function(){var e,t;if(this.rep.selEnd)return t=this.rep.selEnd[0],e=o(o("#innerdocbody div:nth-child("+(t+1)+")")),e.length?(e.addClass("drag-and-drop-placeholder"),P(e)):void 0},N=function(e,t,n){var i,o,a,r,s,l,c,d,u,m;o=[],i=t.find("img"),d=e.ace_domToRep(i[0]),c=encodeURIComponent(decodeURI(i[0].src)),o.push(c),a=i.closest("span[class*=img-]").attr("class"),r=a.match(/img-([0-9A-Za-z]{16})/),r&&r[1]&&(r=r[1]),m=a.match(/image-width-(\d+)/),m&&m.length>1&&(m=m[1]),s=a.match(/image-height-(\d+)/),s&&s.length>1&&(s=s[1]),r&&o.push(r),void 0!==n&&null!==n||(n={},m=parseInt(m),s=parseInt(s),isNaN(m)||(n.width=m),isNaN(s)||(n.height=s));for(l in n)u="image-"+l+"-"+n[l],o.push(u);this.documentAttributeManager.setAttributesOnRange(d.selStart,[d.selEnd[0],d.selEnd[1]+1],[["upload-image",o.join()]])},_=function(e,t){var n,i;return i=this.rep,e.ace_isCaret()||(window.getSelection().removeAllRanges(),o("#text-count").addClass("hide")),n=i.lines.atIndex(t),i.selStart=[t,n.lineMarker],i.selEnd=[t,n.lineMarker]},g=function(n,i){return e.isMobile()?t(n):e.alert({title:n,type:i})},v.aceInitialized=function(e,t){t.editorInfo.ace_doReplacePlaceholderWithImage=i.bind(I,t),t.editorInfo.ace_doInsertImageLink=i.bind(C,t),t.editorInfo.ace_doRemoveImage=i.bind(S,t),t.editorInfo.ace_doInsertImagePlaceholder=i.bind(E,t),t.editorInfo.ace_doMoveImage=i.bind(T,t),t.editorInfo.ace_handleReturnImage=function(e,t){return M.handleReturnImage(M.context,e,{images:t},!1)},t.editorInfo.ace_handleUploadProgress=function(e,t,n){return M.handleUploadProgress(e,t,n)},t.editorInfo.ace_clearRemainingPlaceholder=function(e){return M.clearRemainingPlaceholder(e)},t.editorInfo.ace_addShadowToCurrentCaretWhenDragging=i.bind(f,t),t.editorInfo.ace_resizeImage=i.bind(N,t),t.editorInfo.ace_moveCaretToImageLine=i.bind(_,t)},v.getInstance=function(){return M},v}.apply(t,r))&&(e.exports=s)}).call(t,n(1),n(2),n(262))},863:function(e,t){e.exports="<style type='text/css' rel='stylesheet' id='tempImageResizeStyle'>\n<%=selector %> {\n  box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.4);\n  -webkit-box-shadow: 0 2px 6px 1px rgba(0, 0, 0, 0.4);\n  -moz-box-shadow: 0px 2px 6px 1px rgba(0, 0, 0, 0.4);\n  -ms-box-shadow: 0px 2px 6px 1px rgba(0, 0, 0, 0.4);\n  -o-box-shadow: 0px 2px 6px 1px rgba(0, 0, 0, 0.4);\n  resize: none !important;\n  margin-bottom: 2px;\n  margin-top: -2px;\n  <%= width %>\n  <%= height %>\n}\n<%=selector %>:hover {\n  cursor: zoom-in !important;\n}\n</style>\n"},886:function(e,t,n){(function(n){Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){403===e.code&&(window.location.href="/login")},o=function(e,t){var o=n.Deferred(),a=window.cow.currentListByGuid;if(e===window.cow.tempCurrentFile.guid&&void 0===window.cow.tempCurrentFile.authorized)window.cow.tempCurrentFile.authorized=window.cow.authorized,o.resolve(window.cow.tempCurrentFile);else if(a&&a[e]&&!t)o.resolve(a[e]);else{var r="/-/"+e;n.get(r).done(function(e){if(0===e.code){var t=e.data,n=t.file;n.authorized=t.authorized,o.resolve(n)}else o.reject(e)}).fail(function(e){i(e),o.reject(e)})}return o.promise()};t.default={getDocByGuid:o},e.exports=t.default}).call(t,n(2))},922:function(e,t,n){function i(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),l=n(0),c=i(l),d=function(e){function t(){return o(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),s(t,[{key:"render",value:function(){var e={};return this.props.size&&(e.fontSize=this.props.size+"px"),c.default.createElement("div",{className:"spinner-wrap",style:e},c.default.createElement("div",{className:"spinner-blade"}),c.default.createElement("div",{className:"spinner-blade"}),c.default.createElement("div",{className:"spinner-blade"}),c.default.createElement("div",{className:"spinner-blade"}),c.default.createElement("div",{className:"spinner-blade"}),c.default.createElement("div",{className:"spinner-blade"}),c.default.createElement("div",{className:"spinner-blade"}),c.default.createElement("div",{className:"spinner-blade"}),c.default.createElement("div",{className:"spinner-blade"}),c.default.createElement("div",{className:"spinner-blade"}),c.default.createElement("div",{className:"spinner-blade"}),c.default.createElement("div",{className:"spinner-blade"}))}}],[{key:"propTypes",get:function(){return{size:l.PropTypes.number}}}]),t}(l.Component);t.default=d,e.exports=t.default},923:function(e,t,n){function i(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),l=n(0),c=i(l),d=n(922),u=i(d),m=function(e){function t(){return o(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),s(t,[{key:"render",value:function(){if(this.props.show){var e={backgroundColor:this.props.overlayColor||"transparent",position:"absolute",top:"0",right:"0",bottom:"0",left:"0"};return c.default.createElement("div",{style:e},c.default.createElement(u.default,{size:this.props.size}))}return null}}],[{key:"propTypes",get:function(){return{overlayColor:l.PropTypes.string,show:l.PropTypes.bool,size:l.PropTypes.number}}}]),t}(l.Component);t.default=m,e.exports=t.default}});